sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","application/model/formatter","sap/ui/core/util/MockServer","sap/ui/export/library","sap/ui/export/Spreadsheet","sap/ui/model/odata/v2/ODataModel","sap/m/MessageBox"],function(e,t,o,r,a,l,i,s){"use strict";var n=[];var d=[];var p=[];var u=[];var c=[];var m=[];var g=[];var b=l.EdmType;return e.extend("application.controller.detalhesRelatorioTabelas",{onInit:function(){this.getRouter().getRoute("detalhesRelatorioTabelas").attachPatternMatched(this._onLoadFields,this)},_handleValueHelpSearch:function(e){var t=e.getSource().getValue();var o=[];var r=[new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,t)];var a=new sap.ui.model.Filter(r,false);o.push(a);this.byId("idtablePrecos").getBinding("items").filter(o);this.byId("idtablePrecos").suggest()},onItemChange:function(e){m=[];var t=e.getSource().getValue();var o=new sap.ui.model.json.JSONModel(m);this.getOwnerComponent().setModel(o,"detalhesRelatorioTabelas");for(var r=0;r<u.length;r++){if(t==u[r].ProdutoId){m.push(u[r])}}if(t==""){o=new sap.ui.model.json.JSONModel(g);this.getOwnerComponent().setModel(o,"detalhesRelatorioTabelas")}else{o=new sap.ui.model.json.JSONModel(m);this.getOwnerComponent().setModel(o,"detalhesRelatorioTabelas")}},createColumnConfig:function(){var e=[];e.push({label:"Material",property:"Matnr",type:b.String});e.push({label:"Descrição",property:"Maktx",type:b.String});e.push({label:"Categoria",property:"Mvgr1Text",type:b.String});e.push({label:"SubCategoria",property:"Mvgr2Text",type:b.String});e.push({label:"Família",property:"Mvgr3Text",type:b.String});e.push({label:"Pallet",property:"QntPallet",type:b.Integer});e.push({label:"CXs",property:"QntCaixa",type:b.String});e.push({label:"Preço Bruto",property:"ValPrecoOrig",type:b.Number,scale:2,delimiter:true});e.push({label:"%Canal",property:"PercCanal",type:b.Number,scale:2,delimiter:true});e.push({label:"%Promocional",property:"PercPromoMax",type:b.Number,scale:2,delimiter:true});e.push({label:"Preço Líquido",property:"ValPrecoInform",type:b.Number,scale:2,delimiter:true});e.push({label:"Preço c/ST",property:"ValPrecoUnitSt",type:b.Number,scale:2,delimiter:true});e.push({label:"%ST",property:"PerSubTri",type:b.Number,scale:2,delimiter:true});e.push({label:"%Contrato",property:"PctDescContrato",type:b.Number,scale:2,delimiter:true});return e},onExport:function(){var e,t,o,r,a;if(!this._oTable){this._oTable=this.byId("idtablePrecos")}a=this._oTable;t=a.getBinding("items");e=this.createColumnConfig();var l=this.getModel("modelParametros").getData();var s="Lista_"+l.Centro+"_"+l.Cliente+"_Orig_"+l.UFOrigem+"_Dest_"+l.UFDestino+"_"+l.Frete;var n=this.onDataHora();var d=n[0].substring(0,2)+"/"+n[0].substring(3,5)+"/"+n[0].substring(6,11);var p=n[1].substring(0,2)+":"+n[1].substring(3,5)+":"+n[1].substring(6,8);o={workbook:{columns:e,hierarchyLevel:"Level",context:{application:"Portal Predilecta",version:"1.00.00",title:"Relatório de Tabela de Preço",sheetName:"Lista de Preço",modifiedBy:"Administrador",metaSheetName:"Parâmetros",metainfo:[{name:"Parâmetros de Seleção",items:[{key:"Centro",value:l.DescCentro},{key:"UF Origem",value:l.UFOrigem},{key:"Cliente",value:l.NomeCliente},{key:"UF Destino",value:l.UFDestino},{key:"Canal Atuação",value:l.CanalAtuacao},{key:"Tabela de Preço",value:l.DescTabelaPreco},{key:"Vencimento",value:l.DescVencto},{key:"Índice",value:l.Indice+"%"},{key:"Tipo Transporte",value:l.DescTipoFrete},{key:"Exibicao",value:l.Exibicao},{key:"RCA",value:l.CodRepres},{key:"Data Emissão Tabela",value:d+" - "+p}]}]}},dataSource:t,fileName:s,worker:false};r=new i(o);r.build().finally(function(){r.destroy()})},_onLoadFields:function(){var e=this;var o=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.oModel=e.getModelGlobal("modelAux").getProperty("/DBModel");var r={CodRepres:e.getModelGlobal("modelTela").getProperty("/CodRepres"),Centro:e.getModelGlobal("modelTela").getProperty("/Werks"),DescCentro:e.getModelGlobal("modelTela").getProperty("/DescCentro"),UFOrigem:e.getModelGlobal("modelTela").getProperty("/UFOrigem"),Cliente:e.getModelGlobal("modelTela").getProperty("/Kunnr"),NomeCliente:e.getModelGlobal("modelTela").getProperty("/NomeCliente"),UFDestino:e.getModelGlobal("modelTela").getProperty("/UFDestino"),CanalAtuacao:e.getModelGlobal("modelTela").getProperty("/DescKvgr2"),TabPreco:e.getModelGlobal("modelTela").getProperty("/Pltyp"),DescTabelaPreco:e.getModelGlobal("modelTela").getProperty("/DescTabelaPreco"),Vencimento:e.getModelGlobal("modelTela").getProperty("/Vencimento"),DescVencto:e.getModelGlobal("modelTela").getProperty("/DescVencto"),Indice:e.getModelGlobal("modelTela").getProperty("/Indice"),Frete:e.getModelGlobal("modelTela").getProperty("/Inco1"),DescTipoFrete:e.getModelGlobal("modelTela").getProperty("/DescTipoFrete"),Exibicao:e.getModelGlobal("modelTela").getProperty("/Exibicao")};var a=new t(r);e.setModel(a,"modelParametros");var l=e.getModel("modelParametros").getData();e.byId("master").setBusy(true);e.oModel.read("/P_RelTabPreco",{urlParameters:{$filter:"Usuario eq '"+o+"' and Centro eq '"+l.Centro+"' and Cliente eq '"+l.Cliente+"' and TabPreco eq '"+l.TabPreco+"' and Indice eq "+l.Indice+" and Frete eq '"+l.Frete+"' and Exibicao eq '"+l.Exibicao+"'"},success:function(o){e.vetorTabPreco=o.results;e.byId("master").setBusy(false);var r=new t(e.vetorTabPreco);e.setModel(r,"modelTabPreco")},error:function(t){e.byId("master").setBusy(false);e.onMensagemErroODATA(t)}})}})});