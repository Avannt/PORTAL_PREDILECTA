sap.ui.define(["application/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel"],function(e,o,t,n,r,a){"use strict";return e.extend("application.controller.enviarPedidos",{onInit:function(){this.getRouter().getRoute("enviarPedidos").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;e.oModel=e.getModel();var o=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.byId("table_pedidos").setBusy(true);new Promise(function(t,n){e.onBuscarCentros(o,t,n,e)}).then(function(t){var n=new r(t);e.setModel(n,"Centros");new Promise(function(t,n){e.onBuscarClientes(o,t,n,e)}).then(function(t){var n=new r(t);e.setModel(n,"Clientes");e.byId("table_pedidos").setBusy(false);new Promise(function(t,n){var r="";var a=true;e.onBuscarPedidos(r,o,a,t,n,e)}).then(function(o){e.vetorPedidos=o;var t=new r(e.vetorPedidos);var n=0;for(var a=0;a<e.vetorPedidos.length;a++){n+=parseFloat(e.vetorPedidos[a].ValorTotal)}e.getModelGlobal("modelAux").setProperty("/ValTotPedPend",n);e.setModel(t,"Pedidos");e.byId("table_pedidos").setBusy(false)}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})},myFormatterCodEmpresa:function(e){var o=this.getModel("Centros").getData();for(var t=0;t<o.length;t++){if(e==o[t].Bukrs){return e+"-"+o[t].NomeCentro}}},myFormatterCliente:function(e){var o=this.getModel("Clientes").getData();for(var t=0;t<o.length;t++){if(e==o[t].Kunnr){return e+"-"+o[t].Name1}}},onItemPressEF:function(e){var o=this;var t=e;var r=t.getParameter("listItem")||e.getSource();var a=r.getBindingContext("EntregasEnviar").getProperty("Kunrg");n.show("Deseja abrir o item selecionado?",{icon:n.Icon.WARNING,title:"Editar",actions:["Sim","Cancelar"],onClose:function(e){if(e=="Sim"){o.getOwnerComponent().getModel("modelAux").setProperty("/KunrgEntrega",a);sap.ui.core.UIComponent.getRouterFor(o).navTo("entregaFutura")}}})},onItemChange:function(e){var o=e.getSource().getValue();var t=[];var n=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("NameOrg1",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Nrpedcli",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("AprovadoDesc",sap.ui.model.FilterOperator.Contains,o)];var r=new sap.ui.model.Filter(n,false);t.push(r);this.byId("table_relatorio_pedidos").getBinding("items").filter(t,sap.ui.model.FilterType.Application)},myFormatterDataImp:function(e){if(e!==undefined&&e!==null&&e!==""&&e!==0){var o=e.split("-");var t=o[0].split("/");var n=o[1].split(":");e=t[0]+"/"+t[1]+"-"+n[0]+":"+n[1];return e}},onItemPress:function(e){var o=this;var t=e.getParameter("listItem")||e.getSource();var r=t.getBindingContext("PedidosEnviar").getProperty("nrPedCli");var a=t.getBindingContext("PedidosEnviar").getProperty("kunnr");o.getOwnerComponent().getModel("modelAux").setProperty("/Kunnr",a);o.getOwnerComponent().getModel("modelAux").setProperty("/NrPedCli",r);n.show("Deseja mesmo detalhar o Pedido? O pedido será reaberto.",{icon:n.Icon.WARNING,title:"Detalhamento Solicitado",actions:[n.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){var t=indexedDB.open("VB_DataBase");t.onerror=function(){console.log("não foi possivel encontrar e/ou carregar a base de clientes")};t.onsuccess=function(e){var t=e.target.result;var n=new Promise(function(e,n){o.carregaModelCliente(t,e,n)});n.then(function(){new Promise(function(e,o){var n=t.transaction("PrePedidos","readwrite");var a=n.objectStore("PrePedidos");var i=a.get(r);i.onsuccess=function(s){var d=s.target.result;var l=d;l.idStatusPedido=1;l.situacaoPedido="EM DIGITAÇÃO";n=t.transaction("PrePedidos","readwrite");a=n.objectStore("PrePedidos");i=a.put(l);i.onsuccess=function(){e();console.log("O pedido foi reaberto.")};i.onerror=function(){o("Erro ao reabrir pedido!");console.log("Erro ao abrir o Pedido > "+r)}}}).then(function(){sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")})})}}}})},carregaModelCliente:function(e,o,t){var n=this;var r=n.getOwnerComponent().getModel("modelAux").getProperty("/Kunnr");var a=e.transaction("Clientes","readwrite");var i=a.objectStore("Clientes");var s=i.get(r);s.onsuccess=function(e){var r=e.target.result;if(r!==null&&r!==undefined){n.getOwnerComponent().getModel("modelCliente").setProperty("/Kunnr",r.kunnr);n.getOwnerComponent().getModel("modelCliente").setProperty("/Land1",r.land1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Name1",r.name1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Name2",r.name2);n.getOwnerComponent().getModel("modelCliente").setProperty("/Ort01",r.ort01);n.getOwnerComponent().getModel("modelCliente").setProperty("/Ort02",r.ort02);n.getOwnerComponent().getModel("modelCliente").setProperty("/Regio",r.regio);n.getOwnerComponent().getModel("modelCliente").setProperty("/Stras",r.stras);n.getOwnerComponent().getModel("modelCliente").setProperty("/Pstlz",r.pstlz);n.getOwnerComponent().getModel("modelCliente").setProperty("/Stcd1",r.stcd1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Stcd2",r.stcd2);n.getOwnerComponent().getModel("modelCliente").setProperty("/Inco1",r.inco1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Parvw",r.parvw);n.getOwnerComponent().getModel("modelCliente").setProperty("/Lifnr",r.lifnr);o()}else{console.log("ERRO!! Falha ao ler Clientes.");t()}}},onSelectionChange:function(e){var o=this;var t=[];var n=this.byId("table_pedidos").getSelectedItems();for(var a=0;a<n.length;a++){var i=n[a].getBindingContext("Pedidos").getObject();delete i.__metadata;delete i.IvEnvio;delete i.IvUsuario;delete i.IvKunnr;t.push(i)}var s=new r(t);o.setModel(s,"PedidosEnviar")},onEnviarPedido:function(e){var o=this;var t=o.getModel("PedidosEnviar").getData();var r=[];for(var i=0;i<t.length;i++){if(t[i].Usuario!=o.getModelGlobal("modelAux").getProperty("/CodRepres")){r.push({NrPedido:t[i].NrPedido,Usuario:t[i].Usuario})}}if(r.length>0){for(var i=0;i<r.length;i++){n.show("Não é possível realizar o envio do Pedido: "+r[i].NrPedido+".\n Usuario criação: "+r[i].Usuario+". Usuário de Envio: "+o.getModelGlobal("modelAux").getProperty("/CodRepres")+".",{icon:n.Icon.ERROR,title:"Ação não permitida!",actions:[n.Action.OK],onClose:function(e){return}})}}else if(t.length==0){n.show("Selecione pelo menos um pedido para enviar!",{icon:n.Icon.ERROR,title:"Pedido não encontrado!!",actions:[n.Action.OK]})}else{n.show("Deseja enviar os itens selecionados?",{icon:n.Icon.WARNING,title:"Envio de itens",actions:["Enviar","Cancelar"],onClose:function(e){if(e=="Enviar"){var n=o.getModelGlobal("modelAux").getProperty("/Url");var r=new a({serviceUrl:n});r.setUseBatch(true);r.refreshSecurityToken();o.byId("table_pedidos").setBusy(true);for(var i=0;i<t.length;i++){var s=t[i];s.IdStatusPedido=3;s.SituacaoPedido="FIN";o.onFormatNumberPedido(s);r.create("/P_PedidoPR",s,{method:"POST",success:function(e){console.info("Pedido "+e.NrPedido+" Inserido.")},error:function(e){o.onMensagemErroODATA(e)}})}r.submitChanges();r.attachBatchRequestCompleted(function(e){o._onLoadFields()})}}})}},onDataAtualizacao:function(){var e=new Date;var o=String(e.getDate());var t=String(e.getMonth()+1);var n=String(e.getFullYear());var r=String(e.getMinutes());var a=String(e.getHours());var i=String(e.getSeconds());if(o.length==1){o=String("0"+o)}if(t.length==1){t=String("0"+t)}if(r.length==1){r=String("0"+r)}if(a.length==1){a=String("0"+a)}if(i.length==1){i=String("0"+i)}var s=String(o+"/"+t);var d=String(a)+":"+String(r);return[s,d]},onDeletarPedido:function(e){var o=this;var t=o.getModel("PedidosEnviar").getData();var r=[];for(var i=0;i<t.length;i++){if(t[i].Usuario!=o.getModelGlobal("modelAux").getProperty("/CodRepres")){r.push({NrPedido:t[i].NrPedido,Usuario:t[i].Usuario})}}if(r.length>0){for(var i=0;i<r.length;i++){n.show("Não é possível realizar a exclusão do Pedido: "+r[i].NrPedido+".\n Usuario criação: "+r[i].Usuario+". Usuário de Exclusão: "+o.getModelGlobal("modelAux").getProperty("/CodRepres")+".",{icon:n.Icon.ERROR,title:"Ação não permitida!",actions:[n.Action.OK],onClose:function(e){return}})}}else if(t.length==0){n.show("Selecione pelo menos um pedido para deletar!",{icon:n.Icon.ERROR,title:"Pedido não encontrado!!",actions:[n.Action.OK]})}else{n.show("Deseja deletar os itens selecionados?",{icon:n.Icon.WARNING,title:"Deleção de itens",actions:["Deletar","Cancelar"],onClose:function(e){if(e=="Deletar"){var n=o.getModelGlobal("modelAux").getProperty("/Url");var r=new a({serviceUrl:n});r.setUseBatch(true);r.refreshSecurityToken();o.byId("table_pedidos").setBusy(true);for(var i=0;i<t.length;i++){var s=t[i];r.remove("/P_PedidoD(IvNrPedido='"+s.NrPedido+"')",{success:function(e){},error:function(e){o.onMensagemErroODATA(e)}})}r.submitChanges();r.attachBatchRequestCompleted(function(e){o._onLoadFields()})}}})}},onExcluirPedido:function(e){var o=this;var t=false;var a=e.getParameter("listItem")||e.getSource();var i=a.getBindingContext("Pedidos").getObject();if(i.IdStatusPedido==3){var s="Não é possível deletar pedidos que já foram integrados!";n.error(s,{icon:n.Icon.ERROR,title:"Deleção de pedido.",actions:[sap.m.MessageBox.Action.OK]})}else if(i.Usuario!=o.getModelGlobal("modelAux").getProperty("/CodRepres")){n.show("Não é possível realizar a edição. Usuario criação: "+i.Usuario+", Usuario edição: "+o.getModelGlobal("modelAux").getProperty("/CodRepres")+".",{icon:n.Icon.ERROR,title:"Ação não permitida!",actions:[n.Action.OK]})}else{n.show("Deseja mesmo excluir os pedidos selecionados?",{icon:n.Icon.WARNING,title:"Exclusão de Pedidos",actions:[n.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){o.byId("table_pedidos").setBusy(true);new Promise(function(e,t){o.onExcluirPed(i.NrPedido,e,t)}).then(function(){var e=o.getModelGlobal("Cliente_G").getData();var t=o.getModelGlobal("modelAux").getProperty("/CodRepres");var n=false;new Promise(function(r,a){o.onBuscarPedidos(e.Kunnr,t,n,r,a,o)}).then(function(e){o.vetorPedidos=e;var t=new r(o.vetorPedidos);o.getView().setModel(t,"Pedidos");o.byId("table_pedidos").setBusy(false)}).catch(function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)})}).catch(function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)})}}})}},onMensagemErroODATA:function(e){if(e==0){sap.m.MessageBox.show("Verifique a conexão com a internet!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Falha na Conexão!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==400){sap.m.MessageBox.show("Url mal formada! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Fiori!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==403){sap.m.MessageBox.show("Usuário sem autorização para executar a função (403)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==404){sap.m.MessageBox.show("Função não encontrada e/ou Parâmentros inválidos  (404)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==500){sap.m.MessageBox.show("Ocorreu um Erro (500)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==501){sap.m.MessageBox.show("Função não implementada (501)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}},onVerificarAprovadorUsuario:function(e,o){var t=this.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");var n=this.getOwnerComponent().getModel("modelAux").getProperty("/CodRepres");t.read("/FluxoAprovacao('"+n+"')",{success:function(t){var n=t.ERetorno=="S";if(n){e()}else{o("Usuário atual não possui aprovadores cadastrados, favor entrar em contato com a administração do sistema.")}},error:function(e){console.log(e);o("Erro ao verificar aprovadores.")}})}})});