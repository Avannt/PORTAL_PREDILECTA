sap.ui.define(["application/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox"],function(e,o,t,r){"use strict";var n=[];var a=[];var i=[];var s=[];var d=[];var l=[];var c;var u;return e.extend("application.controller.enviarPedidos",{onInit:function(){this.getRouter().getRoute("enviarPedidos").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;n=[];a=[];i=[];s=[];d=[];u=e.getOwnerComponent().getModel("modelAux").getProperty("/bEnviarPedido");e.byId("table_pedidos").setVisible(u);e.byId("table_entregas").setVisible(!u);e.byId("btnEnviarPedido").setVisible(u);e.byId("btnEnviarEntrega").setVisible(!u);e.byId("btnExcluir").setVisible(!u);e.byId("btnExcluirPedido").setVisible(u);if(u){this.onLoadPedidos()}else{this.onLoadEntregas()}},onItemPressEF:function(e){var o=this;var t=e;var n=t.getParameter("listItem")||e.getSource();var a=n.getBindingContext("EntregasEnviar").getProperty("Kunrg");r.show("Deseja abrir o item selecionado?",{icon:r.Icon.WARNING,title:"Editar",actions:["Sim","Cancelar"],onClose:function(e){if(e=="Sim"){o.getOwnerComponent().getModel("modelAux").setProperty("/KunrgEntrega",a);sap.ui.core.UIComponent.getRouterFor(o).navTo("entregaFutura")}}})},onLoadPedidos:function(){var e=indexedDB.open("VB_DataBase");var o=this;e.onerror=function(){r.show(e.error.mensage,{icon:r.Icon.ERROR,title:"Banco não encontrado!",actions:[r.Action.OK]})};e.onsuccess=function(){var t=e.result;var r=t.transaction("PrePedidos").objectStore("PrePedidos");var n=r.index("idStatusPedido");var s=n.getAll(2);s.onsuccess=function(e){i=e.target.result;var d=[];r=t.transaction("PrePedidos").objectStore("PrePedidos");n=r.index("idStatusPedido");s=n.getAll(9);s.onsuccess=function(e){var r=e.target.result;if(i==undefined||i.length==0){i=e.target.result}else{if(!(r==undefined||r==0)){for(var n=0;n<r.length;n++){i.push(r[n])}}}var l=new sap.ui.model.json.JSONModel(i);o.getView().setModel(l,"PedidosEnviar");for(var c=0;c<i.length;c++){d.push(new Promise(function(e,o){var r=t.transaction("ItensPedido").objectStore("ItensPedido");var n=r.index("nrPedCli");s=n.getAll(i[c].nrPedCli);s.onsuccess=function(o){for(var t=0;t<o.target.result.length;t++){var r=o.target.result[t];a.push(r)}console.log("Pedidos: ");console.log(a);e()};s.onerror=function(e){console.error(e.error.mensage);o()}}))}};Promise.all(d).then(function(e){console.log("Itens Pedido: ");console.log(a)})}}},onLoadEntregas:function(){this.byId("table_entregas").setBusy(true);var e=this;var o=new sap.ui.model.json.JSONModel;var t=indexedDB.open("VB_DataBase");t.onerror=function(){r.show(t.error.mensage,{icon:r.Icon.ERROR,title:"Banco não encontrado!",actions:[r.Action.OK]})};t.onsuccess=function(){var r=t.result;var n=r.transaction("EntregaFutura2").objectStore("EntregaFutura2");var a=n.index("Vbeln");var s=a.openCursor(undefined,"nextunique");var d=[];s.onsuccess=function(t){i=t.target.result;if(i){d.push(i.value);i.continue()}else{o=new sap.ui.model.json.JSONModel(d);e.getOwnerComponent().setModel(o,"EntregasEnviar");e.byId("table_entregas").setBusy(false)}}}},onItemChange:function(e){var o=e.getSource().getValue();var t=[];var r=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("NameOrg1",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Nrpedcli",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("AprovadoDesc",sap.ui.model.FilterOperator.Contains,o)];var n=new sap.ui.model.Filter(r,false);t.push(n);this.byId("table_relatorio_pedidos").getBinding("items").filter(t,sap.ui.model.FilterType.Application)},onNavBack:function(){sap.ui.core.UIComponent.getRouterFor(this).navTo("login")},myFormatterDataImp:function(e){if(e!==undefined&&e!==null&&e!==""&&e!==0){var o=e.split("-");var t=o[0].split("/");var r=o[1].split(":");e=t[0]+"/"+t[1]+"-"+r[0]+":"+r[1];return e}},onItemPress:function(e){var o=this;var t=e.getParameter("listItem")||e.getSource();var n=t.getBindingContext("PedidosEnviar").getProperty("nrPedCli");var a=t.getBindingContext("PedidosEnviar").getProperty("kunnr");o.getOwnerComponent().getModel("modelAux").setProperty("/Kunnr",a);o.getOwnerComponent().getModel("modelAux").setProperty("/NrPedCli",n);r.show("Deseja mesmo detalhar o Pedido? O pedido será reaberto.",{icon:r.Icon.WARNING,title:"Detalhamento Solicitado",actions:[r.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){var t=indexedDB.open("VB_DataBase");t.onerror=function(){console.log("não foi possivel encontrar e/ou carregar a base de clientes")};t.onsuccess=function(e){var t=e.target.result;var r=new Promise(function(e,r){o.carregaModelCliente(t,e,r)});r.then(function(){new Promise(function(e,o){var r=t.transaction("PrePedidos","readwrite");var a=r.objectStore("PrePedidos");var i=a.get(n);i.onsuccess=function(s){var d=s.target.result;var l=d;l.idStatusPedido=1;l.situacaoPedido="EM DIGITAÇÃO";r=t.transaction("PrePedidos","readwrite");a=r.objectStore("PrePedidos");i=a.put(l);i.onsuccess=function(){e();console.log("O pedido foi reaberto.")};i.onerror=function(){o("Erro ao reabrir pedido!");console.log("Erro ao abrir o Pedido > "+n)}}}).then(function(){sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")})})}}}})},carregaModelCliente:function(e,o,t){var r=this;var n=r.getOwnerComponent().getModel("modelAux").getProperty("/Kunnr");var a=e.transaction("Clientes","readwrite");var i=a.objectStore("Clientes");var s=i.get(n);s.onsuccess=function(e){var n=e.target.result;if(n!==null&&n!==undefined){r.getOwnerComponent().getModel("modelCliente").setProperty("/Kunnr",n.kunnr);r.getOwnerComponent().getModel("modelCliente").setProperty("/Land1",n.land1);r.getOwnerComponent().getModel("modelCliente").setProperty("/Name1",n.name1);r.getOwnerComponent().getModel("modelCliente").setProperty("/Name2",n.name2);r.getOwnerComponent().getModel("modelCliente").setProperty("/Ort01",n.ort01);r.getOwnerComponent().getModel("modelCliente").setProperty("/Ort02",n.ort02);r.getOwnerComponent().getModel("modelCliente").setProperty("/Regio",n.regio);r.getOwnerComponent().getModel("modelCliente").setProperty("/Stras",n.stras);r.getOwnerComponent().getModel("modelCliente").setProperty("/Pstlz",n.pstlz);r.getOwnerComponent().getModel("modelCliente").setProperty("/Stcd1",n.stcd1);r.getOwnerComponent().getModel("modelCliente").setProperty("/Stcd2",n.stcd2);r.getOwnerComponent().getModel("modelCliente").setProperty("/Inco1",n.inco1);r.getOwnerComponent().getModel("modelCliente").setProperty("/Parvw",n.parvw);r.getOwnerComponent().getModel("modelCliente").setProperty("/Lifnr",n.lifnr);o()}else{console.log("ERRO!! Falha ao ler Clientes.");t()}}},onSelectionChange:function(e){n=[];d=[];s=[];var o=this;var t=this.getView().byId("table_pedidos").getSelectedItems();for(var r=0;r<t.length;r++){var l=t[r].getBindingContext("PedidosEnviar").getProperty("nrPedCli");for(var c=0;c<i.length;c++){if(i[c].nrPedCli==l){n.push(i[c])}}for(var u=0;u<a.length;u++){if(a[u].nrPedCli==l){d.push(a[u])}}}},onEnviarPedido:function(e){var o=this;if(n.length==0){r.show("Selecione pelo menos um pedido para enviar!",{icon:r.Icon.WARNING,title:"Banco não encontrado!",actions:[r.Action.OK]})}else{var t=indexedDB.open("VB_DataBase");t.onerror=function(){r.show(t.error.mensage,{icon:r.Icon.ERROR,title:"Banco não encontrado!",actions:[r.Action.OK]})};t.onsuccess=function(){var e=t.result;r.show("Deseja enviar os itens selecionados?",{icon:r.Icon.WARNING,title:"Envio de itens",actions:["Enviar","Cancelar"],onClose:function(t){if(t=="Enviar"){new Promise(function(e,t){o.onVerificarAprovadorUsuario(e,t)}).then(function(){var t=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");t.setUseBatch(true);t.refreshSecurityToken();o.byId("table_pedidos").setBusy(true);var a=o.getOwnerComponent().getModel("modelAux").getProperty("/CodRepres");for(var s=0;s<n.length;s++){var l=n[s].verificadoPreposto==undefined?false:n[s].verificadoPreposto;var c=o.getOwnerComponent().getModel("modelAux").getProperty("/Tipousuario")=="1";var u=n[s].idStatusPedido;if(c&&u==9&&!l){var g=n[s].nrPedCli;r.show("Pedido "+g+" necessita ser revisado antes do envio.",{icon:r.Icon.ERROR,title:"Erro",actions:[r.Action.OK],onClose:function(){o.byId("table_pedidos").setBusy(false)}});return}}for(s=0;s<d.length;s++){if(d[s].maxdescpermitido==undefined){d[s].maxdescpermitido=0}var p=(d[s].zzAtingiuCmpGlobal||"")=="Sim";var v=(d[s].zzUtilCampGlobal||"")=="Sim";var m={Iditempedido:String(d[s].idItemPedido),Tindex:d[s].index,Knumh:String(d[s].knumh),Knumhextra:String(d[s].knumhExtra),Zzregra:String(d[s].zzRegra),Zzgrpmatextra:String(d[s].zzGrpmatExtra),Zzgrpmat:String(d[s].zzGrpmat),Zzregraextra:String(d[s].zzRegraExtra),Maktx:String(d[s].maktx),Matnr:String(d[s].matnr),Nrpedcli:String(d[s].nrPedCli),Ntgew:String(d[s].ntgew),Tipoitem:String(d[s].tipoItem),Zzdesext:String(d[s].zzDesext),Zzdesitem:String(d[s].zzDesitem),Zzpercdescdiluicao:String(d[s].zzPercDescDiluicao),Zzpercdesctotal:String(d[s].zzPercDescTotal),Zzpercom:String(d[s].zzPercom),Zzpervm:String(d[s].zzPervm),Zzvprod:String(d[s].zzVprod),Zzvproddesc:String(d[s].zzVprodDesc),Zzvproddesctotal:String(d[s].zzVprodDescTotal),Length:String(d.length),Zzvproddesc2:String(d[s].zzVprodDesc2),Zzvprodminpermitido:String(d[s].zzVprodMinPermitido),Zzvalordiluido:String(d[s].zzValorDiluido),Zzvalexcedidoitem:String(d[s].zzValExcedidoItem),Zzqntdiluicao:String(d[s].zzQntDiluicao),Tipoitem2:String(d[s].tipoItem2),Maxdescpermitidoextra:String(d[s].maxdescpermitidoExtra),Maxdescpermitido:String(d[s].maxdescpermitido),Mtpos:String(d[s].mtpos),Kbetr:String(d[s].kbetr),Zzvprodabb:String(d[s].zzVprodABB),Aumng:String(d[s].aumng),Zzqntamostra:String(d[s].zzQntAmostra),Zzqnt:String(d[s].zzQnt),Zzqntcpbrinde:String(d[s].zzQntCpBrinde),Zzgrupoglobal:String(d[s].zzGrupoGlobal),Zzsubgrupoglobal:String(d[s].zzSubGrupoGlobal),Zzqntregragb:String(d[s].zzQntRegraGb),Zzutilcampglobal:v,Zzatingiucmpglobal:p,Zzqntcppa:String(d[s].zzQntCpPA||"0"),Zzgrupocppa:String(d[s].zzGrupoCpPA||"0"),Zzidcppa:String(d[s].zzIDCpPA||"0")};t.create("/InserirLinhaOV",m,{method:"POST",success:function(e){if(e.Mtpos=="YAMO"){}console.info("Itens Inserido");o.byId("table_pedidos").setBusy(false)},error:function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e.statusCode)}})}for(var f=0;f<n.length;f++){var S={Nrpedcli:n[f].nrPedCli,Idstatuspedido:String(n[f].idStatusPedido),Kunnr:n[f].kunnr,Werks:n[f].werks,Lifnr:a,Auart:n[f].tipoPedido,Situacaopedido:n[f].situacaoPedido,Ntgew:String(n[f].ntgew),Pltyp:String(n[f].tabPreco),Completo:n[f].completo,Valminped:String(n[f].valMinPedido),Erdat:String(n[f].dataImpl.substr(6,4)+n[f].dataImpl.substr(3,2)+n[f].dataImpl.substr(0,2)),Horaped:String(n[f].dataImpl.substr(11,2)+n[f].dataImpl.substr(14,2)+n[f].dataImpl.substr(17,2)),Obsped:n[f].observacaoPedido,Obsaudped:n[f].observacaoAuditoriaPedido,Existeentradapedido:String(n[f].existeEntradaPedido),Percentradapedido:String(n[f].percEntradaPedido),Valorentradapedido:String(n[f].valorEntradaPedido),Inco1:String(n[f].tipoTransporte),Diasprimeiraparcela:String(n[f].diasPrimeiraParcela),Quantparcelas:String(n[f].quantParcelas),Intervaloparcelas:String(n[f].intervaloParcelas),Tiponego:String(n[f].tipoNegociacao),Totitens:n[f].totalItensPedido,Valorcomissao:String(parseFloat(n[f].valComissaoPedido)),Valtotpedido:String(n[f].valTotPed),Valtotabcomissao:String(n[f].valTotalAbatidoComissao),Valabverba:String(n[f].valTotalAbatidoVerba),Vlrprz:String(n[f].valTotalExcedentePrazoMed),VlrprzCom:String(n[f].valUtilizadoComissaoPrazoMed),VlrprzVm:String(n[f].valUtilizadoVerbaPrazoMed),VlrprzDd:String(0),VlrprzVvb:String(0),Vlrdsc:String(n[f].valTotalExcedenteDesconto),VlrdscCom:String(n[f].valComissaoUtilizadaDesconto),VlrdscVm:String(n[f].valVerbaUtilizadaDesconto),VlrdscDd:String(0),VlrdscVvb:String(0),Vlramo:String(n[f].valTotalExcedenteAmostra),VlramoCom:String(n[f].valUtilizadoComissaoAmostra),VlramoVm:String(n[f].valUtilizadoVerbaAmostra),VlramoDd:String(0),VlramoVvb:String(0),Vlrbri:String(n[f].valTotalExcedenteBrinde),VlrbriCom:String(n[f].valUtilizadoComissaoBrinde),VlrbriVm:String(n[f].valUtilizadoVerbaBrinde),VlrbriDd:String(0),VlrbriVvb:String(0),Vlrbon:String(n[f].valTotalExcedenteBonif),VlrbonCom:String(n[f].valUtilizadoComissaoBonif),VlrbonVm:String(n[f].valUtilizadoVerbaBonif),VlrbonDd:String(0),VlrbonVvb:String(0),Valtotabcamppa:String(n[f].valTotalCampProdutoAcabado),Valtotabcampbrinde:String(n[f].valTotalCampBrinde||0),Valtotexcndirdesc:String(n[f].valTotalExcedenteNaoDirecionadoDesconto),Valtotexcndirprazo:String(n[f].valTotalExcedenteNaoDirecionadoPrazoMed),Valverbapedido:String(n[f].valVerbaPedido),BuGruop:"",Obscom:"",Obsdd:"",Obsvm:"",Obsvvb:"",Vlrutilvpm:String(n[f].valUtilizadoVerbaPrazoMed),Vltotexcndirbri:String(n[f].valTotalExcedenteNaoDirecionadoBrinde),Vltotexcndiramo:String(n[f].valTotalExcedenteNaoDirecionadoAmostra),Vltotexcndirbon:String(n[f].valTotalExcedenteNaoDirecionadoBonif),Valcampenxoval:String(n[f].valUtilizadoCampEnxoval),Valcampglobal:String(n[f].valUtilizadoCampGlobal),Vlrutilcampenx:String(n[f].valCampEnxoval),Valcampbrinde:String(n[f].valUtilizadoCampBrinde||0),Usuario:String(n[f].codUsr),Tipousuario:String(n[f].tipoUsuario),Prazopadrao:String(n[f].PrazoPadrao||0),Prazocp:String(n[f].PrazoCP||0),Diasexcedentecp:String(n[f].DiasExcedenteCP||0),Zlsch:String(n[f].zlsch),Zzprazomed:String(n[f].zzPrazoMedio)};t.create("/InserirOV",S,{method:"POST",success:function(n){var a=e.transaction("PrePedidos","readwrite");var s=a.objectStore("PrePedidos");var d=s.get(n.Nrpedcli);d.onsuccess=function(a){var d=a.target.result;d.idStatusPedido=3;d.situacaoPedido="FIN";var l=s.put(d);l.onsuccess=function(){r.show("Pedido: "+n.Nrpedcli+" Enviado!",{icon:r.Icon.SUCCESS,title:"Pedido enviado!",actions:[r.Action.OK],onClose:function(){for(var r=0;r<i.length;r++){if(i[r].nrPedCli==n.Nrpedcli){i.splice(r,1)}}var a=parseFloat(n.Valcampenxoval||0);if(a>0){o.setaEfetuouCompraCliente(e,n.Kunnr)}t=new sap.ui.model.json.JSONModel(i);o.getView().setModel(t,"PedidosEnviar");o.byId("table_pedidos").setBusy(false)}})}}},error:function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e.statusCode)}})}t.submitChanges()}).catch(function(e){r.error(e,{title:"Envio de itens",actions:["Ok"],onClose:function(){return}})})}}})}}},setaEfetuouCompraCliente:function(e,o){var t=this;var r=[];var n=e.transaction("Clientes","readwrite");var a=n.objectStore("Clientes");var i=a.get(o);i.onsuccess=function(t){var n=t.target.result;r=n;r.efetuoucompra="true";var a=e.transaction("Clientes","readwrite");var i=a.objectStore("Clientes");var s=i.put(r);s.onsuccess=function(){console.log("O campo 'ultimacompra' do cliente foi atualizado para > 'true'")};s.onerror=function(){console.log("Erro ao abrir o cliente > "+o)}}},onAtulizaSaldoAmostra:function(e,o){var t=e.transaction("ControleAmostra","readwrite");var r=t.objectStore("ControleAmostra");var n=r.get(0);n.onsuccess=function(n){var a=n.target.result;a.quantidadeTotal=String(parseInt(a.quantidadeTotal)-o.Zzqnt);t=e.transaction("ControleAmostra","readwrite");r=t.objectStore("ControleAmostra");var i=r.put(a);i.onsuccess=function(e){console.log("Dados Controle Amostras atualizados. "+n)};i.onerror=function(e){console.log("Dados Controle Amostras não foram atualizados. "+n)}};n.onerror=function(e){console.log("Dados ControleAmostras não foram atualizados :"+e)}},onEnviarEntrega:function(e){var o=this;var t=this.byId("table_entregas").getSelectedContextPaths();if(t.length===0){r.show("Nenhuma linha foi selecionada.",{icon:r.Icon.ERROR,title:"Erro",actions:[r.Action.OK]});return}o.byId("table_entregas").setBusy(true);o.byId("btnEnviarEntrega").setBusy(true);r.show("Deseja enviar os itens selecionados?",{icon:r.Icon.WARNING,title:"Envio de itens",actions:[r.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){new Promise(function(e,t){o.onVerificarAprovadorUsuario(e,t)}).then(function(){var e=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");e.setUseBatch(true);e.refreshSecurityToken();var n=indexedDB.open("VB_DataBase");n.onerror=function(){r.show(n.error.mensage,{icon:r.Icon.ERROR,title:"Banco não encontrado!",actions:[r.Action.OK]})};n.onsuccess=function(){var r=n.result;var a=o.getView().getModel("EntregasEnviar").getData();var i=[];var s=[];for(var d=0;d<t.length;d++){var l=t[d].substring(1,2);i.push(a[l])}var c=new Promise(function(e,o){var t=r.transaction("EntregaFutura2","readwrite");var n=t.objectStore("EntregaFutura2");var a=n.index("Vbeln");var s=[];var d=a.getAll();d.onsuccess=function(o){s=o.target.result;var t=[];for(var r=0;r<i.length;r++){for(var n=0;n<s.length;n++){if(i[r].Vbeln==s[n].Vbeln){s[n].idEntregaFutura2=i[r].idEntregaFutura;t.push(s[n])}}}e(t)}});c.then(function(t){s=t;for(var n=0;n<s.length;n++){if(n==s.length-1){s[n].Ultitm="X";continue}var a=n+1;if(s[n].Vbeln!==s[a].Vbeln){s[n].Ultitm="X"}else{s[n].Ultitm=""}}var i=[];for(var n=0;n<s.length;n++){i.push(new Promise(function(t,a){var i=o.onDataAtualizacao();var d=i[0];var l=i[1];var c=localStorage.getItem("ObsEntregaSaldo");var u=c==undefined?"":c;var g=s[n];g.Data=d;g.Hora=l;g.PathImg=sap.ui.require.toUrl("application/img/S.png");g.AprovadoDesc="Enviado";var p={Arktx:g.Arktx,Aubel:g.Aubel,Aupos:g.Aupos,Bstkd:g.Bstkd,Fkimg:String(g.Fkimg),Fkimg2:String(g.Fkimg2),Kunrg:g.Kunrg,Lifnr:g.Lifnr,Matnr:g.Matnr,NameOrg1:g.NameOrg1,NameOrg2:g.NameOrg2,Posnr:g.Posnr,Sldfut:String(g.Sldfut),Ultitm:g.Ultitm,Vbeln:g.Vbeln,Identregafutura:g.idEntregaFutura2,Codrepres:g.CodRepres,Codusr:g.codUsr,Tipousuario:g.tipoUsuario,Obsped:u};e.create("/EntregaFuturaGravar",p,{method:"POST",success:function(n){var i=o.getOwnerComponent().getModel("modelAux");var s=i.getProperty("/Tipousuario");var d="Item "+g.Matnr+" da Entrega "+g.Vbeln+" enviado com sucesso.";sap.m.MessageBox.show(d,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso",actions:[sap.m.MessageBox.Action.OK],onClose:function(){var e=r.transaction("EntregaFutura3","readwrite");var o=e.objectStore("EntregaFutura3");var t=o.put(g);t.onsuccess=function(e){console.log("Salvo na tabela de histórico.")}}});var l=r.transaction("EntregaFutura2","readwrite");var c=l.objectStore("EntregaFutura2");var u=c.delete(g.idEntregaFutura);u.onsuccess=function(n){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);console.info("item ef excluido");if(p.Ultitm=="X"&&s=="1"){var a={IEntrega:p.Identregafutura};e.create("/EntregaFuturaGerar",a,{method:"POST",success:function(e){console.log("Encerrou o pedido e enviou a ordem de geração da entrega. ")}})}if(s=="1"||s=="2"){var i=r.transaction("EntregaFutura","readwrite");var d=i.objectStore("EntregaFutura");var l=new Promise(function(e,o){var t=d.get(g.Vbeln+g.Matnr);t.onsuccess=function(o){var t=o.target.result;e(t)}});l.then(function(e){e.Slddia=parseInt(e.Slddia)+parseInt(g.Fkimg2);var o=r.transaction("EntregaFutura","readwrite");var n=o.objectStore("EntregaFutura");var a=new Promise(function(o){var t=n.put(e);t.onsuccess=function(e){console.log("[Promise] saldo do dia acumulado!");o()}});a.then(function(){console.log("[Efetivada] saldo do dia acumulado!");t()})})}else{t()}};u.onerror=function(e){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);console.info(e);a()}},error:function(e){o.onMensagemErroODATA(e.statusCode)}})}))}Promise.all(i).then(function(e){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);localStorage.setItem("ObsEntregaSaldo","");o.onLoadEntregas()})})}}).catch(function(e){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);r.error(e,{title:"Envio de itens",actions:["Ok"],onClose:function(){return}})})}else{o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false)}}})},onDataAtualizacao:function(){var e=new Date;var o=String(e.getDate());var t=String(e.getMonth()+1);var r=String(e.getFullYear());var n=String(e.getMinutes());var a=String(e.getHours());var i=String(e.getSeconds());if(o.length==1){o=String("0"+o)}if(t.length==1){t=String("0"+t)}if(n.length==1){n=String("0"+n)}if(a.length==1){a=String("0"+a)}if(i.length==1){i=String("0"+i)}var s=String(o+"/"+t);var d=String(a)+":"+String(n);return[s,d]},onDeletarPedido:function(e){var o=this;var t=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");t.setUseBatch(true);if(n.length==0){r.show("Selecione pelo menos um pedido para deletar!",{icon:r.Icon.WARNING,title:"Banco não encontrado!",actions:[r.Action.OK]})}else{var a=indexedDB.open("VB_DataBase");a.onerror=function(){r.show(a.error.mensage,{icon:r.Icon.ERROR,title:"Banco não encontrado!",actions:[r.Action.OK]})};a.onsuccess=function(){var e=a.result;o.byId("table_pedidos").setBusy(true);var r=o.getView().byId("table_pedidos").getSelectedItems();for(var n=0;n<r.length;n++){var i=r[n].getBindingContext("PedidosEnviar").getProperty("nrPedCli");if(r[n].getBindingContext("PedidosEnviar").getProperty("idStatusPedido")==9){var s={Nrpedcli:String(i),Reprov:"X"};t.remove("/DelPrepostos(IvAprovado='"+s.Reprov+"',IvNrpedcli='"+s.Nrpedcli+"')",{success:function(t){var r="Pedido"+s.Nrpedcli+" deletado com sucesso!";sap.m.MessageBox.show(r,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso!",actions:[sap.m.MessageBox.Action.OK],onClose:function(t){o.byId("table_pedidos").setBusy(false);var n=e.transaction("PrePedidos","readwrite");var a=n.objectStore("PrePedidos");var i=a.delete(s.Nrpedcli);i.onsuccess=function(){r="Pedido Preposto "+s.Nrpedcli+" deletado com sucesso!";console.log(r)};i.onerror=function(){console.log("Pedido não foi deletado!")};var d=e.transaction("ItensPedido","readwrite").objectStore("ItensPedido");d.openCursor().onsuccess=function(t){var r=t.target.result;if(r){if(r.value.nrPedCli===s.Nrpedcli){var n=e.transaction("ItensPedido","readwrite");var a=n.objectStore("ItensPedido");i=a.delete(r.key);i.onsuccess=function(){console.log("Itens Pedido deletado(s)!")};i.onerror=function(){console.log("Itens Pedido não foi deletado(s)!")}}r.continue()}else{o.onLoadPedidos()}}}})},error:function(e){console.log(e);o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e.statusCode)}})}else if(r[n].getBindingContext("PedidosEnviar").getProperty("idStatusPedido")==2){var d=e.transaction("PrePedidos","readwrite");var l=d.objectStore("PrePedidos");var c=l.delete(i);c.onsuccess=function(){var e="Pedido"+i+" deletado com sucesso!";sap.m.MessageBox.show(e,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){o.byId("table_pedidos").setBusy(false)}})};c.onerror=function(){o.byId("table_pedidos").setBusy(true);console.log("Pedido não foi deletado!")};var u=e.transaction("ItensPedido","readwrite").objectStore("ItensPedido");u.openCursor().onsuccess=function(t){var r=t.target.result;if(r){if(r.value.nrPedCli===i){var n=e.transaction("ItensPedido","readwrite");var a=n.objectStore("ItensPedido");c=a.delete(r.key);c.onsuccess=function(){console.log("Itens Pedido deletado(s)!")};c.onerror=function(){console.log("Itens Pedido não foi deletado(s)!")}}r.continue()}else{o.onLoadPedidos();o.byId("table_pedidos").setBusy(true)}}}}t.submitChanges()}}},onExcluirEntregas:function(e){var o=this;var t=this.byId("table_entregas").getSelectedContextPaths();if(t.length===0){r.show("Nenhuma linha foi selecionada.",{icon:r.Icon.ERROR,title:"Erro",actions:[r.Action.OK]});return}r.show("Deseja excluir os itens selecionados?",{icon:r.Icon.WARNING,title:"Exclusão de itens",actions:[r.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){var n=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");n.setUseBatch(true);n.refreshSecurityToken();var a=indexedDB.open("VB_DataBase");a.onerror=function(){r.show(a.error.mensage,{icon:r.Icon.ERROR,title:"Banco não encontrado!",actions:[r.Action.OK]})};a.onsuccess=function(){var e=a.result;var r=o.getView().getModel("EntregasEnviar").getData();var i=[];for(var s=0;s<t.length;s++){var d=t[s].substring(1,2);i.push(r[d])}var l=new Promise(function(o,t){var r=e.transaction("EntregaFutura2","readwrite");var n=r.objectStore("EntregaFutura2");var a=n.index("Vbeln");var s=[];var d=a.getAll();d.onsuccess=function(e){s=e.target.result;var t=[];for(var r=0;r<i.length;r++){for(var n=0;n<s.length;n++){if(i[r].Vbeln==s[n].Vbeln){t.push(s[n])}}}o(t)}});l.then(function(t){i=t;for(var r=0;r<i.length;r++){var a=e.transaction("EntregaFutura2","readwrite");var s=a.objectStore("EntregaFutura2");var d=s.delete(i[r].idEntregaFutura);var l=o.getOwnerComponent().getModel("modelAux");var c=l.getProperty("/Tipousuario");d.onsuccess=function(e){o.byId("table_entregas").setBusy(false);console.info("item ef excluido do banco local.")};if(c=="1"&&i[r].tipoUsuario=="2"){var u={IEntrega:i[r].idEntregaFutura};n.create("/EntregaFuturaExcluir",u,{method:"POST",success:function(e){o.onLoadEntregas();console.log("Excluiu o PV no SAP.")}})}else{o.onLoadEntregas()}}})}}}})},onMontarCabecalho:function(e,o,t){},onMontarLinha:function(){},onMensagemErroODATA:function(e){if(e==0){sap.m.MessageBox.show("Verifique a conexão com a internet!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Falha na Conexão!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==400){sap.m.MessageBox.show("Url mal formada! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Fiori!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==403){sap.m.MessageBox.show("Usuário sem autorização para executar a função (403)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==404){sap.m.MessageBox.show("Função não encontrada e/ou Parâmentros inválidos  (404)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==500){sap.m.MessageBox.show("Ocorreu um Erro (500)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==501){sap.m.MessageBox.show("Função não implementada (501)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}},onVerificarAprovadorUsuario:function(e,o){var t=this.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");var r=this.getOwnerComponent().getModel("modelAux").getProperty("/CodRepres");t.read("/FluxoAprovacao('"+r+"')",{success:function(t){var r=t.ERetorno=="S";if(r){e()}else{o("Usuário atual não possui aprovadores cadastrados, favor entrar em contato com a administração do sistema.")}},error:function(e){console.log(e);o("Erro ao verificar aprovadores.")}})}})});