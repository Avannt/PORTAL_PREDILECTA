sap.ui.define(["application/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel"],function(e,o,t,n,r,a){"use strict";return e.extend("application.controller.enviarPedidos",{onInit:function(){this.getRouter().getRoute("enviarPedidos").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;e.oModel=e.getModel();var o=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.byId("table_pedidos").setBusy(true);new Promise(function(t,n){e.onBuscarCentros(o,t,n,e)}).then(function(t){var n=new r(t);e.setModel(n,"Centros");new Promise(function(t,n){e.onBuscarClientes(o,t,n,e)}).then(function(t){var n=new r(t);e.setModel(n,"Clientes");e.byId("table_pedidos").setBusy(false);new Promise(function(t,n){var r="";var a=true;e.onBuscarPedidos(r,o,a,t,n,e)}).then(function(o){e.vetorPedidos=o;var t=new r(e.vetorPedidos);e.setModel(t,"Pedidos");e.byId("table_pedidos").setBusy(false)}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})},myFormatterCodEmpresa:function(e){var o=this.getModel("Centros").getData();for(var t=0;t<o.length;t++){if(e==o[t].Bukrs){return e+"-"+o[t].NomeCentro}}},myFormatterCliente:function(e){var o=this.getModel("Clientes").getData();for(var t=0;t<o.length;t++){if(e==o[t].Kunnr){return e+"-"+o[t].Name1}}},onItemPressEF:function(e){var o=this;var t=e;var r=t.getParameter("listItem")||e.getSource();var a=r.getBindingContext("EntregasEnviar").getProperty("Kunrg");n.show("Deseja abrir o item selecionado?",{icon:n.Icon.WARNING,title:"Editar",actions:["Sim","Cancelar"],onClose:function(e){if(e=="Sim"){o.getOwnerComponent().getModel("modelAux").setProperty("/KunrgEntrega",a);sap.ui.core.UIComponent.getRouterFor(o).navTo("entregaFutura")}}})},onItemChange:function(e){var o=e.getSource().getValue();var t=[];var n=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("NameOrg1",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Nrpedcli",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("AprovadoDesc",sap.ui.model.FilterOperator.Contains,o)];var r=new sap.ui.model.Filter(n,false);t.push(r);this.byId("table_relatorio_pedidos").getBinding("items").filter(t,sap.ui.model.FilterType.Application)},myFormatterDataImp:function(e){if(e!==undefined&&e!==null&&e!==""&&e!==0){var o=e.split("-");var t=o[0].split("/");var n=o[1].split(":");e=t[0]+"/"+t[1]+"-"+n[0]+":"+n[1];return e}},onItemPress:function(e){var o=this;var t=e.getParameter("listItem")||e.getSource();var r=t.getBindingContext("PedidosEnviar").getProperty("nrPedCli");var a=t.getBindingContext("PedidosEnviar").getProperty("kunnr");o.getOwnerComponent().getModel("modelAux").setProperty("/Kunnr",a);o.getOwnerComponent().getModel("modelAux").setProperty("/NrPedCli",r);n.show("Deseja mesmo detalhar o Pedido? O pedido será reaberto.",{icon:n.Icon.WARNING,title:"Detalhamento Solicitado",actions:[n.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){var t=indexedDB.open("VB_DataBase");t.onerror=function(){console.log("não foi possivel encontrar e/ou carregar a base de clientes")};t.onsuccess=function(e){var t=e.target.result;var n=new Promise(function(e,n){o.carregaModelCliente(t,e,n)});n.then(function(){new Promise(function(e,o){var n=t.transaction("PrePedidos","readwrite");var a=n.objectStore("PrePedidos");var s=a.get(r);s.onsuccess=function(i){var l=i.target.result;var d=l;d.idStatusPedido=1;d.situacaoPedido="EM DIGITAÇÃO";n=t.transaction("PrePedidos","readwrite");a=n.objectStore("PrePedidos");s=a.put(d);s.onsuccess=function(){e();console.log("O pedido foi reaberto.")};s.onerror=function(){o("Erro ao reabrir pedido!");console.log("Erro ao abrir o Pedido > "+r)}}}).then(function(){sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")})})}}}})},carregaModelCliente:function(e,o,t){var n=this;var r=n.getOwnerComponent().getModel("modelAux").getProperty("/Kunnr");var a=e.transaction("Clientes","readwrite");var s=a.objectStore("Clientes");var i=s.get(r);i.onsuccess=function(e){var r=e.target.result;if(r!==null&&r!==undefined){n.getOwnerComponent().getModel("modelCliente").setProperty("/Kunnr",r.kunnr);n.getOwnerComponent().getModel("modelCliente").setProperty("/Land1",r.land1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Name1",r.name1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Name2",r.name2);n.getOwnerComponent().getModel("modelCliente").setProperty("/Ort01",r.ort01);n.getOwnerComponent().getModel("modelCliente").setProperty("/Ort02",r.ort02);n.getOwnerComponent().getModel("modelCliente").setProperty("/Regio",r.regio);n.getOwnerComponent().getModel("modelCliente").setProperty("/Stras",r.stras);n.getOwnerComponent().getModel("modelCliente").setProperty("/Pstlz",r.pstlz);n.getOwnerComponent().getModel("modelCliente").setProperty("/Stcd1",r.stcd1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Stcd2",r.stcd2);n.getOwnerComponent().getModel("modelCliente").setProperty("/Inco1",r.inco1);n.getOwnerComponent().getModel("modelCliente").setProperty("/Parvw",r.parvw);n.getOwnerComponent().getModel("modelCliente").setProperty("/Lifnr",r.lifnr);o()}else{console.log("ERRO!! Falha ao ler Clientes.");t()}}},onSelectionChange:function(e){var o=this;var t=[];var n=this.byId("table_pedidos").getSelectedItems();for(var a=0;a<n.length;a++){var s=n[a].getBindingContext("Pedidos").getObject();delete s.__metadata;delete s.IvEnvio;delete s.IvUsuario;delete s.IvKunnr;t.push(s)}var i=new r(t);o.setModel(i,"PedidosEnviar")},onEnviarPedido:function(e){var o=this;var t=o.getModel("PedidosEnviar").getData();if(t.length==0){n.show("Selecione pelo menos um pedido para enviar!",{icon:n.Icon.ERROR,title:"Pedido não encontrado!!",actions:[n.Action.OK]})}else{n.show("Deseja enviar os itens selecionados?",{icon:n.Icon.WARNING,title:"Envio de itens",actions:["Enviar","Cancelar"],onClose:function(e){if(e=="Enviar"){var n=o.getModelGlobal("modelAux").getProperty("/Url");var r=new a({serviceUrl:n});r.setUseBatch(true);r.refreshSecurityToken();o.byId("table_pedidos").setBusy(true);for(var s=0;s<t.length;s++){var i=t[s];i.IdStatusPedido=3;i.SituacaoPedido="FIN";o.onFormatNumberPedido(i);r.create("/P_PedidoPR",i,{method:"POST",success:function(e){console.info("Pedido "+e.NrPedido+" Inserido.")},error:function(e){o.onMensagemErroODATA(e)}})}r.submitChanges();r.attachBatchRequestCompleted(function(e){o._onLoadFields()})}}})}},setaEfetuouCompraCliente:function(e,o){var t=this;var n=[];var r=e.transaction("Clientes","readwrite");var a=r.objectStore("Clientes");var s=a.get(o);s.onsuccess=function(t){var r=t.target.result;n=r;n.efetuoucompra="true";var a=e.transaction("Clientes","readwrite");var s=a.objectStore("Clientes");var i=s.put(n);i.onsuccess=function(){console.log("O campo 'ultimacompra' do cliente foi atualizado para > 'true'")};i.onerror=function(){console.log("Erro ao abrir o cliente > "+o)}}},onAtulizaSaldoAmostra:function(e,o){var t=e.transaction("ControleAmostra","readwrite");var n=t.objectStore("ControleAmostra");var r=n.get(0);r.onsuccess=function(r){var a=r.target.result;a.quantidadeTotal=String(parseInt(a.quantidadeTotal)-o.Zzqnt);t=e.transaction("ControleAmostra","readwrite");n=t.objectStore("ControleAmostra");var s=n.put(a);s.onsuccess=function(e){console.log("Dados Controle Amostras atualizados. "+r)};s.onerror=function(e){console.log("Dados Controle Amostras não foram atualizados. "+r)}};r.onerror=function(e){console.log("Dados ControleAmostras não foram atualizados :"+e)}},onEnviarEntrega:function(e){var o=this;var t=this.byId("table_entregas").getSelectedContextPaths();if(t.length===0){n.show("Nenhuma linha foi selecionada.",{icon:n.Icon.ERROR,title:"Erro",actions:[n.Action.OK]});return}o.byId("table_entregas").setBusy(true);o.byId("btnEnviarEntrega").setBusy(true);n.show("Deseja enviar os itens selecionados?",{icon:n.Icon.WARNING,title:"Envio de itens",actions:[n.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){new Promise(function(e,t){o.onVerificarAprovadorUsuario(e,t)}).then(function(){var e=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");e.setUseBatch(true);e.refreshSecurityToken();var r=indexedDB.open("VB_DataBase");r.onerror=function(){n.show(r.error.mensage,{icon:n.Icon.ERROR,title:"Banco não encontrado!",actions:[n.Action.OK]})};r.onsuccess=function(){var n=r.result;var a=o.getView().getModel("EntregasEnviar").getData();var s=[];var i=[];for(var l=0;l<t.length;l++){var d=t[l].substring(1,2);s.push(a[d])}var c=new Promise(function(e,o){var t=n.transaction("EntregaFutura2","readwrite");var r=t.objectStore("EntregaFutura2");var a=r.index("Vbeln");var i=[];var l=a.getAll();l.onsuccess=function(o){i=o.target.result;var t=[];for(var n=0;n<s.length;n++){for(var r=0;r<i.length;r++){if(s[n].Vbeln==i[r].Vbeln){i[r].idEntregaFutura2=s[n].idEntregaFutura;t.push(i[r])}}}e(t)}});c.then(function(t){i=t;for(var r=0;r<i.length;r++){if(r==i.length-1){i[r].Ultitm="X";continue}var a=r+1;if(i[r].Vbeln!==i[a].Vbeln){i[r].Ultitm="X"}else{i[r].Ultitm=""}}var s=[];for(var r=0;r<i.length;r++){s.push(new Promise(function(t,a){var s=o.onDataAtualizacao();var l=s[0];var d=s[1];var c=localStorage.getItem("ObsEntregaSaldo");var u=c==undefined?"":c;var g=i[r];g.Data=l;g.Hora=d;g.PathImg=sap.ui.require.toUrl("application/img/S.png");g.AprovadoDesc="Enviado";var v={Arktx:g.Arktx,Aubel:g.Aubel,Aupos:g.Aupos,Bstkd:g.Bstkd,Fkimg:String(g.Fkimg),Fkimg2:String(g.Fkimg2),Kunrg:g.Kunrg,Lifnr:g.Lifnr,Matnr:g.Matnr,NameOrg1:g.NameOrg1,NameOrg2:g.NameOrg2,Posnr:g.Posnr,Sldfut:String(g.Sldfut),Ultitm:g.Ultitm,Vbeln:g.Vbeln,Identregafutura:g.idEntregaFutura2,Codrepres:g.CodRepres,Codusr:g.codUsr,Tipousuario:g.tipoUsuario,Obsped:u};e.create("/EntregaFuturaGravar",v,{method:"POST",success:function(r){var s=o.getOwnerComponent().getModel("modelAux");var i=s.getProperty("/Tipousuario");var l="Item "+g.Matnr+" da Entrega "+g.Vbeln+" enviado com sucesso.";sap.m.MessageBox.show(l,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso",actions:[sap.m.MessageBox.Action.OK],onClose:function(){var e=n.transaction("EntregaFutura3","readwrite");var o=e.objectStore("EntregaFutura3");var t=o.put(g);t.onsuccess=function(e){console.log("Salvo na tabela de histórico.")}}});var d=n.transaction("EntregaFutura2","readwrite");var c=d.objectStore("EntregaFutura2");var u=c.delete(g.idEntregaFutura);u.onsuccess=function(r){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);console.info("item ef excluido");if(v.Ultitm=="X"&&i=="1"){var a={IEntrega:v.Identregafutura};e.create("/EntregaFuturaGerar",a,{method:"POST",success:function(e){console.log("Encerrou o pedido e enviou a ordem de geração da entrega. ")}})}if(i=="1"||i=="2"){var s=n.transaction("EntregaFutura","readwrite");var l=s.objectStore("EntregaFutura");var d=new Promise(function(e,o){var t=l.get(g.Vbeln+g.Matnr);t.onsuccess=function(o){var t=o.target.result;e(t)}});d.then(function(e){e.Slddia=parseInt(e.Slddia)+parseInt(g.Fkimg2);var o=n.transaction("EntregaFutura","readwrite");var r=o.objectStore("EntregaFutura");var a=new Promise(function(o){var t=r.put(e);t.onsuccess=function(e){console.log("[Promise] saldo do dia acumulado!");o()}});a.then(function(){console.log("[Efetivada] saldo do dia acumulado!");t()})})}else{t()}};u.onerror=function(e){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);console.info(e);a()}},error:function(e){o.onMensagemErroODATA(e.statusCode)}})}))}Promise.all(s).then(function(e){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);localStorage.setItem("ObsEntregaSaldo","");o.onLoadEntregas()})})}}).catch(function(e){o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false);n.error(e,{title:"Envio de itens",actions:["Ok"],onClose:function(){return}})})}else{o.byId("table_entregas").setBusy(false);o.byId("btnEnviarEntrega").setBusy(false)}}})},onDataAtualizacao:function(){var e=new Date;var o=String(e.getDate());var t=String(e.getMonth()+1);var n=String(e.getFullYear());var r=String(e.getMinutes());var a=String(e.getHours());var s=String(e.getSeconds());if(o.length==1){o=String("0"+o)}if(t.length==1){t=String("0"+t)}if(r.length==1){r=String("0"+r)}if(a.length==1){a=String("0"+a)}if(s.length==1){s=String("0"+s)}var i=String(o+"/"+t);var l=String(a)+":"+String(r);return[i,l]},onDeletarPedido:function(e){var o=this;var t=this.getModel("Pedidos").getData();var r=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");r.setUseBatch(true);r.refreshSecurityToken();if(t.length==0){n.show("Selecione pelo menos um pedido para deletar!",{icon:n.Icon.WARNING,title:"Banco não encontrado!",actions:[n.Action.OK]})}else{var a=indexedDB.open("VB_DataBase");a.onerror=function(){n.show(a.error.mensage,{icon:n.Icon.ERROR,title:"Banco não encontrado!",actions:[n.Action.OK]})};a.onsuccess=function(){var e=a.result;o.byId("table_pedidos").setBusy(true);var t=o.getView().byId("table_pedidos").getSelectedItems();for(var n=0;n<t.length;n++){var s=t[n].getBindingContext("PedidosEnviar").getProperty("nrPedCli");if(t[n].getBindingContext("PedidosEnviar").getProperty("idStatusPedido")==9){var i={Nrpedcli:String(s),Reprov:"X"};r.remove("/DelPrepostos(IvAprovado='"+i.Reprov+"',IvNrpedcli='"+i.Nrpedcli+"')",{success:function(t){var n="Pedido"+i.Nrpedcli+" deletado com sucesso!";sap.m.MessageBox.show(n,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso!",actions:[sap.m.MessageBox.Action.OK],onClose:function(t){o.byId("table_pedidos").setBusy(false);var r=e.transaction("PrePedidos","readwrite");var a=r.objectStore("PrePedidos");var s=a.delete(i.Nrpedcli);s.onsuccess=function(){n="Pedido Preposto "+i.Nrpedcli+" deletado com sucesso!";console.log(n)};s.onerror=function(){console.log("Pedido não foi deletado!")};var l=e.transaction("ItensPedido","readwrite").objectStore("ItensPedido");l.openCursor().onsuccess=function(t){var n=t.target.result;if(n){if(n.value.nrPedCli===i.Nrpedcli){var r=e.transaction("ItensPedido","readwrite");var a=r.objectStore("ItensPedido");s=a.delete(n.key);s.onsuccess=function(){console.log("Itens Pedido deletado(s)!")};s.onerror=function(){console.log("Itens Pedido não foi deletado(s)!")}}n.continue()}else{o.onLoadPedidos()}}}})},error:function(e){console.log(e);o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e.statusCode)}})}else if(t[n].getBindingContext("PedidosEnviar").getProperty("idStatusPedido")==2){var l=e.transaction("PrePedidos","readwrite");var d=l.objectStore("PrePedidos");var c=d.delete(s);c.onsuccess=function(){var e="Pedido"+s+" deletado com sucesso!";sap.m.MessageBox.show(e,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){o.byId("table_pedidos").setBusy(false)}})};c.onerror=function(){o.byId("table_pedidos").setBusy(true);console.log("Pedido não foi deletado!")};var u=e.transaction("ItensPedido","readwrite").objectStore("ItensPedido");u.openCursor().onsuccess=function(t){var n=t.target.result;if(n){if(n.value.nrPedCli===s){var r=e.transaction("ItensPedido","readwrite");var a=r.objectStore("ItensPedido");c=a.delete(n.key);c.onsuccess=function(){console.log("Itens Pedido deletado(s)!")};c.onerror=function(){console.log("Itens Pedido não foi deletado(s)!")}}n.continue()}else{o.onLoadPedidos();o.byId("table_pedidos").setBusy(true)}}}}r.submitChanges()}}},onExcluirEntregas:function(e){var o=this;var t=this.byId("table_entregas").getSelectedContextPaths();if(t.length===0){n.show("Nenhuma linha foi selecionada.",{icon:n.Icon.ERROR,title:"Erro",actions:[n.Action.OK]});return}n.show("Deseja excluir os itens selecionados?",{icon:n.Icon.WARNING,title:"Exclusão de itens",actions:[n.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){var r=o.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");r.setUseBatch(true);r.refreshSecurityToken();var a=indexedDB.open("VB_DataBase");a.onerror=function(){n.show(a.error.mensage,{icon:n.Icon.ERROR,title:"Banco não encontrado!",actions:[n.Action.OK]})};a.onsuccess=function(){var e=a.result;var n=o.getView().getModel("EntregasEnviar").getData();var s=[];for(var i=0;i<t.length;i++){var l=t[i].substring(1,2);s.push(n[l])}var d=new Promise(function(o,t){var n=e.transaction("EntregaFutura2","readwrite");var r=n.objectStore("EntregaFutura2");var a=r.index("Vbeln");var i=[];var l=a.getAll();l.onsuccess=function(e){i=e.target.result;var t=[];for(var n=0;n<s.length;n++){for(var r=0;r<i.length;r++){if(s[n].Vbeln==i[r].Vbeln){t.push(i[r])}}}o(t)}});d.then(function(t){s=t;for(var n=0;n<s.length;n++){var a=e.transaction("EntregaFutura2","readwrite");var i=a.objectStore("EntregaFutura2");var l=i.delete(s[n].idEntregaFutura);var d=o.getOwnerComponent().getModel("modelAux");var c=d.getProperty("/Tipousuario");l.onsuccess=function(e){o.byId("table_entregas").setBusy(false);console.info("item ef excluido do banco local.")};if(c=="1"&&s[n].tipoUsuario=="2"){var u={IEntrega:s[n].idEntregaFutura};r.create("/EntregaFuturaExcluir",u,{method:"POST",success:function(e){o.onLoadEntregas();console.log("Excluiu o PV no SAP.")}})}else{o.onLoadEntregas()}}})}}}})},onMontarCabecalho:function(e,o,t){},onMontarLinha:function(){},onMensagemErroODATA:function(e){if(e==0){sap.m.MessageBox.show("Verifique a conexão com a internet!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Falha na Conexão!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==400){sap.m.MessageBox.show("Url mal formada! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Fiori!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==403){sap.m.MessageBox.show("Usuário sem autorização para executar a função (403)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==404){sap.m.MessageBox.show("Função não encontrada e/ou Parâmentros inválidos  (404)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==500){sap.m.MessageBox.show("Ocorreu um Erro (500)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}else if(e==501){sap.m.MessageBox.show("Função não implementada (501)! Contate a consultoria!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no programa Abap!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){}})}},onVerificarAprovadorUsuario:function(e,o){var t=this.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");var n=this.getOwnerComponent().getModel("modelAux").getProperty("/CodRepres");t.read("/FluxoAprovacao('"+n+"')",{success:function(t){var n=t.ERetorno=="S";if(n){e()}else{o("Usuário atual não possui aprovadores cadastrados, favor entrar em contato com a administração do sistema.")}},error:function(e){console.log(e);o("Erro ao verificar aprovadores.")}})}})});