sap.ui.define(["jquery.sap.global","sap/m/MessageToast","sap/ui/core/Fragment","application/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(e,t,o,i,s,n,r,a){"use strict";return i.extend("application.controller.Pedido",{onInit:function(){this.getRouter().getRoute("pedido").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;this.vetorClientes=[];this.oPrePedidos=[];this.oVetorTitulos=[];var t=this.getModelGlobal("modelAux").getProperty("/CodRepres");this.onInicializaModels();new Promise(function(o,i){e.onBuscarClientes(t,o,i,e)}).then(function(t){var o=new a(t);e.setModel(o,"Clientes");e.byId("master").setBusy(false)}).catch(function(t){sap.m.MessageBox.show("Falha ao carregar os clientes! ("+t.statusCode+")",{icon:sap.m.MessageBox.Icon.WARNING,title:"Erro no carregamento!",details:t,actions:[sap.m.MessageBox.Action.OK],onClose:function(t){e.byId("master").setBusy(false)}})})},onInicializaModels:function(){this.byId("master").setBusy(true);this.getModelGlobal("modelAux").setProperty("/NrPedCli","");this.getModelGlobal("modelAux").setProperty("/Kunnr","");this.oModel=this.getView().getModel();var e={Kunnr:"",Name1:"Nenhum cliente selecionado",Stcd1:"",Stcd2:""};var t=new sap.ui.model.json.JSONModel(e);this.setModel(t,"Cliente");this.setModelGlobal(t,"Cliente_G");var o=new a;this.setModel(o,"Pedidos");this.getModelGlobal("modelAux").setProperty("/NrPedido","")},onNavBack:function(){sap.ui.core.UIComponent.getRouterFor(this).navTo("menu")},formatRentabilidade:function(e){if(e==0){this.byId("table_pedidos").getColumns()[4].setVisible(false);return e}else if(e>-3){this.byId("table_pedidos").getColumns()[4].setVisible(false);return""}else{this.byId("table_pedidos").getColumns()[4].setVisible(true);return e}},onAfterRendering:function(){var t=this.getSplitContObj(),o=t.getDomRef()&&t.getDomRef().parentNode;if(o&&!o._sapui5_heightFixed){o._sapui5_heightFixed=true;while(o&&o!==document.documentElement){var i=e(o);if(i.attr("data-sap-ui-root-content")){break}if(!o.style.height){o.style.height="100%"}o=o.parentNode}}},getSplitContObj:function(){var t=this.byId("SplitCont");if(!t){e.sap.log.error("SplitApp object can't be found")}return t},onPressNavToDetail:function(){this.getSplitContObj().to(this.createId("detailDetail"))},navBack2:function(){var e=this.getModelGlobal("modelAux").getProperty("/isTablet");if(e==true){sap.ui.core.UIComponent.getRouterFor(this).navTo("menu")}else{this.byId("listClientes").removeSelections(true);this.onPressDetailBack()}},onPressDetailBack:function(){this.getSplitContObj().backDetail()},onSelectionChange:function(e){var t=this;t.vetorPedidos=[];this.byId("table_pedidos").setBusy(true);var o=e.getParameter("listItem")||e.getSource();var i=o.getBindingContext("Clientes").getObject();t.getModelGlobal("Cliente_G").setData(i);this.getSplitContObj().toDetail(this.createId("detail"));this.oModel.read("/P_PedidoQ",{urlParameters:{$filter:"IvUsuario eq '"+this.getModelGlobal("modelAux").getProperty("/CodRepres")+"' and IvKunnr eq '"+i.Kunnr+"'"},success:function(e){t.vetorPedidos=e.results;var o=new a(t.vetorPedidos);t.getView().setModel(o,"Pedidos");t.byId("table_pedidos").setBusy(false)},error:function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)}});this.getSplitContObj().toDetail(this.createId("detail"))},onSearch:function(e){var t=e.getSource().getValue();var o=[];var i=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("Stcd1",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("Stcd2",sap.ui.model.FilterOperator.Contains,t)];var s=new sap.ui.model.Filter(i,false);o.push(s);this.byId("listClientes").getBinding("items").filter(o,"Application")},onEditarPress:function(e){var t=this;var o=e.getParameter("listItem")||e.getSource();var i=o.getBindingContext("Pedidos").getProperty("NrPedido");var s=o.getBindingContext("Pedidos").getProperty("IdStatusPedido");var n=this.getModel("Cliente").getData();var a=this.getModelGlobal("modelAux").getProperty("/CodRepres");t.byId("table_pedidos").setBusy(true);if(s==3){r.show("Não é possível realizar a edição de pedidos já integrados! ",{icon:r.Icon.ERROR,title:"Ação não permitida!",actions:[r.Action.OK],onClose:function(){t.byId("table_pedidos").setBusy(false)}})}else if(s==2){r.show("Deseja reabrir o pedido?",{icon:r.Icon.WARNING,title:"Detalhamento do pedido!",actions:["Reabrir","Vizualizar",sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e=="Reabrir"){new Promise(function(e,o){t.onCheckPedido(a,n.Kunnr,e,o,t)}).then(function(e){if(e.TipoErro=="E"){r.show("O Pedido: "+e.NrPedido+", Cliente: "+e.Kunnr+" está em aberto.",{icon:r.Icon.ERROR,details:"<li> Curioso! </li>",title:"Pedido em aberto",actions:[r.Action.OK],onClose:function(){t.byId("table_pedidos").setBusy(false)}})}else{new Promise(function(e,o){t.onBuscarPedido(i,e,o)}).then(function(e){var o=t.onDataHora();e.SituacaoPedido="EM DIGITAÇÃO";e.IdStatusPedido=1;e.DataFim=o[0];e.HoraFim=o[1];e.Completo=true;e=t.onFormatNumberPedido(e);delete e.__metadata;new Promise(function(o,i){t.onInserirPedido(e,o,i,t)}).then(function(e){t.byId("table_pedidos").setBusy(false);if(e.TipoErro=="E"){sap.m.MessageBox.show(e.MsgErro,{icon:sap.m.MessageBox.Icon.ERROR,title:"Não Permitido",actions:[r.Action.OK],onClose:function(){}})}else{t.getModelGlobal("modelAux").setProperty("/NrPedido",i);sap.ui.core.UIComponent.getRouterFor(t).navTo("pedidoDetalhe")}}).catch(function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)})}).catch(function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)})}}).catch(function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)})}else if(e=="Vizualizar"){t.byId("table_pedidos").setBusy(false);t.getModelGlobal("modelAux").setProperty("/NrPedido",i);sap.ui.core.UIComponent.getRouterFor(t).navTo("pedidoDetalhe")}else{t.byId("table_pedidos").setBusy(false)}}})}else{t.byId("table_pedidos").setBusy(false);t.getModelGlobal("modelAux").setProperty("/NrPedido",i);sap.ui.core.UIComponent.getRouterFor(t).navTo("pedidoDetalhe")}},onAddPedido:function(){var e="";var t=this;var o=this.getModel("Cliente").getData();var i=this.getModelGlobal("modelAux").getProperty("/CodRepres");if(o.Kunnr==""){r.show("Nenhum cliente selecionado! Selecione um cliente!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Nenhum cliente selecionado",actions:[r.Action.OK]})}else{new Promise(function(e,s){t.onCheckPedido(i,o.Kunnr,e,s,t)}).then(function(o){e=o;if(e.TipoErro=="E"){r.show("O Pedido: "+e.NrPedido+", Cliente: "+e.Kunnr+" está em aberto.",{icon:r.Icon.ERROR,details:"<li> Curioso! </li>",title:"Pedido em aberto",actions:[r.Action.OK]})}else{if(e.TipoErro=="S"&&e.MsgErro==""){sap.ui.core.UIComponent.getRouterFor(t).navTo("pedidoDetalhe")}else{r.show(e.MsgErro,{icon:sap.m.MessageBox.Icon.WARNING,title:"Títulos em Aberto!",actions:["Ver Titulo","Continuar","Cancelar"],onClose:function(e){if(e=="Ver Titulo"){t.getOwnerComponent().getModel("modelAux").getProperty("/Kunnr");sap.ui.core.UIComponent.getRouterFor(t).navTo("relatorioTitulos")}else if(e=="Continuar"){sap.ui.core.UIComponent.getRouterFor(t).navTo("pedidoDetalhe")}else{this.getOwnerComponent().getModel("modelAux").setProperty("/telaPedido",true);sap.ui.core.UIComponent.getRouterFor(this).navTo("relatorioTitulos")}}})}}}).catch(function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)})}},onItemPress:function(e){var t=this;var o=e.getParameter("listItem")||e.getSource();var i=o.getBindingContext("Pedidos").getProperty("NrPedido");var s=o.getBindingContext("Pedidos").getProperty("SituacaoPedido");var n="";var r="";t.getModelGlobal("modelAux").setProperty("/NrPedido",i);sap.ui.core.UIComponent.getRouterFor(t).navTo("pedidoDetalhe")},onExcluirPedido:function(e){var t=this;var o=false;var i=e.getParameter("listItem")||e.getSource();var s=i.getBindingContext("Pedidos").getProperty("NrPedido");var n=i.getBindingContext("Pedidos").getProperty("Bukrs");var a=i.getBindingContext("Pedidos").getProperty("IdStatusPedido");if(a==3){var d="Não é possível deletar pedidos que já foram integrados!";r.error(d,{icon:r.Icon.ERROR,title:"Deleção de pedido.",actions:[sap.m.MessageBox.Action.OK]})}else{r.show("Deseja mesmo excluir o pedido?",{icon:r.Icon.WARNING,title:"Exclusão de Pedidos",actions:[r.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){t.byId("table_pedidos").setBusy(true);new Promise(function(e,o){t.onExcluirPed(s,e,o)}).then(function(){var e=t.getModelGlobal("Cliente_G").getData();var o=t.getModelGlobal("modelAux").getProperty("/CodRepres");var i=false;new Promise(function(s,n){t.onBuscarPedidos(e.Kunnr,o,i,s,n,t)}).then(function(e){t.getModel("modelAux").setProperty("/PedidosPend",e);t.byId("table_pedidos").setBusy(false)}).catch(function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)})}).catch(function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)})}}})}},handleLinkPress:function(){var e=this.getOwnerComponent().getModel("modelAux").getProperty("/CodCliente");this.getOwnerComponent().getModel("modelAux").setProperty("/telaPedido",true);sap.ui.core.UIComponent.getRouterFor(this).navTo("relatorioTitulos")}})});