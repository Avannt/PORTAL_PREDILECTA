sap.ui.define(["jquery.sap.global","sap/m/MessageToast","sap/ui/core/Fragment","application/controller/BaseController","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(jQuery,e,o,t,i,s,r,a){"use strict";return t.extend("application.controller.Pedido",{onInit:function(){this.getRouter().getRoute("pedido").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;this.vetorClientes=[];this.oPrePedidos=[];this.oVetorTitulos=[];var o=this.getModelGlobal("modelAux").getProperty("/CodRepres");this.onInicializaModels();new Promise(function(t,i){e.onBuscarClientes(o,t,i,e)}).then(function(o){var t=new a(o);e.setModel(t,"Clientes");e.byId("master").setBusy(false)}).catch(function(o){e.byId("master").setBusy(false);e.onMensagemErroODATA(o)})},onEditarPress:function(e){var o=this;var t=e.getParameter("listItem")||e.getSource();var i=t.getBindingContext("Pedidos").getObject();if(i.IdStatusPedido==3){r.show("Não é possível realizar a edição de pedidos já integrados! ",{icon:r.Icon.ERROR,title:"Ação não permitida!",actions:[r.Action.OK]})}else if(i.IdStatusPedido==2){r.show("Deseja reabrir o pedido?",{icon:r.Icon.WARNING,title:"Detalhamento do pedido!",actions:["Reabrir","Visualizar",sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e=="Reabrir"){if(i.Usuario!=o.getModelGlobal("modelAux").getProperty("/CodRepres")){r.show("Não é possível realizar a edição. Usuario criação: "+i.Usuario+", Usuario edição: "+o.getModelGlobal("modelAux").getProperty("/CodRepres")+".",{icon:r.Icon.ERROR,title:"Ação não permitida!",actions:[r.Action.OK]})}else{new Promise(function(e,t){o.byId("table_pedidos").setBusy(true);o.onBuscarPedido(i.NrPedido,e,t,o)}).then(function(e){var t=o.onDataHora();e.SituacaoPedido="EM DIGITAÇÃO";e.IdStatusPedido=1;e.DataFim=t[0];e.HoraFim=t[1];e.Completo=false;e=o.onFormatNumberPedido(e);delete e.__metadata;new Promise(function(t,i){o.onInserirPedido(e,t,i,o)}).then(function(t){o.byId("table_pedidos").setBusy(false);o.getModelGlobal("modelAux").setProperty("/NrPedido",e.NrPedido);o.getModelGlobal("modelAux").setProperty("/NrPedido",i.NrPedido);sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")}).catch(function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)})}).catch(function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)})}}else if(e=="Visualizar"){o.getModelGlobal("modelAux").setProperty("/NrPedido",i.NrPedido);sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")}else{o.getModelGlobal("modelAux").setProperty("/NrPedido","")}}})}else{o.getModelGlobal("modelAux").setProperty("/NrPedido",i.NrPedido);sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")}},onInicializaModels:function(){this.byId("master").setBusy(true);this.getModelGlobal("modelAux").setProperty("/NrPedCli","");this.getModelGlobal("modelAux").setProperty("/Kunnr","");this.oModel=this.getView().getModel();var e={Kunnr:"",Name1:"Nenhum cliente selecionado",Stcd1:"",Stcd2:""};var o=new sap.ui.model.json.JSONModel(e);this.setModel(o,"Cliente");this.setModelGlobal(o,"Cliente_G");var t=new a;this.setModel(t,"Pedidos");this.getModelGlobal("modelAux").setProperty("/NrPedido","")},onNavBack:function(){sap.ui.core.UIComponent.getRouterFor(this).navTo("menu")},formatRentabilidade:function(e){if(e==0){this.byId("table_pedidos").getColumns()[7].setVisible(false);return e}else if(e>-3){this.byId("table_pedidos").getColumns()[7].setVisible(false);return""}else{this.byId("table_pedidos").getColumns()[7].setVisible(true);return e+"%"}},onAfterRendering:function(){var e=this.getSplitContObj(),o=e.getDomRef()&&e.getDomRef().parentNode;if(o&&!o._sapui5_heightFixed){o._sapui5_heightFixed=true;while(o&&o!==document.documentElement){var t=jQuery(o);if(t.attr("data-sap-ui-root-content")){break}if(!o.style.height){o.style.height="100%"}o=o.parentNode}}},getSplitContObj:function(){var e=this.byId("SplitCont");if(!e){jQuery.sap.log.error("SplitApp object can't be found")}return e},onPressNavToDetail:function(){this.getSplitContObj().to(this.createId("detailDetail"))},navBack2:function(){var e=this.getOwnerComponent().getModel("modelAux").getProperty("/isTablet");if(e==true){sap.ui.core.UIComponent.getRouterFor(this).navTo("menu")}else{this.byId("listClientes").removeSelections(true);this.onPressDetailBack()}},onPressDetailBack:function(){this.getSplitContObj().backDetail()},onSelectionChange:function(e){var o=this;o.vetorPedidos=[];this.byId("table_pedidos").setBusy(true);var t=e.getParameter("listItem")||e.getSource();var i=t.getBindingContext("Clientes").getObject();o.getModelGlobal("Cliente_G").setData(i);this.getModelGlobal("modelAux").setProperty("/Usuario",i.Lifnr);this.getModelGlobal("modelAux").setProperty("/Lifnr",i.Lifnr);this.getSplitContObj().toDetail(this.createId("detail"));this.oModel.read("/P_PedidoQ",{urlParameters:{$filter:"IvUsuario eq '"+this.getModelGlobal("modelAux").getProperty("/Usuario")+"' and IvKunnr eq '"+i.Kunnr+"'"},success:function(e){o.vetorPedidos=e.results;var t=new a(o.vetorPedidos);o.getView().setModel(t,"Pedidos");o.byId("table_pedidos").setBusy(false)},error:function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)}});this.getSplitContObj().toDetail(this.createId("detail"))},onSearch:function(e){var o=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Ort01",sap.ui.model.FilterOperator.Contains,o),new sap.ui.model.Filter("Regio",sap.ui.model.FilterOperator.StartsWith,o),new sap.ui.model.Filter("Stcd1",sap.ui.model.FilterOperator.StartsWith,o),new sap.ui.model.Filter("Stcd2",sap.ui.model.FilterOperator.StartsWith,o)];var s=new sap.ui.model.Filter(i,false);t.push(s);this.byId("listClientes").getBinding("items").filter(t,"Application")},onAddPedido:function(){var e="";var o=this;var t=this.getModel("Cliente").getData();if(t.Kunnr==""){r.show("Nenhum cliente selecionado! Selecione um cliente!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Nenhum cliente selecionado",actions:[r.Action.OK]})}else{this.oModel.read("/P_CheckPedidoR(IvUsuario='"+this.getModelGlobal("modelAux").getProperty("/Usuario")+"',IvKunnr='"+t.Kunnr+"')",{success:function(t){e=t;if(e.TipoErro=="S"&&e.MsgErro==""){sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")}else{var i=new Date;var s=o.getModel("Cliente").getData().RegimeEspecial;if(s!==null&&i>s){r.show("Cliente com a Data do Regime expirada. Entre em contato com o comercial e com o cliente! ",{icon:sap.m.MessageBox.Icon.WARNING,title:"Data Regime Expirada!",actions:["OK"],onClose:function(e){}})}else if(e.TipoErro=="S"&&e.MsgErro!=""){r.show(e.MsgErro,{icon:sap.m.MessageBox.Icon.WARNING,title:"Alerta de pendências!",actions:["Ver Título","Continuar","Cancelar"],onClose:function(t){if(t=="Ver Titulo"){o.getModelGlobal("modelAux").setProperty("/Kunnr",e.IvKunnr);sap.ui.core.UIComponent.getRouterFor(o).navTo("relatorioTitulos")}else if(t=="Continuar"){sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")}}})}else{r.show(e.MsgErro,{icon:sap.m.MessageBox.Icon.ERROR,title:"Bloqueio de digitação!",actions:["OK"],onClose:function(e){}})}}},error:function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)}})}},onItemPress:function(e){var o=this;var t=e.getParameter("listItem")||e.getSource();var i=t.getBindingContext("Pedidos").getProperty("NrPedido");var s=t.getBindingContext("Pedidos").getObject();if(s.Usuario!=o.getModelGlobal("modelAux").getProperty("/CodRepres")&&(s.IdStatusPedido==1||s.IdStatusPedido==2)){r.show("Não é possível realizar a edição. Usuario criação: "+s.Usuario+", Usuario edição: "+o.getModelGlobal("modelAux").getProperty("/CodRepres")+".",{icon:r.Icon.ERROR,title:"Ação não permitida!",actions:[r.Action.OK]})}else{o.getModelGlobal("modelAux").setProperty("/NrPedido",i);sap.ui.core.UIComponent.getRouterFor(o).navTo("pedidoDetalhe")}},onExcluirPedido:function(e){var o=this;var t=false;var i=e.getParameter("listItem")||e.getSource();var s=i.getBindingContext("Pedidos").getObject();if(s.IdStatusPedido==3){var n="Não é possível deletar pedidos que já foram integrados!";r.error(n,{icon:r.Icon.ERROR,title:"Deleção de pedido.",actions:[sap.m.MessageBox.Action.OK]})}else if(s.Usuario!=o.getModelGlobal("modelAux").getProperty("/CodRepres")){r.show("Não é possível realizar a edição. Usuario criação: "+s.Usuario+", Usuario edição: "+o.getModelGlobal("modelAux").getProperty("/CodRepres")+".",{icon:r.Icon.ERROR,title:"Ação não permitida!",actions:[r.Action.OK]})}else{r.show("Deseja mesmo excluir o pedido?",{icon:r.Icon.WARNING,title:"Exclusão de Pedidos",actions:[r.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){o.byId("table_pedidos").setBusy(true);new Promise(function(e,t){o.onExcluirPed(s.NrPedido,e,t)}).then(function(){var e=o.getModelGlobal("Cliente_G").getData();var t=o.getModelGlobal("modelAux").getProperty("/CodRepres");var i=false;new Promise(function(s,r){o.onBuscarPedidos(e.Kunnr,t,i,s,r,o)}).then(function(e){o.vetorPedidos=e;var t=new a(o.vetorPedidos);o.getView().setModel(t,"Pedidos");o.byId("table_pedidos").setBusy(false)}).catch(function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)})}).catch(function(e){o.byId("table_pedidos").setBusy(false);o.onMensagemErroODATA(e)})}}})}},handleLinkPress:function(){var e=this.getOwnerComponent().getModel("modelAux").getProperty("/CodCliente");this.getOwnerComponent().getModel("modelAux").setProperty("/telaPedido",true);sap.ui.core.UIComponent.getRouterFor(this).navTo("relatorioTitulos")}})});
//# sourceMappingURL=Pedido.controller.js.map