sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/m/MessageBox"],function(e,o,t,r,n){"use strict";return e.extend("application.controller.relatorioTabelas",{onInit:function(){this.getRouter().getRoute("relatorioTabelas").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;var t=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.oModel=e.getModelGlobal("modelAux").getProperty("/DBModel");this.onInicializarModels();e.oModel.read("/Centros",{urlParameters:{$filter:"IvUsuario eq '"+t+"'"},success:function(t){e.vetorCentros=t.results;var r=new o(e.vetorCentros);e.setModel(r,"modelCentros")},error:function(o){e.onMensagemErroODATA(o)}});e.oModel.read("/Vencimentos",{success:function(t){e.vetorVencimentos=t.results;var r=new o(e.vetorVencimentos);e.setModel(r,"modelVencimentos")},error:function(o){e.onMensagemErroODATA(o)}});e.oModel.read("/Fretes",{success:function(t){var r=t.results;var n=new o(r);e.setModel(n,"modelFretes")},error:function(o){e.onMensagemErroODATA(o)}})},onInicializarModels:function(){var e=this;var t={Exibicao:"Caixa",Pltyp:"",Indice:0,Contrato:"",Vencimento:"",Werks:"",Kunnr:"",Inco1:"",UFOrigem:"",UFDestino:"",Kvgr2:"",DescKvgr2:""};var r=new o(t);this.setModelGlobal(r,"modelTela");this.vetorFretes=[];this.vetorCentros=[];this.vetorCentro={};this.vetorClientes=[];this.vetorTabPrecos=[];this.vetorContratos=[];this.vetorVencimentos=[];this.vetorUnidadeMedida=[];this.vetorEstabelecimento=[];var n=[];var l=new o(this.vetorCentros);this.setModel(l,"modelCentros");var s=new o(this.vetorCentro);this.setModelGlobal(s,"modelCentro");var a=new o(this.vetorVencimentos);this.setModel(a,"modelVencimentos");var i=new o(e.vetorTabPrecos);e.setModel(i,"modelTabPrecos");var d=new o(e.vetorContratos);e.setModelGlobal(d,"modelContratos");var c=new o(e.vetorFretes);e.setModel(c,"modelFretes");var t={idExibicao:"Caixa",descricao:"Caixa"};var m={idExibicao:"Unidade",descricao:"Unidade"};n.push(t);n.push(m);var g=new sap.ui.model.json.JSONModel(n);e.getOwnerComponent().setModel(g,"ComboExibicao")},onCarregarPrecos:function(){var e=this;var o=this.getModelGlobal("modelTela").getData();if(o.Werks==""){sap.m.MessageBox.show("Escolha o estabelecimento!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idEstabelecimento").focus()}})}else if(o.Kunnr==""){sap.m.MessageBox.show("Preencher o cliente!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idCliente").focus()}})}else if(o.Pltyp==""){sap.m.MessageBox.show("Preencher a tabela de preço!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTabelaPreco").focus()}})}else if(o.Vencimento==""){sap.m.MessageBox.show("Preencher a data pagamento!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTabelaPreco").focus()}})}else if(o.Inco1==""){sap.m.MessageBox.show("Preencher o Tipo de Transporte!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTipoTransporte").focus()}})}else{sap.m.MessageBox.show("O tipo de frete escolhido é "+o.Inco1+". Deseja continuar?",{icon:sap.m.MessageBox.Icon.WARNING,title:"Confirmação de campo(s)",actions:[t.Action.YES,t.Action.CANCEL],onClose:function(o){if(o==t.Action.YES){sap.ui.core.UIComponent.getRouterFor(e).navTo("detalhesRelatorioTabelas")}}})}},myFormatterDataVencimento:function(e){if(e.length===1){e="0"+e}},onChangeEstabelecimento:function(e){var t=this;var r=e.getSource().getSelectedKey();var n=t.getModelGlobal("modelAux").getProperty("/CodRepres");t.oModel=t.getModelGlobal("modelAux").getProperty("/DBModel");for(var l=0;l<this.vetorCentros.length;l++){if(r==this.vetorCentros[l].Werks){this.getModelGlobal("modelCentro").setData(this.vetorCentros[l]);t.getModelGlobal("modelTela").setProperty("/UFOrigem",this.vetorCentros[l].Regio);break}}new Promise(function(e,o){t.onBuscarClientes(n,e,o,t)}).then(function(e){var r=e;var n=new o(r);t.setModel(n,"modelClientes");t.getModelGlobal("modelTela").setProperty("/Kunnr","");t.getModelGlobal("modelTela").setProperty("/Vencimento","");t.getModelGlobal("modelTela").setProperty("/Indice",0);t.getModelGlobal("modelTela").setProperty("/Contrato","");t.getModelGlobal("modelTela").setProperty("/Pltype","");t.getModelGlobal("modelTela").setProperty("/UFDestino","");t.getModelGlobal("modelTela").setProperty("/Kvgr2","");t.getModelGlobal("modelTela").setProperty("/DescKvgr2","");t.byId("idCliente").focus()}).catch(function(e){t.onMensagemErroODATA(e)})},onChangeCliente:function(e){var t=this;new Promise(function(e,r){var n=t.getModelGlobal("modelAux").getProperty("/CodRepres");var l=t.getModelGlobal("modelTela").getProperty("/Kunnr");t.oModel.read("/ClienteR(IvUsuario='"+n+"',IvCliente='"+l+"')",{success:function(r){t.vetorCliente=r;var n=new o(t.vetorCliente);t.setModelGlobal(n,"modelCliente");var l=new o(t.vetorTabPrecos);t.setModel(l,"modelTbPreco");var s={Kunnr:r.Kunnr,Name1:r.Name1,Pltyp:r.Pltyp,Ptext:r.DescPltyp};t.vetorTabPrecos.push(s);t.getModel("modelTbPreco").setData(t.vetorTabPrecos);t.getModelGlobal("modelTela").setProperty("/Pltyp",t.vetorTabPrecos[0].Pltyp);t.getModelGlobal("modelTela").setProperty("/UFDestino",r.Regio);t.getModelGlobal("modelTela").setProperty("/Kvgr2",r.Kvgr2);t.getModelGlobal("modelTela").setProperty("/DescKvgr2",r.Kvgr2+" - "+r.DescKvgr2);e()},error:function(e){t.onMensagemErroODATA(e);r()}})}).then(function(e){t.onBuscarContrato()}).catch(function(e){t.onMensagemErroODATA(e)})},onBuscarContrato:function(){var e=this;var t=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.getModelGlobal("modelTela").setProperty("/Vencto","");e.getModelGlobal("modelTela").setProperty("/Indice",0);e.vetorVencimentos=[];e.vetorContratos=[];e.oModel.read("/Vencimentos",{success:function(t){e.vetorVencimentos=t.results;var r=new o(e.vetorVencimentos);e.setModel(r,"modelVencimentos")},error:function(o){e.onMensagemErroODATA(o)}});e.oModel.read("/P_ContratoR(IvBukrs='"+e.getModelGlobal("modelCentro").getProperty("/Bukrs")+"',IvKvgr4='"+e.getModelGlobal("modelCliente").getProperty("/Kvgr4")+"')",{success:function(o){e.byId("idContrato").setBusy(false);e.byId("idVencimento").setBusy(false);var t=e.getModel("modelVencimentos").getData();var r=[];if(o.ContratoInterno!=""){var n="false";var l=0;for(var s=0;s<t.length;s++){if(t[s].Zterm==o.Zterm){n="true";if(String(o.AtlOrdem)=="true"){e.getModelGlobal("modelTela").setProperty("/Indice",o.IndiceContrato)}else{e.getModelGlobal("modelTela").setProperty("/Indice",t[s].Kbetr)}break}}if(n=="false"){var a={Zterm:o.Zterm,IdVencimento:o.Zterm,DescCond:o.DescCond};r.push(a);e.getModel("modelVencimentos").setData(r);if(String(o.AtlOrdem)=="true"){e.getModelGlobal("modelTela").setProperty("/Indice",o.IndiceContrato)}else{e.getModelGlobal("modelTela").setProperty("/Indice",0)}}if(e.getModelGlobal("modelTela").getProperty("/Vencimento")==""){e.byId("idVencimento").setEnabled(true)}else{e.byId("idVencimento").setEnabled(false)}e.getModelGlobal("modelTela").setProperty("/Vencimento",o.Zterm);e.byId("idVencimento").setEnabled(false)}else{e.byId("idVencimento").setEnabled(true)}},error:function(o){e.onMensagemErroODATA(o)}})},onChangeVencimento:function(e){var o=this;var t=e.getSource().getSelectedKey();var r=o.getModelGlobal("modelAux").getProperty("/CodRepres");o.oModel=o.getModelGlobal("modelAux").getProperty("/DBModel");for(var n=0;n<this.vetorVencimentos.length;n++){if(this.vetorVencimentos[n].Zterm==t){o.getModelGlobal("modelTela").setProperty("/Indice",parseFloat(this.vetorVencimentos[n].Kbetr))}}},_handleValueHelpSearch:function(e){var o=e.getSource().getValue();var t=[];var r=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.StartsWith,o),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,o)];var n=new sap.ui.model.Filter(r,false);t.push(n);if(this.byId("idCliente").getBinding("suggestionItems")!=undefined){this.byId("idCliente").getBinding("suggestionItems").filter(t);this.byId("idCliente").suggest()}}})});