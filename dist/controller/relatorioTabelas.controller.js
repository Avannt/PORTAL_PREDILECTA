sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","application/model/formatter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV"],function(e,t,o,a){"use strict";var n=[];var i=[];var l=[];var r=[];var s=[];var d=[];var c=[];var m=[];var u=0;var g=0;var p=0;return e.extend("application.controller.relatorioTabelas",{onInit:function(){this.getRouter().getRoute("relatorioTabelas").attachPatternMatched(this._onLoadFields,this)},_handleValueHelpSearch:function(e){var t=e.getSource().getValue();var o=[];var a=[new sap.ui.model.Filter("CodCliente",sap.ui.model.FilterOperator.StartsWith,t),new sap.ui.model.Filter("NomeEmit",sap.ui.model.FilterOperator.Contains,t)];var n=new sap.ui.model.Filter(a,false);o.push(n);this.byId("idtabClienteRelatorio").getBinding("suggestionItems").filter(o);this.byId("idtabClienteRelatorio").suggest()},_onLoadFields:function(){var e=this;var o=[];n=[];i=[];l=[];r=[];s=[];var a=[];e.byId("idIndice").setValue();e.byId("idtabClienteRelatorio").setValue();e.byId("idEstabelecimento").setSelectedKey();e.getView().byId("idVencimento1").setSelectedKey();e.getView().byId("idVencimento2").setSelectedKey();e.getView().byId("idVencimento3").setSelectedKey();var d=new sap.ui.model.json.JSONModel(n);e.getView().setModel(d);e.getOwnerComponent().setModel(d,"modelRelatorioTabela");var c={idExibicao:1,descricao:"Caixa"};var m={idExibicao:2,descricao:"Unidade"};a.push(c);a.push(m);d=new sap.ui.model.json.JSONModel(a);e.getOwnerComponent().setModel(d,"ComboExibicao");e.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/exibicao",a[0].idExibicao);e.byId("idExibicao").setSelectedKey(a[0].idExibicao);var u=indexedDB.open("VB_DataBase");u.onerror=function(){t.show(u.error.mensage,{icon:t.Icon.ERROR,title:"Banco não encontrado!",actions:[t.Action.OK]})};u.onsuccess=function(){var t=u.result;var a=e.getOwnerComponent().getModel("modelAux").getProperty("/IdBase");var n=t.transaction("Clientes").objectStore("Clientes");n.openCursor().onsuccess=function(i){var l=i.target.result;if(l){if(l.value.IdBase==a){o.push(l.value)}l.continue()}else{d=new sap.ui.model.json.JSONModel(o);e.getView().setModel(d,"tabCliente");n=t.transaction("Estabelecimento").objectStore("Estabelecimento");n.openCursor().onsuccess=function(t){l=t.target.result;if(l){if(l.value.IdBase==a){s.push(l.value)}l.continue()}else{d=new sap.ui.model.json.JSONModel(s);e.getView().setModel(d,"ComboEstabelecimento")}}}}}},myFormatterDataVencimento:function(e){if(e.length===1){e="0"+e}},onChangeEstabelecimento:function(){var e=this;i=[];l=[];r=[];var o=e.byId("idEstabelecimento").getSelectedKey();e.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/estabelecimento",o);var a=e.getOwnerComponent().getModel("modelAux").getProperty("/IdBase");var n=indexedDB.open("VB_DataBase");n.onerror=function(){t.show(n.error.mensage,{icon:t.Icon.ERROR,title:"Banco não encontrado!",actions:[t.Action.OK]})};n.onsuccess=function(){var t=n.result;var l=t.transaction("Vencimento").objectStore("Vencimento");l.openCursor().onsuccess=function(t){var n=t.target.result;if(n){if(n.value.CodEstabel==o&&n.value.IdBase==a){i.push(n.value)}n.continue()}else{var l=new sap.ui.model.json.JSONModel(i);e.getView().setModel(l,"ComboVencimento1")}}};for(var d=0;d<s.length;d++){if(o==s[d].CodEstabel){e.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/origEstabel",s[d].Estado)}}},onChangeExibicao:function(){var e=this.byId("idExibicao").getSelectedKey();this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/exibicao",e)},onClienteChange:function(e){var t=this;n=[];s=[];d=[];c=[];m=[];t.getView().byId("idVencimento1").setSelectedKey();t.getView().byId("idVencimento2").setSelectedKey();t.getView().byId("idVencimento3").setSelectedKey();t.getView().byId("idIndice").setValue();var o=new sap.ui.model.json.JSONModel(i);t.getView().setModel(o,"ComboVencimento1");var a=this.byId("idtabClienteRelatorio").getValue();t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/cliente",a);var l=indexedDB.open("VB_DataBase");l.onerror=function(){console.log("não foi possivel encontrar e/ou carregar a base de clientes")};l.onsuccess=function(){var e=l.result;var o=t.getOwnerComponent().getModel("modelAux").getProperty("/IdBase");var r=t.byId("idEstabelecimento").getSelectedKey();var s=e.transaction("TabPrecoCliente").objectStore("TabPrecoCliente");s.openCursor().onsuccess=function(l){var u=l.target.result;if(u){if(u.value.CodCliente==a&&u.value.IdBase==o&&u.value.CodEstabel==r){n.push(u.value)}u.continue()}else{var g=new sap.ui.model.json.JSONModel(n);t.getView().setModel(g);t.byId("idTabelaPreco").setSelectedKey(n[0].NrTabPreco);t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/tabelaPreco",n[0].NrTabPreco);var p=n[0].NrTabPreco;s=e.transaction("TabelaPreco").objectStore("TabelaPreco");s.openCursor().onsuccess=function(n){var l=n.target.result;if(l){if(l.value.NrTabPreco==p&&l.value.IdBase==o){t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/canal",l.value.PctDescCanal)}l.continue()}else{s=e.transaction("ContratoCliente").objectStore("ContratoCliente");s.openCursor().onsuccess=function(e){var n=e.target.result;if(n){if(n.value.CodCliente==a&&n.value.CodEstabel==r&&n.value.IdBase==o){t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/contrato",n.value.PctDescContrato);t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/indice",n.value.PctDescFinan);var l={CodCliente:n.value.CodCliente,CodContrato:n.value.CodContrato,CodEstabel:n.value.CodEstabel,CodUnidNegoc:n.value.CodUnidNegoc,IdBase:n.value.IdBase,NomEstabel:n.value.NomEstabel,PctDescContrato:n.value.PctDescContrato,PctDescFinan:n.value.PctDescFinan,QtdDias:n.value.QtdDias1,QtdDias1:n.value.QtdDias1,QtdDias2:n.value.QtdDias2,QtdDias3:n.value.QtdDias3,UnidadeNegocio:n.value.UnidadeNegocio,idContratoCliente:n.value.idContratoCliente};d.push(l);l={CodCliente:n.value.CodCliente,CodContrato:n.value.CodContrato,CodEstabel:n.value.CodEstabel,CodUnidNegoc:n.value.CodUnidNegoc,IdBase:n.value.IdBase,NomEstabel:n.value.NomEstabel,PctDescContrato:n.value.PctDescContrato,PctDescFinan:n.value.PctDescFinan,QtdDias:n.value.QtdDias2,QtdDias1:n.value.QtdDias1,QtdDias2:n.value.QtdDias2,QtdDias3:n.value.QtdDias3,UnidadeNegocio:n.value.UnidadeNegocio,idContratoCliente:n.value.idContratoCliente};c.push(l);l={CodCliente:n.value.CodCliente,CodContrato:n.value.CodContrato,CodEstabel:n.value.CodEstabel,CodUnidNegoc:n.value.CodUnidNegoc,IdBase:n.value.IdBase,NomEstabel:n.value.NomEstabel,PctDescContrato:n.value.PctDescContrato,PctDescFinan:n.value.PctDescFinan,QtdDias:n.value.QtdDias3,QtdDias1:n.value.QtdDias1,QtdDias2:n.value.QtdDias2,QtdDias3:n.value.QtdDias3,UnidadeNegocio:n.value.UnidadeNegocio,idContratoCliente:n.value.idContratoCliente};m.push(l);if(d[0].QtdDias==1&&c[0].QtdDias==2&&m[0].QtdDias==3){d=[];c=[];m=[];var s=new sap.ui.model.json.JSONModel(i);t.getView().setModel(s,"ComboVencimento1")}else{s=new sap.ui.model.json.JSONModel(d);t.getView().setModel(s,"ComboVencimento1");s=new sap.ui.model.json.JSONModel(c);t.getView().setModel(s,"ComboVencimento2");s=new sap.ui.model.json.JSONModel(m);t.getView().setModel(s,"ComboVencimento3");t.getView().byId("idVencimento1").setSelectedKey(d[0].QtdDias);t.getView().byId("idVencimento2").setSelectedKey(c[0].QtdDias);t.getView().byId("idVencimento3").setSelectedKey(m[0].QtdDias);t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento1",d[0].QtdDias);t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento2",c[0].QtdDias);t.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento3",m[0].QtdDias);t.getView().byId("idIndice").setValue(t.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/indice"))}}n.continue()}}}};t.byId("idLoadTabelaPreco").focus()}}}},onChangeTabelaPreco:function(e){var o=this;o.byId("idLoadTabelaPreco").focus();var a=indexedDB.open("VB_DataBase");a.onerror=function(){t.show(a.error.mensage,{icon:t.Icon.ERROR,title:"Banco não encontrado!",actions:[t.Action.OK]})};a.onsuccess=function(){var e=a.result;var t=o.getOwnerComponent().getModel("modelAux").getProperty("/IdBase");var n=o.byId("idEstabelecimento").getSelectedKey();var i=o.byId("idTabelaPreco").getSelectedKey();o.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/tabelaPreco",i);var l=e.transaction("TabelaPreco").objectStore("TabelaPreco");l.openCursor().onsuccess=function(e){var a=e.target.result;if(a){if(a.value.NrTabPreco==i&&a.value.IdBase==t){o.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/canal",a.value.PctDescCanal)}a.continue()}}}},onChangeVencimento1:function(){u=0;g=0;p=0;this.byId("idLoadTabelaPreco").focus();l=[];r=[];this.getView().byId("idVencimento2").setSelectedKey();this.getView().byId("idVencimento3").setSelectedKey();var e=this.byId("idVencimento1").getSelectedKey();this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento1",e);this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento2",0);this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento3",0);this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/indice",0);for(var t=0;t<i.length;t++){if(parseFloat(this.getView().byId("idVencimento1").getSelectedKey())==1){u=parseFloat(i[t].PctDescFinan);this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/indice",u);break}else{if(parseInt(i[t].QtdDias)>this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/vencimento1")){this.byId("idVencimento2").setProperty("enabled",true);l.push(i[t])}if(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/vencimento1")==parseInt(i[t].QtdDias)){u=parseFloat(i[t].PctDescFinan);this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/indice",Math.round(parseFloat(u)*100)/100)}}}var o=new sap.ui.model.json.JSONModel(l);this.getView().setModel(o,"ComboVencimento2");this.byId("idIndice").setValue(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/indice"))},onChangeVencimento2:function(){g=0;p=0;r=[];this.byId("idLoadTabelaPreco").focus();this.getView().byId("idVencimento3").setSelectedKey();var e=parseInt(this.getView().byId("idVencimento2").getSelectedKey());this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento3",0);this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento2",e);for(var t=0;t<l.length;t++){if(parseInt(l[t].QtdDias)>e){this.byId("idVencimento2").setProperty("enabled",true);r.push(l[t])}if(parseInt(l[t].QtdDias)==parseInt(e)){g=parseFloat(l[t].PctDescFinan);var o=(u+g)/2;this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/indice",Math.round(parseFloat(o)*100)/100)}}this.byId("idVencimento3").setProperty("enabled",true);var a=new sap.ui.model.json.JSONModel(r);this.getView().setModel(a,"ComboVencimento3");this.byId("idIndice").setValue(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/indice"))},onChangeVencimento3:function(){p=0;this.byId("idLoadTabelaPreco").focus();var e=parseInt(this.byId("idVencimento1").getSelectedKey());var t=parseInt(this.byId("idVencimento2").getSelectedKey());var o=parseInt(this.byId("idVencimento3").getSelectedKey());this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/vencimento3",o);for(var a=0;a<i.length;a++){if(parseInt(i[a].QtdDias)==parseInt(e)){u=parseFloat(i[a].PctDescFinan);var n=i[a].QtdDias;var l=i[a].CodEstabel}if(parseInt(i[a].QtdDias)==parseInt(t)){g=parseFloat(i[a].PctDescFinan);var r=i[a].QtdDias;var s=i[a].CodEstabel}if(parseInt(i[a].QtdDias)==parseInt(o)){p=parseFloat(i[a].PctDescFinan);var d=i[a].QtdDias;var c=i[a].CodEstabel}}var m=(u+g+p)/3;this.getOwnerComponent().getModel("modelRelatorioTabela").setProperty("/indice",Math.round(parseFloat(m)*100)/100);this.byId("idIndice").setValue(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/indice"))},loadTabelaPreco:function(){console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/indice"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/vencimento1"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/vencimento2"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/vencimento3"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/cliente"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/estabelecimento"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/tabelaPreco"));console.log(this.getOwnerComponent().getModel("modelRelatorioTabela").getProperty("/canal"));sap.ui.core.UIComponent.getRouterFor(this).navTo("detalhesRelatorioTabelas")},onDataExport:sap.m.Table.prototype.exportData||function(e){var o=new sap.ui.model.json.JSONModel(n);this.getView().setModel(o);var a=new sap.ui.core.util.Export({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:";"}),models:o,rows:{path:"/"},columns:[{name:"Cod Cliente",template:{content:"{CodCliente}"}},{name:"Cod Estabel",template:{content:"{CodEstabel}"}},{name:"Nome Estabel",template:{content:"{NomEstabel}"}},{name:"Nº Tab Preço",template:{content:"{NrTabPreco}"}},{name:"Desc. Tabela",template:{content:"{DescTabela}"}},{name:"Juros",template:{content:"{ValSdoTitAcr}"}}]});a.saveFile().catch(function(e){t.error("Error when downloading data. Browser might not be supported!\n\n"+e)}).then(function(){a.destroy()})}})});