sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","application/model/formatter","sap/ui/core/util/MockServer","sap/ui/export/library","sap/ui/export/Spreadsheet","sap/ui/model/odata/v2/ODataModel"],function(e,r,t,a,i,o,s,n){"use strict";var l=[];var u=o.EdmType;return e.extend("application.controller.relatorioFaturamentoItens",{onInit:function(){this.getRouter().getRoute("relatorioFaturamentoItens").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;var t=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.oModel=e.getModelGlobal("modelAux").getProperty("/DBModel");var a={WerksIni:"",WerksFim:"",KunnrIni:"",KunnrFim:"",Kvgr4Ini:"",Kvgr4Fim:"",Kvgr5Ini:"",Kvgr5Fim:"",VBelnIni:"",VBelnFim:"",RepreIni:"",RepreFim:"",MatnrIni:"",MatnrFim:"",Mvgr1Ini:"",Mvgr1Fim:"",Mvgr2Ini:"",Mvgr2Fim:"",Mvgr3Ini:"",Mvgr3Fim:"",Mvgr5Ini:"",Mvgr5Fim:"",Periodo:""};var i=new r(a);e.setModel(i,"modelParametros");e.vetorFatItems=[];var o=new r(e.vetorFatItems);e.setModel(o,"modelFatItens");e.vetorResumoEmpresa=[];var s=new r(e.vetorResumoEmpresa);e.setModel(s,"modelResumoEmpresa");new Promise(function(r,a){e.onBuscarClientes(t,r,a,e)}).then(function(t){var a=t;var i=[];var o=[];var s=[];for(var n=0;n<a.length;n++){var l=false;var u=false;var g=false;for(var d=0;d<i.length;d++){if(a[n].Kvgr4==i[d].Kvgr4||a[n].Kvgr4==""){l=true;break}}for(var p=0;p<o.length;p++){if(a[n].Kvgr5==o[p].Kvgr5||a[n].Kvgr5==""){u=true;break}}for(var m=0;m<s.length;m++){if(a[n].Lifnr==s[m].Lifnr||a[n].Lifnr==""){g=true;break}}if(l==false){i.push(a[n])}if(u==false){o.push(a[n])}if(g==false){s.push(a[n])}}var v=new r(a);e.setModel(v,"modelClientes");var F=new r(i);e.setModel(F,"modelRedes");var M=new r(o);e.setModel(M,"modelBandeiras");var I=new r(s);e.setModel(I,"modelRepres")}).catch(function(r){e.onMensagemErroODATA(r)});new Promise(function(r,a){e.onBuscarProdutos(t,r,a,e)}).then(function(t){var a=t;var i=[];var o=[];var s=[];var n=[];for(var l=0;l<a.length;l++){var u=false;var g=false;var d=false;var p=false;for(var m=0;m<i.length;m++){if(a[l].Mvgr1==i[m].Mvgr1||a[l].Mvgr1==""){u=true;break}}for(var v=0;v<o.length;v++){if(a[l].Mvgr2==i[v].Mvgr2||a[l].Mvgr2==""){g=true;break}}for(var F=0;F<s.length;F++){if(a[l].Mvgr3==s[F].Mvgr3||a[l].Mvgr3==""){d=true;break}}for(var M=0;M<n.length;M++){if(a[l].Mvgr5==n[M].Mvgr5||a[l].Mvgr5==""){p=true;break}}if(u==false){i.push(a[l])}if(g==false){o.push(a[l])}if(d==false){s.push(a[l])}if(p==false){n.push(a[l])}}var I=new r(a);e.setModel(I,"modelMaterial");var f=new r(i);e.setModel(f,"modelCategoria");var c=new r(o);e.setModel(c,"modelSubCategoria");var h=new r(s);e.setModel(h,"modelFamilia");var y=new r(n);e.setModel(y,"modelMarca")}).catch(function(r){e.onMensagemErroODATA(r)});e.oModel.read("/Centros",{urlParameters:{$filter:"IvUsuario eq '"+t+"'"},success:function(t){var a=t.results;var i=new r(a);e.setModel(i,"modelCentros")},error:function(r){e.onMensagemErroODATA(r)}})},ongetHeaderGroupLifnr:function(e){return e.getProperty("Lifnr")},ongetHeaderGroupBukrs:function(e){return e.getProperty("Bukrs")+" - "+e.getProperty("Butxt")},createColumnConfig:function(){var e=[];e.push({label:"Repres",property:"Lifnr",type:u.Number});e.push({label:"Nome Repres",property:"Name1Rep",type:u.String});e.push({label:"Empresa",property:"Bukrs",type:u.String});e.push({label:"Nome Empresa",property:"Butxt",type:u.String});e.push({label:"Material",property:"Matnr",type:u.String});e.push({label:"Descrição Material",property:"Maktx",type:u.String});e.push({label:"UM",property:"Meins",type:u.String});e.push({label:"Categoria",property:"Mvgr1",type:u.String});e.push({label:"Descrição Categoria",property:"Mvgr1Text",type:u.String});e.push({label:"SubCategoria",property:"Mvgr2",type:u.String});e.push({label:"Descrição SubCategoria",property:"Mvgr2Text",type:u.String});e.push({label:"Família",property:"Mvgr3",type:u.String});e.push({label:"Descrição Família",property:"Mvgr3Text",type:u.String});e.push({label:"Marca",property:"Mvgr5",type:u.String});e.push({label:"Descrição Marca",property:"Mvgr5Text",type:u.String});e.push({label:"Qtd Faturada",property:"QtdFaturada",type:u.Number,scale:2,delimiter:true});e.push({label:"Vlr Faturado",property:"ValFaturado",type:u.Number,scale:2,delimiter:true});e.push({label:"%Partic.",property:"PctPartic",type:u.Number,scale:2,delimiter:true});e.push({label:"Qtde Pedidos",property:"QtdPedidos",type:u.Number,scale:0,delimiter:true});e.push({property:"PctRentab",type:u.Number,scale:2,delimiter:true});e.push({property:"UltPreco",type:u.Number,scale:2,delimiter:true});e.push({property:"MedPreco",type:u.Number,scale:2,delimiter:true});return e},onExport:function(){var e,r,t,a,i;if(!this._oTable){this._oTable=this.byId("idtableFatItens")}i=this._oTable;r=i.getBinding("items");e=this.createColumnConfig();t={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:r,fileName:"Rel_Fat_Item.xlsx",worker:false};a=new s(t);a.build().finally(function(){a.destroy()})},onSuggestCentroIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("NomeCentro",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idCentroIni").getBinding("suggestionItems").filter(t);this.byId("idCentroIni").suggest()},onPressBtnFiltrar:function(){var e=this;var r=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.oModel=e.getModelGlobal("modelAux").getProperty("/DBModel");var t=e.getModel("modelParametros").getProperty("/WerksIni");var a=e.getModel("modelParametros").getProperty("/WerksFim");var i=e.getModel("modelParametros").getProperty("/KunnrIni");var o=e.getModel("modelParametros").getProperty("/KunnrFim");var s=e.getModel("modelParametros").getProperty("/Kvgr4Ini");var n=e.getModel("modelParametros").getProperty("/Kvgr4Fim");var l=e.getModel("modelParametros").getProperty("/Kvgr5Ini");var u=e.getModel("modelParametros").getProperty("/Kvgr5Fim");var g="";var d="";var p=e.getModel("modelParametros").getProperty("/LifnrIni");var m=e.getModel("modelParametros").getProperty("/LifnrFim");var v=e.getModel("modelParametros").getProperty("/MatnrIni");var F=e.getModel("modelParametros").getProperty("/MatnrFim");var M=e.getModel("modelParametros").getProperty("/Mvgr1Ini");var I=e.getModel("modelParametros").getProperty("/Mvgr1Fim");var f=e.getModel("modelParametros").getProperty("/Mvgr2Ini");var c=e.getModel("modelParametros").getProperty("/Mvgr2Fim");var h=e.getModel("modelParametros").getProperty("/Mvgr3Ini");var y=e.getModel("modelParametros").getProperty("/Mvgr3Fim");var b=e.getModel("modelParametros").getProperty("/Mvgr5Ini");var C=e.getModel("modelParametros").getProperty("/Mvgr5Fim");var w=e.getModel("modelParametros").getProperty("/Periodo");var P=w.split(" - ");var S=P[0];var B=P[1];e.oModel.read("/FatItens",{urlParameters:{$filter:"Usuario eq '"+r+"' and WerksIni eq '"+t+"' and WerksFim eq '"+a+"' and KunnrIni eq '"+i+"' and KunnrFim eq '"+o+"' and Kvgr4Ini eq '"+s+"' and Kvgr4Fim eq '"+n+"' and Kvgr5Ini eq '"+l+"' and Kvgr5Fim eq '"+u+"' and VbelnIni eq '"+g+"' and VbelnFim eq '"+d+"' and RepreIni eq '"+p+"' and RepreFim eq '"+m+"' and MatnrIni eq '"+v+"' and MatnrFim eq '"+F+"' and Mvgr1Ini eq '"+M+"' and Mvgr1Fim eq '"+I+"' and Mvgr2Ini eq '"+f+"' and Mvgr2Fim eq '"+c+"' and Mvgr3Ini eq '"+h+"' and Mvgr3Fim eq '"+y+"' and Mvgr5Ini eq '"+b+"' and Mvgr5Fim eq '"+C+"' and PerioIni eq '"+S+"' and PerioFim eq '"+B+"'"},success:function(r){e.vetorFatItems=[];e.vetorResumoEmpresa=[];e.vetorFatItems=r.results;e.getModel("modelFatItens").setData(e.vetorFatItems);var t=0;for(var a=0;a<e.vetorFatItems.length;a++){var i=false;for(var o=0;o<e.vetorResumoEmpresa.length;o++){if(e.vetorFatItems[a].Bukrs==e.vetorResumoEmpresa[o].Bukrs){i=true;e.vetorResumoEmpresa[o].ValFaturado=parseFloat(e.vetorResumoEmpresa[o].ValFaturado)+Math.round(parseFloat(e.vetorFatItems[a].ValFaturado)*100)/100;e.vetorResumoEmpresa[o].ValFaturado=parseFloat(e.vetorResumoEmpresa[o].ValFaturado).toFixed(2)}}if(i==false){var s={Bukrs:e.vetorFatItems[a].Bukrs,Butxt:e.vetorFatItems[a].Butxt,ValFaturado:parseFloat(e.vetorFatItems[a].ValFaturado)};e.vetorResumoEmpresa.push(s)}t+=parseFloat(e.vetorFatItems[a].ValFaturado)}if(t>0){var n={Bukrs:"",Butxt:"TOTAL",ValFaturado:parseFloat(t).toFixed(2)};e.vetorResumoEmpresa.push(n)}e.getModel("modelResumoEmpresa").setData(e.vetorResumoEmpresa)},error:function(r){e.onMensagemErroODATA(r)}})},onExpandFiltro:function(){if(this.byId("idPanelFiltro").getExpanded()){this.byId("idPanelFiltro").setHeaderText("Ocultar Filtros")}else{this.byId("idPanelFiltro").setHeaderText("Exibir Filtros")}},onSuggestCentroFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Werks",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("NomeCentro",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idCentroFim").getBinding("suggestionItems").filter(t);this.byId("idCentroFim").suggest()},onSuggestClienteIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idClienteIni").getBinding("suggestionItems").filter(t);this.byId("idClienteIni").suggest()},onSuggestClienteFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idClienteFim").getBinding("suggestionItems").filter(t);this.byId("idClienteFim").suggest()},onSuggestRedeIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Kvgr4",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr4",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idRedeIni").getBinding("suggestionItems").filter(t);this.byId("idRedeIni").suggest()},onSuggestRedeFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Kvgr4",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr4",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idRedeFim").getBinding("suggestionItems").filter(t);this.byId("idRedeFim").suggest()},onSuggestBandeiraIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Kvgr5",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr5",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idBandeiraIni").getBinding("suggestionItems").filter(t);this.byId("idBandeiraIni").suggest()},onSuggestBandeiraFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Kvgr5",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr5",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idBandeiraFim").getBinding("suggestionItems").filter(t);this.byId("idBandeiraFim").suggest()},onSuggestRepresIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1Rep",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idRepreIni").getBinding("suggestionItems").filter(t);this.byId("idRepreIni").suggest()},onSuggestRepresFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1Rep",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idRepreFim").getBinding("suggestionItems").filter(t);this.byId("idRepreFim").suggest()},onSuggestMaterialIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idMaterialIni").getBinding("suggestionItems").filter(t);this.byId("idMaterialIni").suggest()},onSuggestMaterialFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idMaterialFim").getBinding("suggestionItems").filter(t);this.byId("idMaterialFim").suggest()},onSuggestCategoriaIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr1",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr1",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idCategoriaIni").getBinding("suggestionItems").filter(t);this.byId("idCategoriaIni").suggest()},onSuggestCategoriaFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr1",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr1",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idCategoriaFim").getBinding("suggestionItems").filter(t);this.byId("idCategoriaFim").suggest()},onSuggestSubCategoriaIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr2",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr2",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idSubCategoriaIni").getBinding("suggestionItems").filter(t);this.byId("idSubCategoriaIni").suggest()},onSuggestSubCategoriaFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr2",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr2",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idSubCategoriaFim").getBinding("suggestionItems").filter(t);this.byId("idSubCategoriaFim").suggest()},onSuggestFamiliaIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr3",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr3",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idFamiliaIni").getBinding("suggestionItems").filter(t);this.byId("idFamiliaIni").suggest()},onSuggestFamiliaFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr3",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr3",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idFamiliaFim").getBinding("suggestionItems").filter(t);this.byId("idFamiliaFim").suggest()},onSuggestMarcaIni:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr5",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr5",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idMarcaIni").getBinding("suggestionItems").filter(t);this.byId("idMarcaIni").suggest()},onSuggestMarcaFim:function(e){var r=e.getSource().getValue();var t=[];var a=[new sap.ui.model.Filter("Mvgr5",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescMvgr5",sap.ui.model.FilterOperator.Contains,r)];var i=new sap.ui.model.Filter(a,false);t.push(i);this.byId("idMarcaFim").getBinding("suggestionItems").filter(t);this.byId("idMarcaFim").suggest()}})});