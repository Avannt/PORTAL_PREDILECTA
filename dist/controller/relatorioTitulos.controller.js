sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","application/model/formatter","sap/ui/core/util/MockServer","sap/ui/export/library","sap/ui/export/Spreadsheet","sap/ui/model/odata/v2/ODataModel","sap/m/MessageBox"],function(e,r,t,i,o,a,s,n){"use strict";var l=[];var u=a.EdmType;return e.extend("application.controller.relatorioTitulos",{onInit:function(){this.getRouter().getRoute("relatorioTitulos").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;var t=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.oModel=e.getModelGlobal("modelAux").getProperty("/DBModel");var i={BukrsIni:"",BukrsFim:"",KunnrIni:"",KunnrFim:"",Kvgr4Ini:"",Kvgr4Fim:"",Kvgr5Ini:"",Kvgr5Fim:"",BelnrIni:"",BelnrFim:"",LifnrIni:"",LifnrFim:"",PeriodoIni:"",PeriodoFim:""};var o=new r(i);e.setModel(o,"modelParametros");e.vetorTitulos=[];var a=new r(e.vetorTitulos);e.setModel(a,"modelTitulos");var s=e.getModelGlobal("modelAux").getProperty("/Kunnr");e.getModel("modelParametros").setProperty("/KunnrIni",s);e.getModel("modelParametros").setProperty("/KunnrFim",s);new Promise(function(r,i){e.onBuscarClientes(t,r,i,e)}).then(function(t){var i=t;var o=[];var a=[];var s=[];for(var n=0;n<i.length;n++){var l=false;var u=false;var d=false;for(var p=0;p<o.length;p++){if(i[n].Kvgr4==o[p].Kvgr4||i[n].Kvgr4==""){l=true;break}}for(var g=0;g<a.length;g++){if(i[n].Kvgr5==a[g].Kvgr5||i[n].Kvgr5==""){u=true;break}}for(var m=0;m<s.length;m++){if(i[n].Lifnr==s[m].Lifnr||i[n].Lifnr==""){d=true;break}}if(l==false){o.push(i[n])}if(u==false){a.push(i[n])}if(d==false){s.push(i[n])}}var v=new r(i);e.setModel(v,"modelClientes");var F=new r(o);e.setModel(F,"modelRedes");var y=new r(a);e.setModel(y,"modelBandeiras");var f=new r(s);e.setModel(f,"modelRepres")}).catch(function(r){e.onMensagemErroODATA(r)});e.oModel.read("/Centros",{urlParameters:{$filter:"IvUsuario eq '"+t+"'"},success:function(t){e.vetorEmpresas=[];e.vetorCentrosAux=t.results;for(var i=0;i<e.vetorCentrosAux.length;i++){var o=false;for(var a=0;a<e.vetorEmpresas.length;a++){if(e.vetorEmpresas[a].Bukrs==e.vetorCentrosAux[i].Bukrs){o=true}}if(o==false){var s={Bukrs:e.vetorCentrosAux[i].Bukrs,Butxt:e.vetorCentrosAux[i].Butxt};e.vetorEmpresas.push(s)}}var n=new r(e.vetorEmpresas);e.setModel(n,"modelEmpresas")},error:function(r){e.onMensagemErroODATA(r)}})},ongetHeaderGroupLifnr:function(e){return e.getProperty("Lifnr")},ongetHeaderGroupBukrs:function(e){return e.getProperty("Bukrs")+" - "+e.getProperty("Butxt")},createColumnConfig:function(){var e=[];e.push({label:"Empresa",property:"Bukrs",type:u.String});e.push({label:"Nome Empresa",property:"Butxt",type:u.String});e.push({label:"Doc Contábil",property:"Belnr",type:u.String});e.push({label:"Lançto",property:"Budat",type:u.DateTime,format:"dd/mm/yyyy"});e.push({label:"Cliente",property:"Kunnr",type:u.String});e.push({label:"Razão Social",property:"Name1Cli",type:u.String});e.push({label:"CNPJ",property:"Stcd1",type:u.String});e.push({label:"CPF",property:"Stcd2",type:u.String});e.push({label:"Rede",property:"Kvgr4",type:u.String});e.push({label:"Descrição Rede",property:"Kvgr4Text",type:u.String});e.push({label:"Bandeira",property:"Kvgr5",type:u.String});e.push({label:"Descrição Bandeira",property:"Kvgr5Text",type:u.String});e.push({label:"UF",property:"Region",type:u.String});e.push({label:"Cidade",property:"City1",type:u.String});e.push({label:"Nº Docto",property:"DocNum",type:u.String});e.push({label:"Nº NF",property:"Xblnr",type:u.String});e.push({label:"Referência Cliente",property:"Bstkd",type:u.String});e.push({label:"Nº Fat",property:"DocFat",type:u.String});e.push({label:"Dias Atraso",property:"DiasAtraso",type:u.String});e.push({label:"Vl.Título",property:"Dmbtr",type:u.Number,scale:2,delimiter:true});e.push({label:"Data Últ Advt.",property:"Madat",type:u.DateTime,format:"dd/mm/yyyy"});return e},onExport:function(){var e,r,t,i,o;if(!this._oTable){this._oTable=this.byId("idtableTitulos")}o=this._oTable;r=o.getBinding("items");e=this.createColumnConfig();t={workbook:{columns:e,hierarchyLevel:"Level"},dataSource:r,fileName:"Rel_Titulos_Abertos.xlsx",worker:false};i=new s(t);i.build().finally(function(){i.destroy()})},onDialogClose:function(){if(this._ItemDialog){this._ItemDialog.destroy(true)}},onPressBtnFiltrar:function(){var e=this;var r=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.oModel=e.getModelGlobal("modelAux").getProperty("/DBModel");var t=e.getModel("modelParametros").getData();var i=e.getModel("modelParametros").getProperty("/Periodo");try{var o=i.split(" - ");t.PeriodoIni=o[0];t.PeriodoFim=o[1]}catch(e){console.log(e)}e.byId("master").setBusy(true);e.oModel.read("/P_RelTitulos",{urlParameters:{$filter:"Usuario eq '"+r+"' and BukrsIni eq '"+t.BukrsIni+"' and BukrsFim eq '"+t.BukrsFim+"' and KunnrIni eq '"+t.KunnrIni+"' and KunnrFim eq '"+t.KunnrFim+"' and Kvgr4Ini eq '"+t.Kvgr4Ini+"' and Kvgr4Fim eq '"+t.Kvgr4Fim+"' and Kvgr5Ini eq '"+t.Kvgr5Ini+"' and Kvgr5Fim eq '"+t.Kvgr5Fim+"' and BelnrIni eq '"+t.BelnrIni+"' and BelnrFim eq '"+t.BelnrFim+"' and RepreIni eq '"+t.LifnrIni+"' and RepreFim eq '"+t.LifnrFim+"' and PerioIni eq '"+t.PeriodoIni+"' and PerioFim eq '"+t.PeriodoFim+"'"},success:function(r){e.vetorTitulos=r.results;e.getModel("modelTitulos").setData(e.vetorTitulos);e.byId("master").setBusy(false)},error:function(r){e.byId("master").setBusy(false);e.onMensagemErroODATA(r)}})},onExpandFiltro:function(){if(this.byId("idPanelFiltro").getExpanded()){this.byId("idPanelFiltro").setHeaderText("Ocultar Filtros")}else{this.byId("idPanelFiltro").setHeaderText("Exibir Filtros")}},onSuggestEmpresaIni:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Bukrs",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Butxt",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idEmpresaIni").getBinding("suggestionItems").filter(t);this.byId("idEmpresaIni").suggest()},onSuggestEmpresaFim:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Bukrs",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Butxt",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idEmpresaFim").getBinding("suggestionItems").filter(t);this.byId("idEmpresaFim").suggest()},onSuggestClienteIni:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idClienteIni").getBinding("suggestionItems").filter(t);this.byId("idClienteIni").suggest()},onSuggestClienteFim:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kunnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idClienteFim").getBinding("suggestionItems").filter(t);this.byId("idClienteFim").suggest()},onSuggestRedeIni:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kvgr4",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr4",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idRedeIni").getBinding("suggestionItems").filter(t);this.byId("idRedeIni").suggest()},onSuggestRedeFim:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kvgr4",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr4",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idRedeFim").getBinding("suggestionItems").filter(t);this.byId("idRedeFim").suggest()},onSuggestBandeiraIni:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kvgr5",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr5",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idBandeiraIni").getBinding("suggestionItems").filter(t);this.byId("idBandeiraIni").suggest()},onSuggestBandeiraFim:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Kvgr5",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("DescKvgr5",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idBandeiraFim").getBinding("suggestionItems").filter(t);this.byId("idBandeiraFim").suggest()},onSuggestRepresIni:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1Rep",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idRepreIni").getBinding("suggestionItems").filter(t);this.byId("idRepreIni").suggest()},onSuggestRepresFim:function(e){var r=e.getSource().getValue();var t=[];var i=[new sap.ui.model.Filter("Lifnr",sap.ui.model.FilterOperator.Contains,r),new sap.ui.model.Filter("Name1Rep",sap.ui.model.FilterOperator.Contains,r)];var o=new sap.ui.model.Filter(i,false);t.push(o);this.byId("idRepreFim").getBinding("suggestionItems").filter(t);this.byId("idRepreFim").suggest()}})});