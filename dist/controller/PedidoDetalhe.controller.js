sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","application/model/formatter","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,o,t,a,d,i){"use strict";var s=d.EdmType;return e.extend("application.controller.PedidoDetalhe",{formatter:a,onInit:function(){this.getRouter().getRoute("pedidoDetalhe").attachPatternMatched(this.onLoadFields,this)},onLoadFields:function(){var e=this;var o=e.getModelGlobal("modelAux").getProperty("/NrPedido");e.byId("idPedidoDetalhe").setBusy(true);new Promise(function(o,t){e.onInicializaCampos(o,t)}).then(function(){if(o!=""){new Promise(function(t,a){e.onBuscarPedido(o,t,a,e)}).then(function(o){e.getModelGlobal("modelPedido").setData(o);e.onCarregarCombosMsgPedido(o);e.byId("idPedidoDetalhe").setBusy(false);new Promise(function(o,t){e.onBuscarItensPedido(o,t,e.getModelGlobal("modelAux").getProperty("/NrPedido"))}).then(function(t){e.vetorItensPedido=t;if(e.vetorItensPedido.length>0){e.byId("idTopLevelIconTabBar").setSelectedKey("tab3")}new Promise(function(o,t){e.byId("idTipoPedido").setBusy(true);var a=e.getModelGlobal("modelPedido").getProperty("/Kunnr");var d=e.getModelGlobal("modelPedido").getProperty("/Kvgr4");var i=e.getModelGlobal("modelPedido").getProperty("/Kvgr5");var s=e.getModelGlobal("modelPedido").getProperty("/Werks");e.onBuscarTipoPedido(e.Usuario,a,s,d,i,o,t,e)}).then(function(t){e.byId("idTipoPedido").setBusy(false);e.onCarregarTipoPedido(o,t);e.onCarregarLocalEntrega(e.getModelGlobal("modelPedido").getProperty("/Bukrs"));e.getModelGlobal("modelItensPedidoGrid").setData(e.vetorItensPedido);e.getModelGlobal("modelItensPedidoGrid").refresh();e.getModelGlobal("modelAux").setProperty("/ItensPedidoTab",e.vetorItensPedido.length);e.byId("table_pedidos").setBusy(false);e.onBloquearPedido(o.IdStatusPedido)}).catch(function(o){e.onMensagemErroODATA(o)})}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})}).catch(function(o){e.byId("table_pedidos").setBusy(false);e.onMensagemErroODATA(o)})}else{e.onCriarNrPedido();e.onSetValuesDefault();e.onBloquearPedido(e.getModelGlobal("modelPedido").getProperty("IdStatusPedido"));e.byId("idPedidoDetalhe").setBusy(false)}})},onInicializaCampos:function(e,t){var a=this;a.oModel=this.getModelGlobal("modelAux").getProperty("/DBModel");a.CodRepres=this.getModelGlobal("modelAux").getProperty("/CodRepres");a.Usuario=this.getModelGlobal("modelAux").getProperty("/Usuario");this.byId("idVencimento1").setEnabled(true);a.vetorFretes=[];a.vetorCentros=[];a.vetorCampanha=[];a.vetorProdutos=[];a.vetorTabPrecos=[];a.vetorMsgPedido=[];a.vetorContratos=[];a.vetorMsgPedido2=[];a.vetorMsgPedido3=[];a.vetorTipoPedidos=[];a.vetorItensPedido=[];a.vetorMotivosNota=[];a.vetorVencimentos1=[];a.vetorMotivosBoleto=[];a.vetorLocaisEntregas=[];a.vetorLocaisEntregasAux=[];a.vetorMotivosCampanha=[];a.vetorVencimentoTotal=[];a.vetorTipoPedidosTotal=[];a.getModelGlobal("modelAux").getProperty("/ObrigaSalvar",false);a.getModelGlobal("modelAux").getProperty("/ItensPedidoTab",0);var d=a.getModelGlobal("Cliente_G");a.setModel(d,"modelCliente");var i=new o(a.vetorContratos);a.setModel(i,"modelContratos");var s=new o(a.vetorVencimentos1);a.setModel(s,"modelVencimentos1");var r=new o(a.vetorCampanha);a.setModel(r,"modelCampanha");var l=new o(a.vetorTabPrecos);a.setModel(l,"modelTabPrecos");var n=new o(a.vetorFretes);a.setModel(n,"modelFretes");var c=new o(a.vetorCentros);a.setModel(c,"modelCentros");var m=new o(a.vetorTipoPedidos);a.setModel(m,"modelTipoPedidos");var g=new o(a.vetorMsgPedido);a.setModel(g,"modelMsgPedido");var p=new o(a.vetorMsgPedido2);a.setModel(p,"modelMsgPedido2");var b=new o(a.vetorMsgPedido3);a.setModel(b,"modelMsgPedido3");var P=new o(a.vetorLocaisEntregas);a.setModel(P,"modelLocaisEntregas");var u=new o(a.vetorProdutos);a.setModelGlobal(u,"modelProdutos");var y=new o(a.vetorMotivosCampanha);a.setModelGlobal(y,"modelMotivosCamp");var h=new o(a.vetorMotivosNota);a.setModelGlobal(h,"modelMotivosNota");var I=new o(a.vetorMotivosBoleto);a.setModelGlobal(I,"modelMotivosBoleto");var v=new o(a.vetorItensPedido);a.setModelGlobal(v,"modelItensPedidoGrid");a.byId("idTopLevelIconTabBar").setSelectedKey("tab1");a.onCriarModelPedido();var M=[];M.push(new Promise(function(e,o){a.oModel.read("/Vencimentos",{success:function(o){var t=parseFloat(a.getModel("modelCliente").getProperty("/CreditLimit"));if(t==1){for(var d=0;d<o.results.length;d++){if(o.results[d].Zterm=="0000"){a.vetorVencimentoTotal.push(o.results[d])}}}else{a.vetorVencimentoTotal=o.results}a.getModel("modelVencimentos1").setData(a.vetorVencimentoTotal);e()},error:function(e){a.onMensagemErroODATA(e)}})}));M.push(new Promise(function(e,o){a.oModel.read("/TabPrecos",{success:function(o){for(var t=0;t<o.results.length;t++){if(o.results[t].Pltyp==a.getModel("modelCliente").getProperty("/Pltyp")){a.vetorTabPrecos.push(o.results[t])}}a.getModel("modelTabPrecos").setData(a.vetorTabPrecos);e()},error:function(e){a.onMensagemErroODATA(e)}})}));M.push(new Promise(function(e,o){a.oModel.read("/MsgNF",{success:function(o){a.vetorMsgPedido=o.results;a.getModel("modelMsgPedido").setData(a.vetorMsgPedido);e()},error:function(e){a.onMensagemErroODATA(e)}})}));M.push(new Promise(function(e,o){a.oModel.read("/LocaisEntregas",{urlParameters:{$filter:"IvUsuario eq '"+a.Usuario+"'"},success:function(o){var t=o.results;for(var d=0;d<t.length;d++){var i=t[d];if(i.Kunnr==a.getModel("modelCliente").getProperty("/Kunnr")){a.vetorLocaisEntregas.push(i)}}e()},error:function(e){a.onMensagemErroODATA(e)}})}));M.push(new Promise(function(e,o){a.oModel.read("/Fretes",{success:function(o){a.vetorFretes=o.results;a.getModel("modelFretes").setData(a.vetorFretes);e()},error:function(e){a.onMensagemErroODATA(e)}})}));M.push(new Promise(function(e,t){a.oModel.read("/Centros",{urlParameters:{$filter:"IvUsuario eq '"+a.Usuario+"'"},success:function(t){a.vetorCentros=t.results;c=new o(a.vetorCentros);a.setModel(c,"modelCentros");e()},error:function(e){t(e)}})}));M.push(new Promise(function(e,o){a.vetorMotivosCampanha=[];a.vetorMotivosBoleto=[];a.vetorMotivosNota=[];a.oModel.read("/MotvCamp",{success:function(o){var t=o.results;for(var d=0;d<t.length;d++){var i=t[d];if(i.TipoDesconto=="CAMP"){a.vetorMotivosCampanha.push(i)}else if(i.TipoDesconto=="BOL"){a.vetorMotivosBoleto.push(i)}else if(i.TipoDesconto=="NF"){a.vetorMotivosNota.push(i)}}a.getModelGlobal("modelMotivosCamp").setData(a.vetorMotivosCampanha);a.getModelGlobal("modelMotivosBoleto").setData(a.vetorMotivosBoleto);a.getModelGlobal("modelMotivosNota").setData(a.vetorMotivosNota);e()},error:function(e){o();a.onMensagemErroODATA(e)}})}));M.push(new Promise(function(e,o){var t=a.getModelGlobal("modelAux").getProperty("/CodRepres");a.oModel.read("/TipoIntegraBol",{urlParameters:{$filter:"IvUsuario eq '"+a.Usuario+"'"},success:function(o){var t=o.results;var d=a.getModel("modelCliente").getProperty("/Kunnr");var i=a.getModel("modelPedido").getProperty("/Bukrs");var s="false";for(var r=0;r<t.length;r++){if(d==t[r].Kunnr&&i==t[r].Bukrs){s="true";break}}if(s=="true"){a.getModelGlobal("modelPedido").setProperty("/TipoIntegrBol","CONTAS A RECEBER")}else{a.getModelGlobal("modelPedido").setProperty("/TipoIntegrBol","CONTAS A PAGAR")}e()},error:function(e){o();a.onMensagemErroODATA(e)}})}));Promise.all(M).then(function(o){a.getModelGlobal("modelPedido").setProperty("/EmailCliente",a.getModel("modelCliente").getProperty("/EmailComprador"));e()})},onValidaDataMenorAtual:function(e){var o=e.split("/");var t=this.onDataHora();var a=t[2].ano+t[2].mes+t[2].dia;var d=String(o[2])+String(o[1])+String(o[0]);if(d>=a){return"Data Maior"}else{return"Data Menor"}},onValidaDataLimiteEntrega:function(e,o){var e=e.split("/");var o=o.split("/");var t=String(e[2])+String(e[1])+String(e[0]);var a=String(o[2])+String(o[1])+String(o[0]);if(t>=a){return"Data Maior"}else{return"Data Menor"}},onCarregarCombosMsgPedido:function(e){var o=this.getModel("modelMsgPedido").getData();if(e.MsgPedido1!=""&&e.MsgPedido1!="00000"){for(var t=0;t<o.length;t++){if(o[t].CodMensagem!=e.MsgPedido1){this.vetorMsgPedido2.push(o[t])}}this.getModel("modelMsgPedido2").setData(this.vetorMsgPedido2)}if(e.MsgPedido2!="00000"&&e.MsgPedido2!=""){for(var t=0;t<this.vetorMsgPedido2.length;t++){if(this.vetorMsgPedido2[t].CodMensagem!=e.MsgPedido2){this.vetorMsgPedido3.push(this.vetorMsgPedido2[t])}}this.getModel("modelMsgPedido3").setData(this.vetorMsgPedido3)}},onSetValuesDefault:function(){var e=this.onDataHora();this.getModelGlobal("modelPedido").setProperty("/SituacaoPedido","EM DIGITAÇÃO");this.getModelGlobal("modelPedido").setProperty("/IdStatusPedido",1);this.getModelGlobal("modelPedido").setProperty("/TipoDispositivo","PORTALWEB");this.getModelGlobal("modelPedido").setProperty("/Lifnr",this.getModel("modelAux").getProperty("/Lifnr"));this.getModelGlobal("modelPedido").setProperty("/Usuario",this.getModel("modelAux").getProperty("/Usuario"));this.getModelGlobal("modelPedido").setProperty("/DataIni",e[0]);this.getModelGlobal("modelPedido").setProperty("/HoraIni",e[1]);this.getModelGlobal("modelPedido").setProperty("/DataFim",e[0]);this.getModelGlobal("modelPedido").setProperty("/HoraFim",e[1]);this.getModelGlobal("modelPedido").setProperty("/Kunnr",this.getModel("modelCliente").getProperty("/Kunnr"));this.getModelGlobal("modelPedido").setProperty("/Kvgr1",this.getModel("modelCliente").getProperty("/Kvgr1"));this.getModelGlobal("modelPedido").setProperty("/Kvgr2",this.getModel("modelCliente").getProperty("/Kvgr2"));this.getModelGlobal("modelPedido").setProperty("/Kvgr3",this.getModel("modelCliente").getProperty("/Kvgr3"));this.getModelGlobal("modelPedido").setProperty("/Kvgr4",this.getModel("modelCliente").getProperty("/Kvgr4"));this.getModelGlobal("modelPedido").setProperty("/Kvgr5",this.getModel("modelCliente").getProperty("/Kvgr5"));this.getModelGlobal("modelPedido").setProperty("/Bzirk",this.getModel("modelCliente").getProperty("/Bzirk"));this.getModelGlobal("modelPedido").setProperty("/Txjcd",this.getModel("modelCliente").getProperty("/Txjcd"));this.getModelGlobal("modelPedido").setProperty("/Pltyp",this.getModel("modelCliente").getProperty("/Pltyp"));this.getModelGlobal("modelPedido").setProperty("/EmailRepres",this.getModelGlobal("modelAux").getProperty("/Email"));this.getModelGlobal("modelPedido").setProperty("/Tdt",this.getModel("modelCliente").getProperty("/Tdt"));this.getModelGlobal("modelPedido").setProperty("/EmailCliente",this.getModel("modelCliente").getProperty("/EmailComprador"));this.getModelGlobal("modelAux").setProperty("/ItensPedidoTab",0);if(this.getModel("modelCliente").getProperty("/Inco1")!=""){this.getModelGlobal("modelPedido").setProperty("/Inco1",this.getModel("modelCliente").getProperty("/Inco1"))}this.onCarregarTipoPedido(this.getModelGlobal("modelPedido").getData())},onBloquearPedido:function(e){var o=this;function t(e,t,a){o.byId("idEstabelecimento").setEnabled(e);o.byId("idTabelaPreco").setEnabled(e);if(o.getModelGlobal("modelPedido").getProperty("/Contrato")!=""){o.byId("idVencimento1").setEnabled(false)}else{o.byId("idVencimento1").setEnabled(e)}o.byId("idTipoPedido").setEnabled(e);o.byId("idLocalEntrega").setEnabled(e);o.byId("idTipoTransporte").setEnabled(e);if(t==3||t==2){o.byId("idDataLimite").setEnabled(false);o.byId("idDataEntrega").setEnabled(false);o.byId("idMsg1").setEnabled(false);o.byId("idMsg2").setEnabled(false);o.byId("idMsg3").setEnabled(false);o.byId("idPedidoOrigem").setEnabled(false);o.byId("idObservacoes").setEnabled(false);o.byId("idEmailCliente").setEnabled(false)}else{o.byId("idDataLimite").setEnabled(true);o.byId("idDataEntrega").setEnabled(true);o.byId("idMsg1").setEnabled(true);o.byId("idMsg2").setEnabled(true);o.byId("idMsg3").setEnabled(true);o.byId("idPedidoOrigem").setEnabled(true);o.byId("idObservacoes").setEnabled(true);o.byId("idEmailCliente").setEnabled(true)}if(t!=1){o.byId("idDescontoPedido").setEnabled(false);o.byId("idDescontoAplicar").setEnabled(false);o.byId("idDescontoAplicarBoleto").setEnabled(false);o.byId("idDescontoPedidoCamp").setEnabled(false);o.byId("idDescontoAplicarCamp").setEnabled(false);o.byId("idDescontoPedidoBoleto").setEnabled(false);o.byId("idDescontoPedidoCampBol").setEnabled(false);o.byId("idDescontoAplicarCampBol").setEnabled(false)}else{o.byId("idDescontoPedido").setEnabled(true);o.byId("idDescontoAplicar").setEnabled(true);o.byId("idDescontoAplicarBoleto").setEnabled(true);o.byId("idDescontoPedidoCamp").setEnabled(true);o.byId("idDescontoAplicarCamp").setEnabled(true);o.byId("idDescontoPedidoBoleto").setEnabled(true);o.byId("idDescontoPedidoCampBol").setEnabled(true);o.byId("idDescontoAplicarCampBol").setEnabled(true)}}function a(e){o.byId("tabTotalStep").setEnabled(e);o.byId("tabDescontoStep").setEnabled(e);o.byId("tabItensPedidoStep").setEnabled(e)}var d=this.getModelGlobal("modelItensPedidoGrid").getData();if(d.length>0&&e==1){t(false,e);a(true)}else if(d.length==0){t(true,e);a(false)}else if(e==3||e==2){t(false,e);a(true)}},onCriarNrPedido:function(){this.byId("idTopLevelIconTabBar").setSelectedKey("tab1");this.getModelGlobal("modelPedido").setProperty("/Completo",false);var e=this.getModelGlobal("modelAux").getProperty("/CodRepres");var o=this.getModelGlobal("modelAux").getProperty("/Lifnr");var t=this.onDataHora();var a=t[0].substring(0,2)+t[0].substring(3,5)+t[0].substring(6,11);var d=t[1].substring(0,2)+t[1].substring(3,5)+t[1].substring(6,8);if(o==e){var i=o+"."+a+"."+d}else{i=e+"."+a+"."+d}this.getModelGlobal("modelAux").setProperty("/NrPedido",i);this.getModelGlobal("modelPedido").setProperty("/NrPedido",i)},onLiberarItensPedido:function(){Date.prototype.addDays=function(e){var o=new Date(this.valueOf());o.setDate(o.getDate()+parseInt(e,10));return o.toLocaleDateString("pt-BR")};var e=this;var o=e.getModelGlobal("modelPedido").getData();var a=parseFloat(this.getModel("modelCliente").getProperty("/CreditLimit"));var d=e.onValidaDataMenorAtual(o.DataLimite);var i=e.onValidaDataMenorAtual(o.DataEntrega);var s=new Date;var r=s.addDays(this.getModelGlobal("modelAux").getProperty("/MaxDiasEntrega"));var l=e.onValidaDataLimiteEntrega(o.DataEntrega,r);var n=e.onValidaDataLimiteEntrega(o.DataEntrega,o.DataEntregaSujerida);if(o.StatusPedido==3){sap.m.MessageBox.show("O pedido "+o.NrPedido+" não pode mais ser alterado",{icon:sap.m.MessageBox.Icon.WARNING,title:"Não Permitido",actions:[t.Action.OK]})}else if(o.Pltyp==""){sap.m.MessageBox.show("Preencher a tabela de preço!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idTabelaPreco").focus();e.byId("idTabelaPreco").setValueState("Error")}})}else if(o.Werks==""){sap.m.MessageBox.show("Escolha o estabelecimento!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idEstabelecimento").focus();e.byId("idEstabelecimento").setValueState("Error")}})}else if(o.Vencimento==""&&o.Contrato!=""&&a==1){sap.m.MessageBox.show("Cliente possui Contrato e Limite de crédito indisponível. Entrar em contato com Depto. Financeiro!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idVencimento1").setValueState("Error")}})}else if(o.Vencimento==""){sap.m.MessageBox.show("Preencher a data pagamento!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idTabelaPreco").focus();e.byId("idVencimento1").setValueState("Error")}})}else if(o.DataLimite==""){sap.m.MessageBox.show("Preencher a data limite!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idDataLimite").focus();e.byId("idDataLimite").setValueState("Error")}})}else if(o.TipoPedido==""){sap.m.MessageBox.show("Preencher o tipo de pedido!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idTipoPedido").focus();e.byId("idTipoPedido").setValueState("Error")}})}else if(o.DataEntrega==""){sap.m.MessageBox.show("Preencher a Data de Entrega!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idDataEntrega").focus();e.byId("idDataEntrega").setValueState("Error")}})}else if(o.LocalEntrega==""){sap.m.MessageBox.show("Preencher a Local de Entrega!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idLocalEntrega").focus();e.byId("idLocalEntrega").setValueState("Error")}})}else if(o.Inco1==""){sap.m.MessageBox.show("Preencher o Tipo de Transporte!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idTipoTransporte").focus();e.byId("idTipoTransporte").setValueState("Error")}})}else if(d!="Data Maior"){sap.m.MessageBox.show("Data Limite é menor que data Atual!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Error campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idDataLimite").focus();e.byId("idDataLimite").setValueState("Error")}})}else if(i!="Data Maior"){sap.m.MessageBox.show("Data de Entrega é menor que data Atual!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idDataEntrega").focus();e.byId("idDataEntrega").setValueState("Error")}})}else if(l=="Data Maior"){sap.m.MessageBox.show("Data de Entrega máx permitida é de "+this.getModelGlobal("modelAux").getProperty("/MaxDiasEntrega")+" dias a partir da data atual! ",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idDataEntrega").focus();e.byId("idDataEntrega").setValueState("Error")}})}else if(o.EmailCliente==""){sap.m.MessageBox.show("Preencher o email do cliente!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idEmailCliente").focus();e.byId("idEmailCliente").setValueState("Error")}})}else if(o.PedidoOrigem==""){sap.m.MessageBox.show("Preencher o pedido origem cliente!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idPedidoOrigem").focus();e.byId("idPedidoOrigem").setValueState("Error")}})}else if(n=="Data Menor"){sap.m.MessageBox.show("Alinhar data de entrega superior a data sugerida!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){e.byId("idTopLevelIconTabBar").setSelectedKey("tab2");e.byId("idDataEntrega").focus();e.byId("idDataEntrega").setValueState("Error")}})}else{sap.m.MessageBox.show("O tipo de frete escolhido é "+o.Inco1+". Deseja continuar?",{icon:sap.m.MessageBox.Icon.WARNING,title:"Confirmação de campo(s)",actions:[t.Action.YES,t.Action.CANCEL],onClose:function(a){if(a==t.Action.YES){e.onLimparValueState("None");o.Completo=false;o.Usuario=e.getModelGlobal("modelAux").getProperty("/CodRepres");e.byId("idPedidoDetalhe").setBusy(true);o=e.onFormatNumberPedido(o);delete o.__metadata;e.oModel.create("/P_PedidoPR",o,{method:"POST",success:function(o){t.show("Pedido: "+o.NrPedido+" Salvo!",{icon:t.Icon.SUCCESS,title:"Inclusão do Pedido!",actions:[t.Action.OK],onClose:function(){e.byId("idPedidoDetalhe").setBusy(false);e.onLiberarAbas()}})},error:function(o){e.byId("table_pedidos").setBusy(false);e.byId("idPedidoDetalhe").setBusy(false);e.onMensagemErroODATA(o);sap.ui.core.UIComponent.getRouterFor(e).navTo("pedido")}})}}})}},onLimparValueState:function(e){this.byId("idVencimento1").setValueState(e);this.byId("idEstabelecimento").setValueState(e);this.byId("idTabelaPreco").setValueState(e);this.byId("idDataLimite").setValueState(e);this.byId("idDataEntrega").setValueState(e);this.byId("idTipoPedido").setValueState(e);this.byId("idLocalEntrega").setValueState(e);this.byId("idTipoTransporte").setValueState(e);this.byId("idEmailCliente").setValueState(e);this.byId("idPedidoOrigem").setValueState(e)},onLiberarAbas:function(e){this.byId("tabTotalStep").setEnabled(true);this.byId("tabDescontoStep").setEnabled(true);this.byId("tabItensPedidoStep").setEnabled(true);this.byId("idTopLevelIconTabBar").setSelectedKey("tab3");this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",false)},onOcultarCampos:function(e){this.byId("idContrato").setVisible(e)},onChangeMsg1:function(e){this.vetorMsgPedido2=[];var o=e.getSource().getSelectedKey();var t=this.getModel("modelMsgPedido").getData();for(var a=0;a<t.length;a++){if(t[a].CodMensagem!=o){this.vetorMsgPedido2.push(t[a])}}this.getModel("modelMsgPedido2").setData(this.vetorMsgPedido2);this.getModelGlobal("modelPedido").setProperty("/MsgPedido2","");this.getModelGlobal("modelPedido").setProperty("/MsgPedido3","");this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true)},onChangeMsg2:function(e){this.vetorMsgPedido3=[];var o=e.getSource().getSelectedKey();var t=this.getModel("modelMsgPedido2").getData();for(var a=0;a<t.length;a++){if(t[a].CodMensagem!=o){this.vetorMsgPedido3.push(t[a])}}this.getModel("modelMsgPedido3").setData(this.vetorMsgPedido3);this.getModelGlobal("modelPedido").setProperty("/MsgPedido3","");this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true)},onChangeMsg3:function(e){this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true)},onCriarModelPedido:function(){var e=this.onDataHora();var t=e[2].dia+"/"+e[2].mes+"/"+e[2].ano;var a=new o({NrPedido:"",Vencimento:"",IndiceFinal:"",Lifnr:"",Usuario:"",DataIni:"",HoraIni:"",DataFim:"",HoraFim:"",IdStatusPedido:"",SituacaoPedido:"",Werks:"",Bukrs:"",RegCentro:"",Pltyp:"",Inco1:"",TipoPedido:"",Completo:false,Kunnr:"",RegCliente:"",DataLimite:t,DataEntregaSujerida:t,DataEntrega:"",LocalEntrega:"",MsgPedido1:"",MsgPedido2:"",MsgPedido3:"",EmailRepres:"",EmailCliente:"",EnviarEmailCliente:true,EnviarEmailRepres:true,ValorTotal:0,TotalItens:0,ValTotItemSt:0,PesoBruto:0,PesoLiq:0,RentTotal:0,RentTotalImg:"./img/N.png",ValMinPed:0,PercAcresc:0,PercCampFlex:0,PercFator:0,PercRentabNeg:0,NrMesina:0,PercIncent:0,LogVerbaRentNeg:false,LogProposta:false,TotalVerba:0,ObsPedido:"",PedidoOrigem:"",Contrato:"",TipoIntegrBol:"",MotivoDescNota:"",MotivoDescCamp:"",MotivoDescBoleto1:"",MotivoDescBoleto2:"",Gerencia:"",Supervisor:"",ValDescDisp:0,ValDescAplicar:0,ValDescAplicarBol:0,ValDescCampInform:0,ValDescCampInformBol:0,ValDescCampDispBol:0,ValDescCampDisp:0,Vbeln:"",Email:"",Tdt:"",DataEnvio:"",HoraEnvio:"",LeadTime:0});this.setModelGlobal(a,"modelPedido")},onChangeEstabelecimento:function(e){var o=this;o.vetorTipoPedidos=[];o.vetorVencimentos=[];var t=o.getModelGlobal("modelPedido").getProperty("/Werks");var a=o.getModelGlobal("modelPedido").getProperty("/Kunnr");var d=o.getModelGlobal("modelPedido").getProperty("/Kvgr4");var i=o.getModelGlobal("modelPedido").getProperty("/Kvgr5");o.getModelGlobal("modelPedido").setProperty("/Vencimento","");o.getModelGlobal("modelPedido").setProperty("/IndiceFinal",0);o.getModelGlobal("modelPedido").setProperty("/Contrato","");o.byId("idVencimento1").setEnabled(true);o.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true);for(var s=0;s<o.vetorCentros.length;s++){if(o.vetorCentros[s].Werks==t){o.getModelGlobal("modelPedido").setProperty("/Bukrs",o.vetorCentros[s].Bukrs);o.getModelGlobal("modelPedido").setProperty("/RegCentro",o.vetorCentros[s].Regio);o.getModelGlobal("modelPedido").setProperty("/RegCliente",o.getModel("modelCliente").getProperty("/Regio"));o.getModelGlobal("modelPedido").setProperty("/ValMinPed",o.vetorCentros[s].ValMinPed);o.getModelGlobal("modelPedido").setProperty("/PercAcresc",o.vetorCentros[s].PercAcresc);o.getModelGlobal("modelPedido").setProperty("/NrMesina",o.vetorCentros[s].NrMesina);o.getModelGlobal("modelPedido").setProperty("/PercIncent",o.vetorCentros[s].PercIncent);o.getModelGlobal("modelPedido").setProperty("/PercFator",o.vetorCentros[s].PercFator);o.getModelGlobal("modelPedido").setProperty("/PercRentabNeg",o.vetorCentros[s].PercRentabNeg);o.getModelGlobal("modelPedido").setProperty("/LogVerbaRentNeg",o.vetorCentros[s].LogVerbaRentNeg);o.getModelGlobal("modelPedido").setProperty("/LogProposta",o.vetorCentros[s].LogProposta);o.getModelGlobal("modelPedido").setProperty("/Gerencia",o.vetorCentros[s].Gerencia);o.getModelGlobal("modelPedido").setProperty("/Supervisor",o.vetorCentros[s].Supervisor);o.vetorLocaisEntregasAux=[];for(var s=0;s<o.vetorLocaisEntregas.length;s++){if(o.getModelGlobal("modelPedido").getProperty("/Bukrs")==o.vetorLocaisEntregas[s].Bukrs||o.vetorLocaisEntregas[s].Bukrs==""){o.vetorLocaisEntregasAux.push(o.vetorLocaisEntregas[s])}}o.getModel("modelLocaisEntregas").setData(o.vetorLocaisEntregasAux);o.getModel("modelLocaisEntregas").refresh();if(this.getModel("modelLocaisEntregas").getData().length==1){this.getModel("modelPedido").setProperty("/LocalEntrega",this.getModel("modelLocaisEntregas").getData()[0].Addrnumber)}break}}new Promise(function(e,t){o.byId("idTipoPedido").setBusy(true);var a=o.getModelGlobal("modelPedido").getProperty("/Kunnr");var d=o.getModelGlobal("modelPedido").getProperty("/Kvgr4");var i=o.getModelGlobal("modelPedido").getProperty("/Kvgr5");var s=o.getModelGlobal("modelPedido").getProperty("/Werks");o.onBuscarTipoPedido(o.Usuario,a,s,d,i,e,t,o)}).then(function(e){o.onCarregarTipoPedido(o.getModelGlobal("modelPedido").getData(),e);if(o.getModel("modelTipoPedidos").getData().length==1){o.getModel("modelPedido").setProperty("/TipoPedido",o.vetorTipoPedidos[0].TipoPedido)}o.byId("idTipoPedido").setBusy(false);new Promise(function(e,t){o.byId("idVencimento1").setEnabled(true);o.byId("idContrato").setBusy(true);o.byId("idVencimento1").setBusy(true);o.oModel.read("/P_ContratoR(IvBukrs='"+o.getModel("modelPedido").getProperty("/Bukrs")+"',IvKvgr4='"+o.getModel("modelPedido").getProperty("/Kvgr4")+"')",{success:function(t){o.byId("idContrato").setBusy(false);o.byId("idVencimento1").setBusy(false);var a=o.getModel("modelVencimentos1").getData();var d=[];if(t.ContratoInterno!=""){var i="false";var s=0;for(var r=0;r<a.length;r++){if(a[r].Zterm==t.Zterm){i="true";if(String(t.AtlOrdem)=="true"){o.getModel("modelPedido").setProperty("/IndiceFinal",t.IndiceContrato)}else{o.getModel("modelPedido").setProperty("/IndiceFinal",a[r].Kbetr)}break}}if(i=="false"&&t.Zterm!=""){var l={Zterm:t.Zterm,IdVencimento:t.Zterm,DescCond:t.DescCond};d.push(l);o.getModel("modelVencimentos1").setData(d);if(String(t.AtlOrdem)=="true"){o.getModel("modelPedido").setProperty("/IndiceFinal",t.IndiceContrato)}else{o.getModel("modelPedido").setProperty("/IndiceFinal",0)}}debugger;if(t.Zterm==""){o.getModel("modelPedido").setProperty("/Vencimento",a[0].Zterm);o.getModel("modelPedido").setProperty("/IndiceFinal",a[0].Kbetr);o.getModelGlobal("modelPedido").setProperty("/Contrato",t.ContratoInterno)}else{o.getModelGlobal("modelPedido").setProperty("/Vencimento",t.Zterm);o.getModelGlobal("modelPedido").setProperty("/Contrato",t.ContratoInterno)}if(o.getModel("modelPedido").getProperty("/Vencimento")==""){o.byId("idVencimento1").setEnabled(true)}else{o.byId("idVencimento1").setEnabled(false)}var n=o.getModelGlobal("modelPedido").getProperty("/Contrato");var c=parseFloat(o.getModel("modelCliente").getProperty("/CreditLimit"));if(n!=""&&String(t.AtlOrdem)=="false"&&t.Zterm==""){o.byId("idVencimento1").setEnabled(true);o.getModelGlobal("modelPedido").setProperty("/Vencimento","");o.getModel("modelPedido").setProperty("/IndiceFinal",0)}else if(t.Zterm!=""&&n!=""&&c==1){o.getModelGlobal("modelPedido").setProperty("/Vencimento","");o.getModel("modelPedido").setProperty("/IndiceFinal",0)}}else{o.getModel("modelVencimentos1").setData(o.vetorVencimentoTotal)}e()},error:function(e){o.onMensagemErroODATA(e);t()}})}).then(function(e){new Promise(function(e,t){o.byId("idDataEntregaSujerida").setBusy(true);var a="";var d=new Date;Date.prototype.addDays=function(e){var o=new Date(this.valueOf());o.setDate(o.getDate()+parseInt(e,10));return o.toLocaleDateString("pt-BR")};var i=o.getModelGlobal("modelPedido").getProperty("/Txjcd").replace(" ","_");o.oModel.read("/P_LeadTimeR(IvBukrs='"+o.getModel("modelPedido").getProperty("/Bukrs")+"',IvRegCliente='"+o.getModelGlobal("modelPedido").getProperty("/RegCliente")+"',IvRegCentro='"+o.getModelGlobal("modelPedido").getProperty("/RegCentro")+"',IvTxjcd='"+i+"')",{success:function(t){var i=t.Kbetr;o.getModel("modelPedido").setProperty("/LeadTime",i);a=d.addDays(i);o.getModel("modelPedido").setProperty("/DataEntregaSujerida",a);o.byId("idDataEntregaSujerida").setBusy(false);e()},error:function(e){t();o.onMensagemErroODATA(e)}})}).then(function(e){o.oModel.read("/TipoIntegraBol",{urlParameters:{$filter:"IvUsuario eq '"+o.Usuario+"'"},success:function(e){var t=e.results;var a=o.getModel("modelCliente").getProperty("/Kunnr");var d=o.getModel("modelPedido").getProperty("/Bukrs");var i="false";for(var s=0;s<t.length;s++){if(a==t[s].Kunnr&&d==t[s].Bukrs){i="true";break}}if(i=="true"){o.getModelGlobal("modelPedido").setProperty("/TipoIntegrBol","CONTAS A RECEBER")}else{o.getModelGlobal("modelPedido").setProperty("/TipoIntegrBol","CONTAS A PAGAR")}},error:function(e){o.onMensagemErroODATA(e)}})}).catch(function(){o.byId("idDataEntregaSujerida").setBusy(false)})}).catch(function(){o.byId("idContrato").setBusy(false);o.byId("idVencimento1").setBusy(false)})}).catch(function(e){console.log(e);o.byId("idTipoPedido").setBusy(false)})},onCarregarLocalEntrega:function(e){var o=this;for(var t=0;t<o.vetorLocaisEntregas.length;t++){if(e==o.vetorLocaisEntregas[t].Bukrs||o.vetorLocaisEntregas[t].Bukrs==""){o.vetorLocaisEntregasAux.push(o.vetorLocaisEntregas[t])}}o.getModel("modelLocaisEntregas").setData(o.vetorLocaisEntregasAux);o.getModel("modelLocaisEntregas").refresh()},onCarregarTipoPedido:function(e,o){this.vetorTipoPedidos=[];if(e.TipoPedido=="Proposta"){this.vetorTipoPedidos=[];var t={TipoPedido:"Normal"};this.vetorTipoPedidos.push(t);t={TipoPedido:"Proposta"};this.vetorTipoPedidos.push(t)}else if(o!==undefined&&o.DatFimValid!==null){this.vetorTipoPedidos=[];var t={TipoPedido:"Normal"};this.vetorTipoPedidos.push(t);t={TipoPedido:"Proposta"};this.vetorTipoPedidos.push(t)}else{var t={TipoPedido:"Normal"};this.vetorTipoPedidos.push(t)}this.getModel("modelTipoPedidos").setData(this.vetorTipoPedidos)},onChangeVencimento1:function(e){var o=this;var t=e.getSource().getSelectedKey();o.getModelGlobal("modelPedido").setProperty("/IndiceFinal","");for(var a=0;a<o.vetorVencimentoTotal.length;a++){if(o.vetorVencimentoTotal[a].Zterm==t){o.getModelGlobal("modelPedido").setProperty("/IndiceFinal",parseFloat(o.vetorVencimentoTotal[a].Kbetr))}}o.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true)},onChangeDataEntrega:function(e){Date.prototype.addDays=function(e){var o=new Date(this.valueOf());o.setDate(o.getDate()+parseInt(e,10));return o.toLocaleDateString("pt-BR")};Date.prototype.remDays=function(e){var o=new Date(this.valueOf());o.setDate(o.getDate()-parseInt(e-1,10));return o.toLocaleDateString("pt-BR")};this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true);var o=this.getModelGlobal("modelPedido").getData();var t=this.myFormatterDataRevert(o.DataEntrega);var a=this.myFormatterDataRevert(o.DataEntregaSujerida);if(t>a){var d=new Date(Date.UTC(t[1].ano,t[1].mes-1,t[1].dia));var i=d.remDays(o.LeadTime);this.getModelGlobal("modelPedido").setProperty("/DataLimite",i)}else{var s=this.onDataHora();var r=s[2].dia+"/"+s[2].mes+"/"+s[2].ano;this.getModelGlobal("modelPedido").setProperty("/DataLimite",r)}},onBloqueiaPercEntrada:function(e){var o=e.getSource();this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",false);if(o.getValue()>0){this.byId("idPercEntrada").setEnabled(false);this.getModelGlobal("modelPedido").setProperty("/ValorEntradaPedido",parseFloat(o.getValue()))}else{this.byId("idPercEntrada").setEnabled(true)}},onChangeTipoNegociacao:function(e){var o=e.getSource();this.getModelGlobal("modelPedido").setProperty("/TipoNegociacao",o.getSelectedKey());this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",false)},onChangeTipoTransporte:function(e){this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",false)},onChangeDataPedido:function(){this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",false)},onResetarDadosPedido:function(){this.getModelGlobal("modelAux").setProperty("/NrPedido","");this.getModelGlobal("modelAux").setProperty("/ItensPedidoTab",0)},onDeletarItem:function(e){var o=this;var a=e.getParameter("listItem")||e.getSource();var d=a.getBindingContext("modelItensPedidoGrid").getProperty("NrPedido");var i=a.getBindingContext("modelItensPedidoGrid").getProperty("Matnr");var s=a.getBindingContext("modelItensPedidoGrid").getProperty("IdStatusPedido");if(s==3){var r="Não é possível deletar pedidos que já foram integrados!";t.error(r,{icon:t.Icon.ERROR,title:"Deleção de itens do pedido.",actions:[sap.m.MessageBox.Action.OK]})}else if(s==2){r="Reabra o pedido para realizar alterações";t.error(r,{icon:t.Icon.ERROR,title:"Deleção de itens do pedido.",actions:[sap.m.MessageBox.Action.OK]})}else{t.show("Deseja mesmo excluir o Item "+i+" ?",{icon:t.Icon.WARNING,title:"Exclusão de Pedidos",actions:[t.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){o.byId("table_pedidos").setBusy(true);new Promise(function(e,t){o.onDeletarItemPedido(e,t,d,i)}).then(function(e){new Promise(function(e,t){o.onBuscarItensPedido(e,t,d)}).then(function(e){o.vetorItensPedido=e;o.getModelGlobal("modelItensPedidoGrid").setData(o.vetorItensPedido);o.getModelGlobal("modelItensPedidoGrid").refresh();if(o.vetorItensPedido.length==0){o.onBloquearCabecalho(true)}o.getModelGlobal("modelAux").setProperty("/ItensPedidoTab",o.vetorItensPedido.length);o.byId("table_pedidos").setBusy(false);new Promise(function(e,t){o.onBuscarPedido(d,e,t,o)}).then(function(e){o.getModelGlobal("modelPedido").setData(e);o.getModelGlobal("modelPedido").refresh()}).catch(function(e){o.byId("idPedidoDetalhe").setBusy(false);o.onMensagemErroODATA(e)})}).catch(function(e){o.byId("idPedidoDetalhe").setBusy(false);o.onMensagemErroODATA(e)})}).catch(function(e){o.byId("idPedidoDetalhe").setBusy(false);o.onMensagemErroODATA(e)})}}})}},onTablFilterEvent:function(e){var o=this;var a=e.getParameters();var d=indexedDB.open("VB_DataBase");d.onerror=function(){t.show(d.error.mensage,{icon:t.Icon.ERROR,title:"Banco não encontrado!",actions:[t.Action.OK]})};d.onsuccess=function(){var e=d.result;var a=o.getModelGlobal("modelAux").getProperty("/ObrigaSalvar");if(a==false){t.show("Salve o pedido !",{icon:t.Icon.ERROR,title:"Atenção!",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idLiberarItens").focus()}})}}},onChangeAuditoriaObservacoes:function(e){this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",false)},onChangeInfo:function(e){this.getModelGlobal("modelAux").setProperty("/ObrigaSalvar",true)},onTabEvent:function(e){var o=this;var a=e.getParameters();var d=o.getModelGlobal("modelAux").getProperty("/ObrigaSalvar");var i=o.getModel("modelPedido").getData();if(i.IdStatusPedido==1){if(a.selectedKey=="tab3"||a.selectedKey=="tab4"||a.selectedKey=="tab5"){if(i.Pltyp==""){sap.m.MessageBox.show("Preencher a tabela de preço!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(i.Werks==""){sap.m.MessageBox.show("Escolha o estabelecimento!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(i.Vencimento==""){sap.m.MessageBox.show("Preencher a data pagamento!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(i.DataLimite==""){sap.m.MessageBox.show("Preencher a data limite!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(i.TipoPedido==""){sap.m.MessageBox.show("Preencher o tipo de pedido!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(i.DataEntrega==""){sap.m.MessageBox.show("Preencher a Data de Entrega!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(i.LocalEntrega==""){sap.m.MessageBox.show("Preencher a Local de Entrega!",{icon:sap.m.MessageBox.Icon.ERROR,title:"Preecher campo(s)",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2");o.byId("idTabelaPreco").focus()}})}else if(a.selectedKey=="tab3"||a.selectedKey=="tab4"||a.selectedKey=="tab5"){if(d==true){sap.m.MessageBox.show("Salve o pedido !",{icon:sap.m.MessageBox.Icon.ERROR,title:"Atenção!",actions:[t.Action.OK],onClose:function(){o.byId("idTopLevelIconTabBar").setSelectedKey("tab2")}})}else{o.getModelGlobal("modelAux").setProperty("/ItensPedidoTab",o.vetorItensPedido.length);o.onValidacoesCampanha()}}}else{}}},onValidacoesCampanha:function(){var e=this.getModel("modelPedido").getData();if(e.ValDescAplicarBol==""){e.ValDescAplicarBol=0}if(e.ValDescAplicar==""){e.ValDescAplicar=0}var o=e.ValDescDisp;var t=e.MotivoDescNota;var a=parseFloat(e.ValDescAplicar);var d=e.MotivoDescBoleto1;var i=parseFloat(e.ValDescAplicarBol);if(i+a>o){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoAplicar").focus();this.byId("idDescontoAplicar").setValueState("Error");this.byId("idDescontoAplicarBoleto").setValueState("Error");this.byId("idDescontoAplicar").setValueStateText("A soma dos descontos é maior que o permitido de R$ "+o);this.byId("idDescontoAplicarBoleto").setValueStateText("A soma dos descontos é maior que o permitido de R$ "+o)}else{this.byId("idDescontoAplicar").setValueState("None");this.byId("idDescontoAplicarBoleto").setValueState("None");this.byId("idDescontoAplicar").setValueStateText("");this.byId("idDescontoAplicarBoleto").setValueStateText("");if(i>0&&d==""){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoPedidoBoleto").focus();this.byId("idDescontoPedidoBoleto").setValueState("Error");this.byId("idDescontoPedidoBoleto").setValueStateText("Preencher o motivo de desconto!");return}else{this.byId("idDescontoPedidoBoleto").setValueStateText("");this.byId("idDescontoPedidoBoleto").setValueState("None")}if(a>0&&t==""){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoPedido").focus();this.byId("idDescontoPedido").setValueState("Error");this.byId("idDescontoPedido").setValueStateText("Preencher o motivo de desconto!");return}else{this.byId("idDescontoPedido").setValueState("None");this.byId("idDescontoPedido").setValueStateText("");this.byId("idDescontoPedidoBoleto").setValueState("None");this.byId("idDescontoPedidoBoleto").setValueStateText("")}}if(e.ValDescCampInform==""){e.ValDescCampInform=0}var s=e.ValDescCampDisp;var r=e.ValDescCampInform;var l=e.MotivoDescCamp;if(r>s){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoAplicarCamp").focus();this.byId("idDescontoAplicarCamp").setValueState("Error");this.byId("idDescontoAplicarCamp").setValueStateText("A soma dos descontos é maior que o permitido de R$ "+s);return}else{if(r>0&&l==""){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoPedidoCamp").focus();this.byId("idDescontoPedidoCamp").setValueState("Error");this.byId("idDescontoPedidoCamp").setValueStateText("Preencher o motivo de desconto!");return}else{this.byId("idDescontoAplicarCamp").setValueState("None");this.byId("idDescontoAplicarCamp").setValueStateText("");this.byId("idDescontoPedidoCamp").setValueState("None");this.byId("idDescontoPedidoCamp").setValueStateText("")}}if(e.ValDescCampInformBol==""){e.ValDescCampInformBol=0}var n=e.ValDescCampDispBol;var c=e.ValDescCampInformBol;var m=e.MotivoDescBoleto2;if(c>n){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoAplicarCampBol").focus();this.byId("idDescontoAplicarCampBol").setValueState("Error");this.byId("idDescontoAplicarCampBol").setValueStateText("A soma dos descontos é maior que o permitido de R$ "+n);return}else{if(c>0&&m==""){this.byId("idTopLevelIconTabBar").setSelectedKey("tab4");this.byId("idDescontoPedidoCampBol").focus();this.byId("idDescontoPedidoCampBol").setValueState("Error");this.byId("idDescontoPedidoCampBol").setValueStateText("Preencher o motivo de desconto!");return}else{this.byId("idDescontoPedidoCampBol").setValueStateText("");this.byId("idDescontoPedidoCampBol").setValueState("None");this.byId("idDescontoAplicarCampBol").setValueStateText("");this.byId("idDescontoAplicarCampBol").setValueState("None");console.log("Validações da Campanha estão OK!")}}if(e.TipoPedido=="Proposta"){this.byId("idTextCamp").setVisible(false);this.byId("idBtnCamp").setVisible(false)}else{this.byId("idTextCamp").setVisible(true);this.byId("idBtnCamp").setVisible(true)}},onBloquearCabecalho:function(e){this.byId("idEstabelecimento").setEnabled(e);this.byId("idTabelaPreco").setEnabled(e);this.byId("idVencimento1").setEnabled(e);this.byId("idDataLimite").setEnabled(true);this.byId("idDataEntrega").setEnabled(e);this.byId("idTipoPedido").setEnabled(e);this.byId("idLocalEntrega").setEnabled(e);this.byId("idTipoTransporte").setEnabled(e);if(status==2){this.byId("idMsg1").setEnabled(e);this.byId("idMsg2").setEnabled(e);this.byId("idMsg3").setEnabled(e);this.byId("idPedidoOrigem").setEnabled(e);this.byId("idEmailCliente").setEnabled(e);this.byId("idObservacoes").setEnabled(e)}else{this.byId("idMsg1").setEnabled(true);this.byId("idMsg2").setEnabled(true);this.byId("idMsg3").setEnabled(true);this.byId("idPedidoOrigem").setEnabled(true);this.byId("idEmailCliente").setEnabled(true);this.byId("idObservacoes").setEnabled(true)}},bloquearCampos:function(){this.byId("idEstabelecimento").setProperty("enabled",false);this.byId("idTipoPedido").setProperty("enabled",false);this.byId("idVencimento1").setProperty("enabled",false);this.byId("idVencimento2").setProperty("enabled",false);this.byId("idVencimento3").setProperty("enabled",false);this.byId("idTabelaPreco").setProperty("enabled",false);this.byId("idFormaPagamento").setProperty("enabled",false);this.byId("idTipoTransporte").setProperty("enabled",false)},desbloquearCampos:function(){this.byId("idEstabelecimento").setProperty("enabled",true);this.byId("idTipoPedido").setProperty("enabled",true);this.byId("idVencimento1").setProperty("enabled",true);this.byId("idVencimento2").setProperty("enabled",true);this.byId("idVencimento3").setProperty("enabled",true);this.byId("idTabelaPreco").setProperty("enabled",true);this.byId("idFormaPagamento").setProperty("enabled",true);this.byId("idTipoTransporte").setProperty("enabled",true)},resetarCamposTela:function(){this.byId("idNumeroPedido").setValue("");this.byId("idSituacao").setValue("");this.byId("idDataPedido").setValue("");this.byId("idTipoPedido").setSelectedKey("");this.byId("idTipoNegociacao").setSelectedKey("");this.byId("idTabelaPreco").setSelectedKey("");this.byId("idFormaPagamento").setSelectedKey("");this.byId("idTipoTransporte").setSelectedKey("");this.byId("idPrimeiraParcela").setValue("");this.byId("idQuantParcelas").setValue("");this.byId("idIntervaloParcelas").setValue("");this.byId("idValorMinimoPedido").setValue("");this.byId("idObservacoes").setText("")},onNovoItem:function(){console.log("onitempress standard");var e=this;var o=this.getModelGlobal("modelPedido").getProperty("/IdStatusPedido");var a=this.getModelGlobal("modelPedido").getProperty("/TipoPedido");e.oItemPedido=[];if(o==3){t.show("Este pedido não pode mais ser alterado",{icon:t.Icon.WARNING,title:"Não Permitido",actions:[t.Action.OK]})}else if(o==2){t.show("Reabra o pedido para realizar alterações!",{icon:t.Icon.WARNING,title:"Não Permitido",actions:[t.Action.OK]})}else{sap.ui.core.UIComponent.getRouterFor(this).navTo("pedidoDetalheItens")}},onFinalizarPedido:function(){var e=this;var o=this.getModel("modelPedido").getData();var a=e.getModel("modelItensPedidoGrid").getData().length;if(a<=0){sap.m.MessageBox.show("O pedido deve conter no mínimo 1 item.",{icon:sap.m.MessageBox.Icon.ERROR,title:"Falha ao Completar Pedido",actions:[t.Action.OK]})}else if(o.TipoPedido!=="Proposta"&&parseFloat(o.ValMinPed)>parseFloat(o.ValorTotal)){sap.m.MessageBox.show("Pedido não atingiu o valor mínimo estipulado pela empresa de R$: "+parseFloat(o.ValMinPed),{icon:sap.m.MessageBox.Icon.ERROR,title:"Falha ao Completar Pedido",actions:[t.Action.OK]})}else if(o.IdStatusPedido==3){sap.m.MessageBox.show("Este pedido não pode mais ser alterado",{icon:sap.m.MessageBox.Icon.WARNING,title:"Não Permitido",actions:[t.Action.OK]})}else{e.byId("idPedidoDetalhe").setBusy(true);var d=this.onDataHora();o.SituacaoPedido="PEND";o.IdStatusPedido=2;o.DataFim=d[0];o.HoraFim=d[1];o.Completo=true;e.onLimparValueState("None");o=e.onFormatNumberPedido(o);delete o.__metadata;e.byId("idPedidoDetalhe").setBusy(true);new Promise(function(t,a){e.onInserirPedido(o,t,a,e)}).then(function(a){if(a.TipoErro=="E"){sap.m.MessageBox.show(a.MsgErro,{icon:sap.m.MessageBox.Icon.ERROR,title:"Não Permitido",actions:[t.Action.OK],onClose:function(){o.SituacaoPedido="EM DIGITAÇÃO";o.IdStatusPedido=1;o.DataFim="";o.HoraFim="";o.Completo=false}})}else{sap.m.MessageBox.show("Pedido salvo com sucesso !! \n\n Deseja enviar o pedido agora ?",{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso!",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(a){e.onResetarDadosPedido();if(a==sap.m.MessageBox.Action.NO){sap.ui.core.UIComponent.getRouterFor(e).navTo("pedido")}else{new Promise(function(t,a){o.SituacaoPedido="FIN";o.IdStatusPedido=3;o.DataFim=d[0];o.HoraFim=d[1];o.Completo=true;e.onLimparValueState("None");o=e.onFormatNumberPedido(o);delete o.__metadata;e.onInserirPedido(o,t,a,e)}).then(function(o){if(o.TipoErro=="E"){sap.m.MessageBox.show(o.MsgErro,{icon:sap.m.MessageBox.Icon.ERROR,title:"Não Permitido",actions:[t.Action.OK]})}else{sap.m.MessageBox.show("Pedido enviado com sucesso !! \n\n Número Pedido SAP: "+o.Vbeln,{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Sucesso!",actions:["OK"],onClose:function(o){sap.ui.core.UIComponent.getRouterFor(e).navTo("pedido");e.byId("idPedidoDetalhe").setBusy(false);e.onLiberarAbas()}})}}).catch(function(o){e.byId("idPedidoDetalhe").setBusy(false);e.onMensagemErroODATA(o)})}}})}}).catch(function(t){o.SituacaoPedido="EM DIGITAÇÃO";o.IdStatusPedido=1;o.DataFim="";o.HoraFim="";o.Completo=false;e.byId("idPedidoDetalhe").setBusy(false);e.onMensagemErroODATA(t)})}},onAbrirTela:function(){var e=new o({table:false});this.getView().setModel(e,"modelDelay");if(this._ItemDialog){this._ItemDialog.destroy(true)}if(!this._CreateMaterialFragment){this._ItemDialog=sap.ui.xmlfragment("application.view.ItensCampanha",this);this.getView().addDependent(this._ItemDialog)}this._ItemDialog.open()},onBuscarCampanhaAtiva:function(){var e=this;var t={dialog:true};var a=new o(t);e.setModel(a,"modelDelay");e.oModel.read("/P_ItensCampQ",{urlParameters:{$filter:"EvNrPedido eq '"+e.getModel("modelPedido").getProperty("/NrPedido")+"'"},success:function(t){var a=new o(t.results);e.setModel(a,"modelItensCampanha");e.getModel("modelDelay").setProperty("/dialog",false)},error:function(o){e.getModel("modelDelay").setProperty("/dialog",false);e.onMensagemErroODATA(o)}})},onExportarPedido:function(){var e,o,t,a,d;var s=this.getModelGlobal("modelItensPedidoGrid");var r=this.getModel("modelPedido").getData();var l=this.getModel("modelCliente").getData();var n=this.getModel("modelVencimentos1").getData();var c=this.getModel("modelFretes").getData();var m=this.getModel("modelLocaisEntregas").getData();var g=this.getModel("modelCentros").getData();var p="";var b="";var P="";var u="";var y="";for(var h=0;h<n.length;h++){if(n[h].Zterm==r.Vencimento){p=n[h].DescCond;break}}for(var h=0;h<c.length;h++){if(c[h].Inco1==r.Inco1){b=c[h].Bezei;break}}for(var h=0;h<m.length;h++){if(m[h].Addrnumber==r.LocalEntrega){P=m[h].Rua;u=m[h].Cidade;break}}for(var h=0;h<g.length;h++){if(g[h].Werks==r.Werks){y=g[h].NomeCentro;break}}if(!this._oTable){this._oTable=this.byId("table_pedidos")}d=this._oTable;o=d.getBinding("items");e=this.createColumnConfig();t={workbook:{columns:e,context:{application:"Aplicação Força de Vendas",title:"Espelho do Pedido",modifiedBy:"Repres: "+this.getModelGlobal("modelAux").getProperty("/Usuario"),metaSheetName:"Cabeçalho Pedido",metainfo:[{name:"Resumo do pedido",items:[{key:"Ordem de venda",value:r.Vbeln},{key:"Data Criação",value:r.DataFim}]},{name:"Dados Fornecedor",items:[{key:"Vendedor",value:this.getModelGlobal("modelAux").getProperty("/Usuario")},{key:"Centro",value:r.Werks+"-"+y}]},{name:"Dados Cliente",items:[{key:"Cliente",value:l.Kunnr},{key:"CNPJ Cliente",value:l.Stcd1+l.Stcd2},{key:"Endereço",value:l.Stras},{key:"Cidade/ UF",value:l.Ort01},{key:"CEP",value:l.Pstlz},{key:"Fone/ Cel",value:l.Telf1},{key:"E-mail envio XML",value:l.EmailNf}]},{name:"Dados de Negociação",items:[{key:"Prazo de pagamento",value:r.Vencimento+"-"+p},{key:"Tipo de Frete",value:r.Inco1+"-"+b},{key:"Endereço de entrega",value:P},{key:"Cidade de entrega",value:u}]},{name:"Investimentos",items:[{key:"Em Nota Fiscal",value:r.ValDescAplicar},{key:"Em Boleto",value:r.ValDescAplicarBol}]},{name:"Composição do pedido",items:[{key:"QTD",value:r.TotalItens},{key:"Preço Total s/ST",value:r.ValorTotal},{key:"Preço Total c/ST",value:r.ValTotItemSt},{key:"Peso Bruto (KG)",value:r.PesoBruto}]}]},hierarchyLevel:"level",sheetName:""},dataSource:o,fileName:"Pedido"+r.Vbeln+".xlsx"};a=new i(t);a.build().finally(function(){a.destroy()})},createColumnConfig:function(){var e=[];e.push({label:"Material",property:"Matnr",type:s.Number});e.push({label:"Descrição",property:"Maktx",type:s.String});e.push({label:"U.M.",property:"Vrkme",type:s.String});e.push({label:"QTD",property:"QtdPedida",type:s.Number});e.push({label:"Preço Unit. s/ST",property:"ValPrecoTabelaMin",type:s.Number,scale:2,delimiter:true});e.push({label:"Preço Total s/ST",property:"ValorTotal",type:s.Number,scale:2,delimiter:true});e.push({label:"% ST",property:"PerSubTri",type:s.Number,scale:2,delimiter:true});e.push({label:"Preço Unit. c/ST",property:"ValPrecoUnitStFat",type:s.Number,scale:2,delimiter:true});e.push({label:"Preço Total c/ST",property:"ValTotItemSt",type:s.Number,scale:2,delimiter:true});e.push({label:"Peso Bruto (KG)",property:"PesoBruto",type:s.Number,scale:2,delimiter:true});return e}})});