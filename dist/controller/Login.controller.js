sap.ui.define(["sap/ui/core/mvc/Controller","application/controller/BaseController","sap/m/MessageBox"],function(e,o,t){"use strict";var n=false;var a=[];return o.extend("application.controller.Login",{onInit:function(){this.getRouter().getRoute("login").attachPatternMatched(this._onLoadFields,this)},_onLoadFields:function(){var e=this;this.onInicializaModels();this.getOwnerComponent().getModel("modelAux").setProperty("/ReleasePRD",false);this.getOwnerComponent().getModel("modelAux").setProperty("/VersaoApp","1.0");this.getOwnerComponent().getModel("modelAux").setProperty("/Werks","1000");this.getOwnerComponent().getModel("modelAux").setProperty("/EditarIndexItem",0);this.getOwnerComponent().getModel("modelAux").setProperty("/bConectado",false);this.getOwnerComponent().getModel("modelAux").setProperty("/SistemaOper","02");var o;if(this.getOwnerComponent().getModel("modelAux").getProperty("/ReleasePRD")){o="https://srvaplsapdev.predilecta.com.br:10443/sap/opu/odata/sap/ZSF_FV_SRV/";var t=new sap.ui.model.odata.v2.ODataModel(o,{json:true,user:"t_rcardilo",password:"sap123"});this.getView().setModel(t);this.getOwnerComponent().getModel("modelAux").setProperty("/DBModel",t)}else{this.getOwnerComponent().getModel("modelAux").setProperty("/DBModel",this.getView().getModel())}},onInicializaModels:function(){var e=new sap.ui.model.json.JSONModel({CodRepres:"",Imei:"",VersaoApp:"",Login:"",Senha:"",SistemaOper:"02",DataAtualizacao:"",Kunnr:"",NrPedido:"",EditarIndexItem:"",bConectado:false,DBModel:"",ReleasePRD:"",Lifnr:"",Email:""});this.getOwnerComponent().setModel(e,"modelAux");var o=new sap.ui.model.json.JSONModel;this.getOwnerComponent().setModel(o,"modelCliente");this.getOwnerComponent().setModel(o,"modelMenu")},retornaDataAtualizacao:function(){var e=new Date;var o=String(e.getDate());var t=String(e.getMonth()+1);var n=String(e.getFullYear());n=n.substring(2,4);var a=String(e.getMinutes());var i=String(e.getHours());var s=String(e.getSeconds());if(o.length==1){o="0"+String(o)}if(t.length==1){t="0"+String(t)}if(a.length==1){a="0"+String(a)}if(i.length==1){i="0"+String(i)}if(s.length==1){s="0"+String(s)}var r=String(o+"/"+t+"/"+n);var l=String(i)+":"+String(a);return r+" - "+l},getPermissao:function(){var e=this;function o(o){if(o=="OK"){e.getImei()}else{t.show("A recusa do acesso resultará a falha na autenticação. Deseja permitir?",{icon:t.Icon.ERROR,title:"Erro ao atualizar bases.",actions:[t.Action.YES,t.Action.NO],onClose:function(o){if(o==t.Action.YES){e.getPermissao()}}})}}function n(e){console.log(e)}if(window.device.platform==="Android"){window.plugins.sim.requestReadPermission(this.successCallbackPermissao,this.errorCallbackPermissao)}},getImei:function(){var e=this;var o=this.getOwnerComponent().getModel("modelAux").getProperty("/isTablet");var o="Android";window.plugins.sim.hasReadPermission(t,t);function t(e){if(e==true){window.plugins.sim.getSimInfo(a,i)}else{window.plugins.sim.requestReadPermission(s,r)}}function n(e){console.log(e)}function a(o){e.getOwnerComponent().getModel("modelAux").setProperty("/Imei",o.deviceId);console.log(o)}function i(e){console.log(e)}function s(e){console.log(e)}function r(e){console.log(e)}},onAfterRendering:function(){},onBusyDialogClosed:function(){if(this._ItemDialog){this._ItemDialog.destroy(true)}},onOpenMudarSenha:function(){var e=this;if(e._ItemDialog){e._ItemDialog.destroy(true)}if(!e._CreateMaterialFragment){e._ItemDialog=sap.ui.xmlfragment("application.view.AlterarSenha",e);e.getView().addDependent(e._ItemDialog)}e._ItemDialog.open()},onPularSenha:function(){sap.ui.getCore().byId("idSenha").focus()},onPularSenha1:function(){sap.ui.getCore().byId("idSenhaNova").focus()},onPularSenha2:function(){sap.ui.getCore().byId("idSenhaNova2").focus()},onDialogMudarSenha:function(){var e=this;var o=this.getModelGlobal("modelAux").getData();var n=sap.ui.getCore().byId("idSenhaNova").getValue();var a=sap.ui.getCore().byId("idSenhaNova2").getValue();if(o.CodRepres==""||o.CodRepres=="undefined"){sap.m.MessageBox.show("Preencher o código do representante!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Corrija os Campos!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){sap.ui.getCore().byId("idCodRepres").focus()}})}else if(o.Senha==""||o.Senha=="undefined"){sap.m.MessageBox.show("Preencher a Senha atual!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Corrija os Campos!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){sap.ui.getCore().byId("idSenha").focus()}})}else if(n!=a){sap.m.MessageBox.show("As Senhas são diferentes!",{icon:sap.m.MessageBox.Icon.WARNING,title:"Corrija os Campos!",actions:[sap.m.MessageBox.Action.OK],onClose:function(e){sap.ui.getCore().byId("idSenhaNova").focus()}})}else{sap.ui.getCore().byId("idDialogAlterarSenha").setBusy(true);o.DBModel.read("/TrocarSenha(IvUsuario='"+o.CodRepres+"',IvSenha='"+o.Senha+"',IvSistOper='"+o.SistemaOper+"',IvImei='"+o.Imei+"',IvVersaoApp='"+o.VersaoApp+"',IvSenhaNova='"+n+"')",{success:function(o){t.show("Senha foi alterada com sucesso!",{icon:t.Icon.SUCCESS,title:"Confirmação",actions:[t.Action.OK],onClose:function(){if(e._ItemDialog){e._ItemDialog.destroy(true)}}})},error:function(o){sap.ui.getCore().byId("idDialogAlterarSenha").setBusy(false);e.onMensagemErroODATA(o)}})}},onFecharAlteracaoSenha:function(){if(this._ItemDialog){this._ItemDialog.destroy(true)}},onStartWorking:function(){var e=this;this.getView().byId("idPageLogin").setBusy(true);var o=this.byId("idLogin").getValue();var t=this.byId("idSenha").getValue();var n="WEB";var a=this.getOwnerComponent().getModel("modelAux").getProperty("/VersaoApp");var i=e.getOwnerComponent().getModel("modelAux").getProperty("/DBModel");var s=e.getOwnerComponent().getModel("modelAux").getProperty("/SistemaOper");i.read("/Logins(IvUsuario='"+o+"',IvSenha='"+t+"',IvSistOper='"+s+"',IvImei='"+n+"',IvVersaoApp='"+a+"')",{success:function(n){e.getModelGlobal("modelAux").setProperty("/CodRepres",o);e.getModelGlobal("modelAux").setProperty("/Login",o);e.getModelGlobal("modelAux").setProperty("/Senha",t);e.getModelGlobal("modelAux").setProperty("/Lifnr",n.EvLifnr);e.getModelGlobal("modelAux").setProperty("/Email",n.EvEmail);i.read("/Menus",{urlParameters:{$filter:"IvUsuario eq '"+o+"' and IvSistOper eq '"+s+"'"},success:function(o){var t=o.results.sort();e.getModelGlobal("modelMenu").setData(t);sap.m.MessageBox.show("Usuário autenticado com sucesso!",{icon:sap.m.MessageBox.Icon.SUCCESS,title:"Autenticação!",actions:[sap.m.MessageBox.Action.OK],onClose:function(o){sap.ui.core.UIComponent.getRouterFor(e).navTo("menu");e.getView().byId("idPageLogin").setBusy(false)}})},error:function(o){e.getView().byId("idPageLogin").setBusy(false);console.log(o);e.onMensagemErroODATA(o)}})},error:function(o){e.getView().byId("idPageLogin").setBusy(false);console.log(o);e.onMensagemErroODATA(o)}})},onLoginChange:function(){sap.ui.getCore().byId("idSenha").focus()},onDialogPromocoesCancelButton:function(){if(this._ItemDialog){this._ItemDialog.destroy(true)}}})});