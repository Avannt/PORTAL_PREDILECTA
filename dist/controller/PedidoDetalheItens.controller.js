sap.ui.define(["application/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","application/model/formatter","sap/ui/model/odata/v2/ODataModel"],function(e,t,o,d,a){"use strict";return e.extend("application.controller.PedidoDetalheItens",{formatter:d,onInit:function(){this.getRouter().getRoute("pedidoDetalheItens").attachPatternMatched(this.onLoadFields,this)},onLoadFields:function(){var e=this;var o=e.getModelGlobal("modelAux").getProperty("/CodRepres");var d=e.getModelGlobal("modelPedido").getProperty("/Werks");e.getView().byId("IdItemPedido").setBusy(true);var a=new t({changeQnt:false,changePreco:false,changePromo:false});this.setModel(a,"modelAtualizarItem");e.vetorProdutos=[];var r=new t(e.vetorProdutos);this.setModel(r,"modelProdutos");e.onInicializaCamposItens();new Promise(function(t,d){e.onBuscarProdutos(o,t,d,e)}).then(function(t){e.vetorProdutos=t.filter(function(e,t){if(e.Werks==d){delete e.__metadata;return e}});e.getModel("modelProdutos").setData(e.vetorProdutos);e.getView().byId("IdItemPedido").setBusy(false);e.getView().byId("IdItemPedido").focus()}).catch(function(t){e.getView().byId("IdItemPedido").setBusy(false);e.onMensagemErroODATA(t)})},onLiveChangeQuantidade:function(){this.getModel("modelAtualizarItem").setProperty("/changeQnt",true)},onLiveChangePromocao:function(){this.getModel("modelAtualizarItem").setProperty("/changePromo",true)},onLiveChangePreco:function(){this.getModel("modelAtualizarItem").setProperty("/changePreco",true)},onInicializaCamposItens:function(){var e=this;e.oModel=this.getModelGlobal("modelAux").getProperty("/DBModel");this.ItemPedido={IdItem:"",IndexItem:0,NrPedido:"",Matnr:"",Maktx:"",Meins:"",ValPrecoInform:0,ValPrecoInformAntigo:0,ValPrecoUnitSt:0,ValPrecoUnit:0,ValPrecoUnitStFat:0,ValorTotal:0,ValPrecoOrig:0,ValTotItemSt:0,ValPrecoMin:0,PrecoMinBase:0,ValPrecoMax:0,QtdPedida:1,TotalDesc:0,PercCanal:0,PercCanalMax:0,CondPercCanal:0,PercCampFlex:0,CondCampFlex:0,PrecoSt:0,CondPrecoSt:0,PercPromo:0,PercPromoMax:0,CondPercPromoMax:0,ValDescDisp:0,ValLiqItem:0,QtdUnFat:0,ValVerbaItem:0,VerbaOrig:0,PathImg:"",PerSubTri:0,CodCampanha:"",ValPctDescCamp:0,QtdMultiplaCamp:0,ValPctDescontoReduc:0,ExcIncent:false,ExcVerba:false,PercComissao:0,CondPercComissao:"",PercCustoFixo:0,CondPercCustoFixo:"",PercCpmf:0,CondPercCpmf:"",PercGanho:0,CondPercGanho:"",PercIr:0,CondPercIr:"",ValPrecoBase:0,CondValPrecoBase:"",PercPromoRent:0,CondPercPromoRent:"",AliquotaIcm:0,CondAliquotaIcm:"",PercLucro:0,ValLucro:0,PercCofins:0,CondPercCofins:"",PercPis:0,CondPercPis:"",RentImg:"",PercRoyalties:0,CondPercRoyalties:"",PercFrete:0,CondPercFrete:"",Provg:"",ValCustoFixo:0,ValFinsocial:0,ValRoyalties:0,ValIcmsIt:0,ValPis:0,ValFinSocial:0,ValPromocao:0,ValGanho:0,ValCpmf:0,ValIr:0,ValComissao:0,ValContrato:0,ValFrete:0,ValVerbaOrig:0,ValPrecoTabela:0,ValPrecoTabelaMin:0,ValPrecoMinBase:0,PctDescContrato:0,Ntgew:0,Mvgr1:0,Mvgr2:0,Mvgr3:0,Mvgr4:0,Mvgr5:0,Mtpos:0,VerbaRepres:0,Draft:false,DataUltCompraUltMes:null,QtdUltCompraUltMes:0,ValorUltCompraUltMes:0};var o=new t(this.ItemPedido);this.setModelGlobal(o,"modelItem");var d={Editar:false};var a=new t(d);this.setModel(a,"modelVar");e.getView().byId("IdItemPedido").setEnabled(true);e.getView().byId("idPrecoVenda").setEnabled(true);e.getView().byId("idPromocao").setEnabled(true);e.getView().byId("idQuantidade").setEnabled(true);setTimeout(function(){e.getView().byId("IdItemPedido").focus()},1e3)},onSuggestProdutos:function(e){var t=e.getSource().getValue();var o=[];var d=[new sap.ui.model.Filter("Matnr",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("Maktx",sap.ui.model.FilterOperator.Contains,t)];var a=new sap.ui.model.Filter(d,false);o.push(a);this.byId("IdItemPedido").getBinding("suggestionItems").filter(o);this.byId("IdItemPedido").suggest()},onItemChange:function(){var e=this;this.getModelGlobal("modelItem").setProperty("/QtdPedida",1);var t={Matnr:this.getModelGlobal("modelItem").getProperty("/Matnr"),QtdPedida:this.getModelGlobal("modelItem").getProperty("/QtdPedida"),PercPromo:this.getModelGlobal("modelItem").getProperty("/PercPromo"),ValPrecoInform:this.getModelGlobal("modelItem").getProperty("/ValPrecoInform"),NrPedido:this.getModelGlobal("modelPedido").getProperty("/NrPedido"),Evento:"ChangeItem",Editar:String(this.getModel("modelVar").getProperty("/Editar"))};if(t.Matnr!=""){var d=false;for(var a=0;a<e.vetorProdutos.length;a++){if(e.vetorProdutos[a].Matnr==t.Matnr){d=true;break}}if(d===false){o.show("Item não permitido para digitação!",{icon:o.Icon.WARNING,title:"Não Permitido",actions:[o.Action.OK],onClose:function(){e.getModelGlobal("modelItem").setProperty("/Matnr","");e.getView().byId("IdItemPedido").focus()}})}else if(t.QtdPedida<0){o.show("A quantidade de itens deve ser maior que 0",{icon:o.Icon.WARNING,title:"Não Permitido",actions:[o.Action.OK],onClose:function(){e.getView().byId("idQuantidade").focus()}})}else{e.byId("idItens").setBusy(true);e.onCallPrecoItem(t);setTimeout(function(){e.getView().byId("idQuantidade").focus()},500)}}else{e.onInicializaCamposItens();e.getView().byId("IdItemPedido").suggest()}},onQuantidadeChange:function(e,t){var d=this;var a={Matnr:this.getModelGlobal("modelItem").getProperty("/Matnr"),QtdPedida:this.getModelGlobal("modelItem").getProperty("/QtdPedida"),PercPromo:this.getModelGlobal("modelItem").getProperty("/PercPromo"),ValPrecoInform:this.getModelGlobal("modelItem").getProperty("/ValPrecoInform"),NrPedido:this.getModelGlobal("modelPedido").getProperty("/NrPedido"),Evento:"ChangeQuantidade",Editar:String(this.getModel("modelVar").getProperty("/Editar"))};if(a.Matnr!=""){if(a.QtdPedida>0){d.byId("idItens").setBusy(true);d.onCallPrecoItem(a,e,t)}else{o.show("A quantidade de itens deve ser maior que 0",{icon:o.Icon.WARNING,title:"Não Permitido",actions:[o.Action.OK],onClose:function(){d.getView().byId("idQuantidade").focus();d.getModelGlobal("modelItem").setProperty("/QtdPedida",1)}})}}else{d.getView().byId("IdItemPedido").suggest()}},onPrecoVendaChange:function(e,t){var d=this;var a={Matnr:this.getModelGlobal("modelItem").getProperty("/Matnr"),QtdPedida:this.getModelGlobal("modelItem").getProperty("/QtdPedida"),PercPromo:this.getModelGlobal("modelItem").getProperty("/PercPromo"),ValPrecoInform:this.getModelGlobal("modelItem").getProperty("/ValPrecoInform"),NrPedido:this.getModelGlobal("modelPedido").getProperty("/NrPedido"),Evento:"ChangePrecoVenda",Editar:String(this.getModel("modelVar").getProperty("/Editar"))};if(a.Matnr!=""){if(a.QtdPedida>0){d.byId("idItens").setBusy(true);d.onCallPrecoItem(a,e,t)}else{o.show("A quantidade de itens deve ser maior que 0",{icon:o.Icon.WARNING,title:"Não Permitido",actions:[o.Action.OK],onClose:function(){d.getView().byId("idQuantidade").focus()}})}}else{d.getView().byId("IdItemPedido").suggest()}},onPromocaoChange:function(e,t){var o=this;var d={Matnr:this.getModelGlobal("modelItem").getProperty("/Matnr"),QtdPedida:this.getModelGlobal("modelItem").getProperty("/QtdPedida"),PercPromo:this.getModelGlobal("modelItem").getProperty("/PercPromo"),ValPrecoInform:this.getModelGlobal("modelItem").getProperty("/ValPrecoInform"),NrPedido:this.getModelGlobal("modelPedido").getProperty("/NrPedido"),Evento:"ChangePromocao",Editar:String(this.getModel("modelVar").getProperty("/Editar"))};var a=o.getModelGlobal("modelItem").getProperty("/PercPromo");var r=o.getModelGlobal("modelItem").getProperty("/PercPromoMax");if(a==""||a<0){o.getModelGlobal("modelItem").setProperty("/PercPromo",0)}else{if(parseFloat(a)>parseFloat(r)){o.getModelGlobal("modelItem").setProperty("/PercPromo",r)}o.onCallPrecoItem(d,e,t)}},onCallPrecoItem:function(e,t,d){var a=this;a.byId("idItens").setBusy(true);this.onFormatNumberItem(e);a.oModel.callFunction("/P_Get_PrecoItem",{method:"POST",urlParameters:e,success:function(e,d){var r=e;if(r.TipoErro=="E"){o.show(r.MsgErro,{icon:o.Icon.WARNING,title:"Não Permitido",actions:[o.Action.OK],onClose:function(){a.byId("idItens").setBusy(false)}})}else{a.getModelGlobal("modelItem").setData(r);a.byId("idItens").setBusy(false);a.getModel("modelAtualizarItem").setProperty("/changePromo",false);a.getModel("modelAtualizarItem").setProperty("/changeQnt",false);a.getModel("modelAtualizarItem").setProperty("/changePreco",false);try{t(r)}catch(e){console.log(e)}}},error:function(e){a.byId("idItens").setBusy(false);a.onMensagemErroODATA(e);try{d()}catch(e){console.log(e)}}})},onInserirItem:function(){var e=this;var t=e.getModel("modelItem").getData();new Promise(function(o,d){if(e.getModel("modelAtualizarItem").getProperty("/changePromo")==true){e.onPromocaoChange(o,d)}else if(e.getModel("modelAtualizarItem").getProperty("/changeQnt")==true){e.onQuantidadeChange(o,d)}else if(e.getModel("modelAtualizarItem").setProperty("/changePreco")==true){e.onPrecoVendaChange(o,d)}else{o(t)}}).then(function(d){var a=e.byId("idBtnAdd");e.byId("idItens").setBusy(true);e.oModel.setUseBatch(false);e.oModel.refreshSecurityToken();delete d.__metadata;if(d.Matnr===""){o.show("Selecione um produto.",{icon:sap.m.MessageBox.Icon.ERROR,title:"Falha ao inserir",actions:[o.Action.OK],onClose:function(){e.byId("idItens").setBusy(false)}})}else if(d.QtdPedida===""||d.QtdPedida<=0){sap.m.MessageBox.show("Digite uma quantidade acima de 0.",{icon:sap.m.MessageBox.Icon.ERROR,title:"Campo Inválido!",actions:[o.Action.OK],onClose:function(){e.byId("idItens").setBusy(false);d.QtdPedida=1}})}else{a.setEnabled(false);if(e.getModel("modelVar").getProperty("/Editar")){t.Draft=true}e.onFormatNumberItem(d);e.oModel.create("/P_ItensPedidoPR",d,{method:"POST",success:function(t){var o=e.getModelGlobal("modelItensPedidoGrid").getData();delete t.__metadata;if(e.getModel("modelVar").getProperty("/Editar")){a.setText("Inserir");e.getView().byId("idBtnAdd").setVisible(true);e.getModel("modelVar").setProperty("/Editar",false);e.getView().byId("IdItemPedido").setEnabled(true);for(var d=0;d<o.length;d++){if(o[d].Matnr==t.Matnr){o[d]=t}}}else{o.push(t)}e.getView().byId("idPrecoVenda").setEnabled(true);e.getView().byId("idPromocao").setEnabled(true);e.getView().byId("idQuantidade").setEnabled(true);a.setEnabled(true);e.byId("idItens").setBusy(false);e.onInicializaCamposItens();e.getModelGlobal("modelItensPedidoGrid").refresh()},error:function(t){e.byId("idItens").setBusy(false);a.setEnabled(true);e.onMensagemErroODATA(t)}})}})},onEditarItemPress:function(e){var t=this;var o=e.getParameter("listItem")||e.getSource();var d=o.getBindingContext("modelItensPedidoGrid").getObject();this.getModelGlobal("modelItem").setData(d);this.getModel("modelVar").setProperty("/Editar",true);this.getView().byId("idBtnAdd").setText("Salvar");this.getView().byId("IdItemPedido").setEnabled(false);this.getView().byId("idBtnAdd").setVisible(true);setTimeout(function(){t.getView().byId("idQuantidade").focus()},500)},onAtualizarItemPress:function(e){this.getView().byId("idBtnEditar").setVisible(false);this.getView().byId("idBtnAdd").setVisible(true);this.getView().byId("IdItemPedido").setEnabled(false);this.getView().byId("idPrecoVenda").setEnabled(false);this.getView().byId("idPromocao").setEnabled(false);this.getView().byId("idQuantidade").setEnabled(false)},onDeletarItem:function(e){var t=this;var d=e.getParameter("listItem")||e.getSource();var a=d.getBindingContext("modelItensPedidoGrid").getProperty("NrPedido");var r=d.getBindingContext("modelItensPedidoGrid").getProperty("Matnr");var i=d.getBindingContext("modelItensPedidoGrid").getProperty("IdStatusPedido");if(i==3){var n="Não é possível deletar pedidos que já foram integrados!";o.error(n,{icon:o.Icon.ERROR,title:"Deleção de itens do pedido.",actions:[sap.m.MessageBox.Action.OK]})}else if(i==2){n="Reabra o pedido antes de editar!";o.error(n,{icon:o.Icon.ERROR,title:"Deleção de itens do pedido.",actions:[sap.m.MessageBox.Action.OK]})}else{o.show("Deseja mesmo excluir o Item "+r+" ?",{icon:o.Icon.WARNING,title:"Exclusão de Pedidos",actions:[o.Action.YES,sap.m.MessageBox.Action.CANCEL],onClose:function(e){if(e==sap.m.MessageBox.Action.YES){t.byId("idItens").setBusy(true);new Promise(function(e,o){t.onDeletarItemPedido(e,o,a,r)}).then(function(e){new Promise(function(e,o){t.onBuscarItensPedido(e,o,a)}).then(function(e){t.vetorItensPedido=e;t.getModelGlobal("modelItensPedidoGrid").setData(t.vetorItensPedido);t.byId("idItens").setBusy(false);t.onInicializaCamposItens()}).catch(function(e){t.byId("idItens").setBusy(false);t.onMensagemErroODATA(e)})}).catch(function(e){t.byId("idItens").setBusy(false);t.onMensagemErroODATA(e)});t.oModel.remove("/P_ItensPedidoD(IvNrPedido='"+a+"',IvMatnr='"+r+"')",{success:function(e){t.oModel.read("/P_ItensPedidoQ",{urlParameters:{$filter:"IvNrPedido eq '"+a+"'"},success:function(e){},error:function(e){t.byId("table_pedidos").setBusy(false);t.onMensagemErroODATA(e)}})},error:function(e){console.log(e);t.onMensagemErroODATA(e)}})}}})}},onResetaTela:function(){var e=this;if(this.getModel("modelVar").getProperty("/Editar")=="true"){o.show("Deseja cancelar a Edição?",{icon:o.Icon.WARNING,title:"Edição de itens",actions:["Confirmar","Cancelar"],onClose:function(){e.getModel("modelVar").setProperty("/Editar",false);e.getView().byId("idBtnAdd").setText("Salvar");e.getView().byId("IdItemPedido").setEnabled(true);e.getView().byId("idPrecoVenda").setEnabled(true);e.getView().byId("idPromocao").setEnabled(true);e.getView().byId("idQuantidade").setEnabled(true);e.onInicializaCamposItens()}})}else{e.onInicializaCamposItens()}},onFocusQnt:function(){this.getView().byId("idPromocao").focus()},onFocusPromo:function(){this.getView().byId("idPrecoVenda").focus()}})});